<!DOCTYPE html>
<html lang="zh-CN">
<head>

  <script data-ad-client="ca-pub-8791711604224644" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-center-radar.min.css">
  <script src="/lib/pace/pace.min.js"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://theinfinitegame.tech').hostname,
    root: '/',
    scheme: 'Muse',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false,"b2t":true,"scrollpercent":true},
    copycode: {"enable":true,"show_result":true,"style":"flat"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="Stay hungry, stay foolish.">
<meta property="og:type" content="website">
<meta property="og:title" content="The Infinite Game">
<meta property="og:url" content="https://theinfinitegame.tech/index.html">
<meta property="og:site_name" content="The Infinite Game">
<meta property="og:description" content="Stay hungry, stay foolish.">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="猫克杯">
<meta property="article:tag" content="tech, life, philosophy">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://theinfinitegame.tech/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/ilyabirman-likely@2/release/likely.min.css">
  <title>The Infinite Game</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="The Infinite Game" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">The Infinite Game</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-top">

    <a href="/top/" rel="section"><i class="fa fa-fw fa-signal"></i>热门</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404.html" rel="section"><i class="fa fa-fw fa-heartbeat"></i>公益 404</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/nichollyn" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://theinfinitegame.tech/uncategorized/swift5-7-new-feature/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="猫克杯">
      <meta itemprop="description" content="Stay hungry, stay foolish.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Infinite Game">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/uncategorized/swift5-7-new-feature/" class="post-title-link" itemprop="url">swift5.7-new-feature</a>
        </h1>

        <div class="post-meta">

          
            <i class="fa fa-thumb-tack"></i>
            <font color="7D26CD">置顶</font>
            <span class="post-meta-divider">|</span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-06-09 10:18:27" itemprop="dateCreated datePublished" datetime="2022-06-09T10:18:27+08:00">2022-06-09</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>欢迎关注微信公众号「Swift 花园」</p>
<img src="/images/pauline-loroy-U3aF7hgUSrk-unsplash.jpg" width="100%" height="100%" style="margin: 10 auto;">

<blockquote>
<p>封面来自 <a target="_blank" rel="noopener" href="https://unsplash.com/@paulinel?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Pauline Loroy</a> on <a target="_blank" rel="noopener" href="https://unsplash.com/s/photos/dog?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></p>
</blockquote>
<blockquote>
<p>译自 <a target="_blank" rel="noopener" href="https://www.hackingwithswift.com/articles/249/whats-new-in-swift-5-7">https://www.hackingwithswift.com/articles/249/whats-new-in-swift-5-7</a></p>
</blockquote>
<p>Swift 5.7 变化巨大，新特性中包括正则表达式， <code>if let</code> 速记语法，以及围绕 <code>any</code> 和 <code>some</code> 关键字的一致性改动。</p>
<p>在本文中，我会通过一些示例来介绍这些新特性。</p>
<h3 id="解包可选型的-if-let-速记"><a href="#解包可选型的-if-let-速记" class="headerlink" title="解包可选型的 if let 速记"></a>解包可选型的 <code>if let</code> 速记</h3><p><a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/main/proposals/0345-if-let-shorthand.md">SE-0345</a> 引入了新的速记语法，可以将可选型展开为 ** 同名 ** 的阴影变量。以后我们可以像下面这样解包了：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name: <span class="type">String?</span> = <span class="string">"Linda"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> name {</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Hello, \(name)!"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>对比之前的写法：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> name = name {</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Hello, \(name)!"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> unwrappedName = name {</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Hello, \(unwrappedName)!"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>注意：这个变化并不适用于对象内的属性，所以像下面这样的代码无法通过编译：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">User</span> </span>{</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> user: <span class="type">User?</span> = <span class="type">User</span>(name: <span class="string">"Linda"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> user.name {</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Welcome, \(user.name)!"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="多语句闭包类型推断"><a href="#多语句闭包类型推断" class="headerlink" title="多语句闭包类型推断"></a>多语句闭包类型推断</h3><p><a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/main/proposals/0326-extending-multi-statement-closure-inference.md">SE-0326</a> 极大地提高了 Swift 对闭包使用参数和类型推断的能力，这意味着我们现在可以删除许多必须明确指定输入和输出类型的写法。</p>
<p>之前 Swift 处理闭包的书写难免琐碎，但从 Swift 5.7 开始，我们可以编写如下简化的代码：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> scores = [<span class="number">100</span>, <span class="number">80</span>, <span class="number">85</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> results = scores.<span class="built_in">map</span> { score <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> score &gt;= <span class="number">85</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"\(score)%: Pass"</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"\(score)%: Fail"</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>在 Swift 5.7 之前则必须像下面这样书写：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> oldResults = scores.<span class="built_in">map</span> { score -&gt; <span class="type">String</span> <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> score &gt;= <span class="number">85</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"\(score)%: Pass"</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"\(score)%: Fail"</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Clock，Instant-和-Duration"><a href="#Clock，Instant-和-Duration" class="headerlink" title="Clock，Instant 和 Duration"></a>Clock，Instant 和 Duration</h3><p><a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/main/proposals/0329-clock-instant-duration.md">SE-0329</a> 为 Swift 引入了一种新的标准化方式来引用时间和持续时间。它可以拆解为三个主要部分：</p>
<ul>
<li>  <code>Clock</code> 代表了一种测量时间流逝的方式。有两个内置时钟：连续时钟在系统处于睡眠状态时也会保持时间递增，而挂起时钟则不会。</li>
<li>  <code>Instant</code> 代表一个精确的瞬间。</li>
<li>  Durations 表示两个 <code>Instant</code> 之间经过了多少时间。</li>
</ul>
<p>这个新特性对许多人来说来联想到的最直接的应用就是新升级的 <code>Task</code> API：它现在可以用比纳秒更合理的术语来指定休眠时长：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> await <span class="type">Task</span>.sleep (until: .now +  .seconds (<span class="number">1</span>), clock: .continuous)</span><br></pre></td></tr></tbody></table></figure>
<p>这个新 API 还有一个好处是能够指定容差，使得系统在睡眠截止日期之后能够稍等片刻，以便最大限度地提高电源效率。所以，假如我们想 sleep 至少 1 秒，并且能接受它总共持续 1.5 秒，我们可以这样写：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> await <span class="type">Task</span>.sleep (until: .now + .seconds (<span class="number">1</span>), tolerance: .seconds (<span class="number">0.5</span>), clock: .continuous)</span><br></pre></td></tr></tbody></table></figure>
<p>时钟对于测量某些特定的工作也很有用。比如，我们想向用户展示文件导出过程花费了多长时间，可以使用时钟的</p>
<p><code>measure</code> 闭包：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> clock = <span class="type">ContinuousClock</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> time = clock.measure {</span><br><span class="line">    <span class="comment">//complex work here</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"Took \(time.components.seconds) seconds"</span>)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><p>Swift 5.7 引入了大量与正则表达式相关的改进，这是一整套相互关联的提案，包括：</p>
<ul>
<li>  <a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/main/proposals/0350-regex-type-overview.md">SE-0350</a> 引入了新的 <code>Regex</code> 类型</li>
<li>  <a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/main/proposals/0351-regex-builder.md">SE-0351</a> 引入了一个用于创建正则表达式的 result builder 驱动的 DSL。</li>
<li>  <a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/main/proposals/0354-regex-literals.md">SE-0354</a> 引入了使用 <code>/.../</code> 而不单是 <code>Regex</code> 来共同创建正则表达式的方式。</li>
<li>  <a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/main/proposals/0357-regex-string-processing-algorithms.md">SE-0357</a> 添加了许多新的基于正则表达式的字符串处理算法。</li>
</ul>
<p>与其他语言和平台相比，正则表达式一直是 Swift 语言一个相当大的痛点。</p>
<p>现在，让我们从简单的例子开始：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> message = <span class="string">"the cat sat on the mat"</span></span><br><span class="line"><span class="built_in">print</span>(message.ranges (of: <span class="string">"at"</span>))</span><br><span class="line"><span class="built_in">print</span>(message.replacing (<span class="string">"cat"</span>, with: <span class="string">"dog"</span>))</span><br><span class="line"><span class="built_in">print</span>(message.trimmingPrefix (<span class="string">"the "</span>))</span><br></pre></td></tr></tbody></table></figure>
<p>它们的真正威力在于也都接受正则表达式：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(message.ranges (of: /[a-z] at/))</span><br><span class="line"><span class="built_in">print</span>(message.replacing (/[a-m] at/, with: <span class="string">"dog"</span>))</span><br><span class="line"><span class="built_in">print</span>(message.trimmingPrefix (/<span class="type">The</span>/.ignoresCase ()))</span><br></pre></td></tr></tbody></table></figure>
<p>如果您不熟悉正则表达式，下面是几条快速入门：</p>
<ul>
<li>  在第一个正则表达式中，我们要求所有匹配任何小写字母后跟 “at” 的子字符串的范围，以便找到 “cat”、“sat” 和 “mat” 的位置。</li>
<li>  在第二个正则表达式中，我们只匹配从 “a” 到 “m” 的范围，所以 sat 不会被替换，它会打印 “the dog sat on the dog”。</li>
<li>  在第三个正则表达式中，我们寻找 “The”，但将正则表达式修改为不区分大小写，以便匹配 “the”、“THE” 等。</li>
</ul>
<p>注意这些正则表达式是如何使用正则表达式字面量来生成的 —— 以 <code>/</code> 开始和结束。</p>
<p>除了正则表达式字面量，Swift 还提供了专门的 <code>Regex</code> 类型：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> {</span><br><span class="line">    <span class="keyword">let</span> atSearch = <span class="keyword">try</span> <span class="type">Regex</span>(<span class="string">"[a-z] at"</span>)</span><br><span class="line">    <span class="built_in">print</span>(message.ranges (of: atSearch))</span><br><span class="line">} <span class="keyword">catch</span> {</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Failed to create regex"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这里两种方式有一个关键区别：当我们使用 <code>Regex</code> 从字符串创建正则表达式时，Swift 必须在运行时解析字符串以找出它应该使用的实际表达式。相比之下，使用正则表达式字面量允许 Swift <em>在编译时</em> 检查你的正则表达式：它可以验证正则表达式不包含错误，并且还可以准确了解它将包含什么匹配项。</p>
<blockquote>
<p>在编译时解析你的正则表达式，确保它们是有效的 —— 牛 🍺！</p>
</blockquote>
<p>想知道这个差异有多强大，咱们来看下面的代码：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> search1 = /<span class="type">My</span> name <span class="keyword">is</span> (.+?) and <span class="type">I'm</span> (\d+) years old./</span><br><span class="line"><span class="keyword">let</span> greeting1 = <span class="string">"My name is Taylor and I'm 26 years old."</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> result = <span class="keyword">try</span> search1.wholeMatch (<span class="keyword">in</span>: greeting1) {</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Name: \(result.1)"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Age: \(result.2)"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这会创建一个正则表达式来查找某些文本中的两个特定值，如果找到它们都会打印它们。但请注意 <code>result</code> 元组如何将其匹配项引用为 <code>.1</code> 和 <code>.2</code>，因为 Swift 知道将发生哪些匹配项。 （<code>.0</code> 将返回整个匹配的字符串。）</p>
<p>事实上，正则表达式还允许我们命名匹配项，这些匹配项会流向生成的匹配元组：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> search2 = /<span class="type">My</span> name <span class="keyword">is</span> (?&lt;name&gt;.+?) and <span class="type">I'm</span> (?&lt;age&gt;\d+) years old./</span><br><span class="line"><span class="keyword">let</span> greeting2 = <span class="string">"My name is Taylor and I'm 26 years old."</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> result = <span class="keyword">try</span> search2.wholeMatch (<span class="keyword">in</span>: greeting2) {</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Name: \(result.name)"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Age: \(result.age)"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这种安全性对于从字符串创建的正则表达式是不可能的。</p>
<p>但 Swift 更进一步，你还可以从类似于 SwiftUI 代码的 DSL 语言创建正则表达式。</p>
<p>例如，如果我们想匹配 “我的名字是 Taylor，我 26 岁” 的文本，我们可以写一个这样的正则表达式：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> search3 = <span class="type">Regex</span> {</span><br><span class="line">    <span class="string">"My name is "</span></span><br><span class="line"></span><br><span class="line">    <span class="type">Capture</span> {</span><br><span class="line">        <span class="type">OneOrMore</span>(.word)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="string">" and I'm "</span></span><br><span class="line"></span><br><span class="line">    <span class="type">Capture</span> {</span><br><span class="line">        <span class="type">OneOrMore</span>(.digit)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="string">" years old."</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>更棒的是，这种 DSL 方法能够对其找到的匹配项应用转换，如果我们使用 <code>TryCapture</code> 而不是 <code>Capture</code>，在捕获失败或有错误抛出时，Swift 将自动认为整个正则表达式不匹配。因此，在我们的年龄匹配的例子中，我们可以编写以下代码来将年龄字符串转换为整数：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> search4 = <span class="type">Regex</span> {</span><br><span class="line">    <span class="string">"My name is "</span></span><br><span class="line"></span><br><span class="line">    <span class="type">Capture</span> {</span><br><span class="line">        <span class="type">OneOrMore</span>(.word)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="string">" and I'm "</span></span><br><span class="line"></span><br><span class="line">    <span class="type">TryCapture</span> {</span><br><span class="line">        <span class="type">OneOrMore</span>(.digit)</span><br><span class="line">    } transform: { match <span class="keyword">in</span></span><br><span class="line">        <span class="type">Int</span>(match)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">Capture</span>(.digit)</span><br><span class="line"></span><br><span class="line">    <span class="string">" years old."</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>你甚至可以使用具有特定类型的变量将命名匹配组合在一起，如下所示：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> nameRef = <span class="type">Reference</span>(<span class="type">Substring</span>.<span class="keyword">self</span>)</span><br><span class="line"><span class="keyword">let</span> ageRef = <span class="type">Reference</span>(<span class="type">Int</span>.<span class="keyword">self</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> search5 = <span class="type">Regex</span> {</span><br><span class="line">    <span class="string">"My name is "</span></span><br><span class="line"></span><br><span class="line">    <span class="type">Capture</span>(<span class="keyword">as</span>: nameRef) {</span><br><span class="line">        <span class="type">OneOrMore</span>(.word)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="string">" and I'm "</span></span><br><span class="line"></span><br><span class="line">    <span class="type">TryCapture</span>(<span class="keyword">as</span>: ageRef) {</span><br><span class="line">        <span class="type">OneOrMore</span>(.digit)</span><br><span class="line">    } transform: { match <span class="keyword">in</span></span><br><span class="line">        <span class="type">Int</span>(match)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">Capture</span>(.digit)</span><br><span class="line"></span><br><span class="line">    <span class="string">" years old."</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> result = greeting.firstMatch (of: search5) {</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Name: \(result [nameRef])"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Age: \(result [ageRef])"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>在这三个选项中，我怀疑正则表达式文字会得到最广泛的使用。尽管在 Swift 6 发布之前，默认情况下对它们的支持将被禁用。你可以把 “-Xfrontend -enable-bare-slash-regex” 添加到 Xcode 中的 Swift Flags 设置以启用这个语法特性。</p>
<h3 id="基于默认表达式的类型推断"><a href="#基于默认表达式的类型推断" class="headerlink" title="基于默认表达式的类型推断"></a>基于默认表达式的类型推断</h3><p><a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/main/proposals/0347-type-inference-from-default-exprs.md">SE-0347</a> 扩展了 Swift 使用泛型参数类型的默认值的能力。这个特性似乎相当小众，但确实重要：如果你有一个泛型类型或函数，现在可以为默认表达式提供一个具体类型。</p>
<p>例如，我们可能有一个函数，它从任意类型的序列中返回 <code>count</code> 个随机项：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">drawLotto1</span>&lt;T: Sequence&gt;<span class="params">(from options: T, <span class="built_in">count</span>: Int = <span class="number">7</span>)</span></span> -&gt; [<span class="type">T</span>.<span class="type">Element</span>] {</span><br><span class="line">    <span class="type">Array</span>(options.shuffled ().<span class="keyword">prefix</span>(<span class="built_in">count</span>))</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这允许我们使用任何类型的序列来运行函数，例如字符串数组或者整数范围：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(drawLotto1 (from: <span class="number">1</span>...<span class="number">49</span>))</span><br><span class="line"><span class="built_in">print</span>(drawLotto1 (from: [<span class="string">"Jenny"</span>, <span class="string">"Trixie"</span>, <span class="string">"Cynthia"</span>], <span class="built_in">count</span>: <span class="number">2</span>))</span><br></pre></td></tr></tbody></table></figure>
<p>SE-0347 允许我们为函数中的 <code>T</code> 参数提供一个具体类型作为默认值，同时允许我们保持使用字符串数组或任何其他序列类型的灵活性：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">drawLotto2</span>&lt;T: Sequence&gt;<span class="params">(from options: T = <span class="number">1</span>...<span class="number">49</span>, <span class="built_in">count</span>: Int = <span class="number">7</span>)</span></span> -&gt; [<span class="type">T</span>.<span class="type">Element</span>] {</span><br><span class="line">    <span class="type">Array</span>(options.shuffled ().<span class="keyword">prefix</span>(<span class="built_in">count</span>))</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这样一来我们既可以使用自定义序列调用函数，也可以让默认值接管：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(drawLotto2 (from: [<span class="string">"Jenny"</span>, <span class="string">"Trixie"</span>, <span class="string">"Cynthia"</span>], <span class="built_in">count</span>: <span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(drawLotto2 ())</span><br></pre></td></tr></tbody></table></figure>
<h3 id="顶级代码的并发"><a href="#顶级代码的并发" class="headerlink" title="顶级代码的并发"></a>顶级代码的并发</h3><p><a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/main/proposals/0343-top-level-concurrency.md">SE-0343</a> 升级了 Swift 对顶级代码的支持 —— 想想 macOS 命令行工具项目中的 main.swift —— 以便它支持开箱即用的并发。这个变化看起来微不足道，但为了支持它需要相当多的工作。</p>
<p>实践上，这个变化意味着我们可以将这样的代码直接写入 main.swift 文件：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> url = <span class="type">URL</span>(string: <span class="string">"https://hws.dev/readings.json"</span>)!</span><br><span class="line"><span class="keyword">let</span> (data, <span class="keyword">_</span>) = <span class="keyword">try</span> await <span class="type">URLSession</span>.shared.data (from: url)</span><br><span class="line"><span class="keyword">let</span> readings = <span class="keyword">try</span> <span class="type">JSONDecoder</span>().decode ([<span class="type">Double</span>].<span class="keyword">self</span>, from: data)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"Found \(readings.count) temperature readings"</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>在这个变化以前，我们必须创建一个具有异步 <code>main ()</code> 方法的 <code>@main</code> 结构。因此说这个变化是一个不小的改进。</p>
<h3 id="不透明参数声明"><a href="#不透明参数声明" class="headerlink" title="不透明参数声明"></a>不透明参数声明</h3><p><a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/main/proposals/0341-opaque-parameters.md">SE-0341</a> 解锁了在使用更简单泛型的地方对参数声明使用 <code>some</code> 的能力。</p>
<p>举个例子，如果我们想编写一个检查数组是否排序的函数，Swift 5.7 及更高版本允许我们这样写：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isSorted</span><span class="params">(array: [<span class="keyword">some</span> Comparable])</span></span> -&gt; <span class="type">Bool</span> {</span><br><span class="line">    array == array.sorted ()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>[some Comparable]</code> 参数类型意味着此函数适用于包含某种类型的元素的数组，该类型遵循 <code>Comparable</code> 协议，这是等效通用代码的语法糖：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isSortedOld</span>&lt;T: Comparable&gt;<span class="params">(array: [T])</span></span> -&gt; <span class="type">Bool</span> {</span><br><span class="line">    array == array.sorted ()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>当然，我们也可以写更长的约束扩展：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Array</span> <span class="title">where</span> <span class="title">Element</span>: <span class="title">Comparable</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">isSorted</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> {</span><br><span class="line">        <span class="keyword">self</span> == <span class="keyword">self</span>.sorted ()</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这种简化的泛型语法确实意味着我们不再有能力为我们的类型添加更复杂的约束，因为合成的泛型参数没有特定的名称。</p>
<p>** 重要提示：** 你可以在显式泛型参数和这种新的更简单语法之间切换，而不会破坏 API。</p>
<h3 id="结构化的不透明结果类型"><a href="#结构化的不透明结果类型" class="headerlink" title="结构化的不透明结果类型"></a>结构化的不透明结果类型</h3><p><a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/main/proposals/0328-structural-opaque-result-types.md">SE-0328</a> 拓宽了不透明结果类型可以使用的范围。</p>
<p>例如，我们现在可以一次返回多个不透明类型：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">showUserDetails</span><span class="params">()</span></span> -&gt; (<span class="keyword">some</span> <span class="type">Equatable</span>, <span class="keyword">some</span> <span class="type">Equatable</span>) {</span><br><span class="line">    (<span class="type">Text</span>(<span class="string">"Username"</span>), <span class="type">Text</span>(<span class="string">"@twostraws"</span>))</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>我们还可以返回不透明类型数组：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createUser</span><span class="params">()</span></span> -&gt; [<span class="keyword">some</span> <span class="type">View</span>] {</span><br><span class="line">    <span class="keyword">let</span> usernames = [<span class="string">"@frankefoster"</span>, <span class="string">"@mikaela__caron"</span>, <span class="string">"@museumshuffle"</span>]</span><br><span class="line">    <span class="keyword">return</span> usernames.<span class="built_in">map</span>(<span class="type">Text</span>.<span class="keyword">init</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>甚至返回一个在调用时本身返回不透明类型的函数：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createDiceRoll</span><span class="params">()</span></span> -&gt; () -&gt; <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        <span class="keyword">let</span> diceRoll = <span class="type">Int</span>.random (<span class="keyword">in</span>: <span class="number">1</span>...<span class="number">6</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Text</span>(<span class="type">String</span>(diceRoll))</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>因此，这是 Swift 进化过程中保持一致性的另一个很好的例子。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://theinfinitegame.tech/development/eight-swiftui-misuses-and-correction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="猫克杯">
      <meta itemprop="description" content="Stay hungry, stay foolish.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Infinite Game">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/development/eight-swiftui-misuses-and-correction/" class="post-title-link" itemprop="url">八个常见的 SwiftUI 误用及对应的正确打开方式</a>
        </h1>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-11 20:49:56" itemprop="dateCreated datePublished" datetime="2021-01-11T20:49:56+08:00">2021-01-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/development/" itemprop="url" rel="index">
                    <span itemprop="name">development</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>7.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gmk1u8ramjj31900u0b2e.jpg" alt="zdenek-machacek-pqYGHW0_od0-unsplash"></p>
<blockquote>
<p>译自 <a target="_blank" rel="noopener" href="https://www.hackingwithswift.com/articles/224/common-swiftui-mistakes-and-how-to-fix-them">https://www.hackingwithswift.com/articles/224/common-swiftui-mistakes-and-how-to-fix-them</a></p>
</blockquote>
<p><strong> 欢迎关注微信公众号「Swift 花园」</strong></p>
<p>SwiftUI 是一个庞大且复杂的框架。使用这个框架编程无疑是享受的，但犯错的机会也不少见。这篇文章我将带大家速览 SwiftUI 初学者常犯的一些错误，并提供修正方案。</p>
<p>其中的一些错误是由于简单的误解导致。由于 SwiftUI 太大，这种情况其实容易出现。而另一些错误则与深入理解 SwiftUI 的工作方式有关，还有一些是原有的思维方式导致 —— 你可能花了很多时间编写 view 和 modifier，但没有想到用 SwiftUI 的方式简化结果。</p>
<p>开门见山，你不需要猜我会给你准备什么菜，这里我直接把八条误用先简明扼要地罗列如下，然后我们逐条深入展开：</p>
<ol>
<li><p>添加不必要的 View 和 Modifier</p>
</li>
<li><p>在需要用 <code>@StateObject</code> 的地方用了 <code>@ObservedObject</code></p>
</li>
<li><p>Modifier 顺序错误</p>
</li>
<li><p>给属性包装器添加属性观察者</p>
</li>
<li><p>在需要用描边框的地方使用了描形状</p>
</li>
<li><p>Alert 和 Sheet 与可选状态的使用</p>
</li>
<li><p>尝试改变 SwiftUI 视图后面的东西</p>
</li>
<li><p>用错误的范围动态创建视图</p>
</li>
</ol>
<hr>
<h3 id="1-添加不必要的-View-和-Modifier"><a href="#1-添加不必要的-View-和-Modifier" class="headerlink" title="1 添加不必要的 View 和 Modifier"></a>1 添加不必要的 View 和 Modifier</h3><p>让我们从最常见的一个误用开始，它会让我们编写更多的 SwiftUI 代码。这种误用的部分原因通常是我们在解决问题时编写了许多代码，但是最后忘记整理代码。还有的时候，则是旧习惯作祟，尤其是当编写者是从 UIKit 或者其他 UI 框架转到 SwiftUI 上。</p>
<p>比如，你可能希望用一个红色矩形填满屏幕？然后你像下面这样编写代码：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Rectangle</span>()</span><br><span class="line">    .fill (<span class="type">Color</span>.red)</span><br></pre></td></tr></tbody></table></figure>
<p>的确，上面的代码可以工作 —— 它能准确地得到你想要的效果。但是其中一半的代码是不必要的，因为你只需要像下面这样写也能实现一样的效果：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Color</span>.red</span><br></pre></td></tr></tbody></table></figure>
<p>这是因为在 SwiftUI 中，所有的颜色和形状都自动遵循了 View 协议，你可以把它们直接当成视图来使用。</p>
<p>你可能也会经常看见形状裁切，因为为了实现特定形状，应用 <code>clipShape ()</code> 是件很自然的事情。例如，可以像下面这样让我们的红色矩形拥有圆角：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Color</span>.red</span><br><span class="line">    .clipShape (<span class="type">RoundedRectangle</span>(cornerRadius: <span class="number">50</span>))</span><br></pre></td></tr></tbody></table></figure>
<p>但这也是不要的 —— 借助 <code>cornerRadius ()</code> modifier，代码可以简化如下：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Color</span>.red</span><br><span class="line">    .cornerRadius (<span class="number">50</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>移除这类的冗余代码需要时间，因为你需要转变思维习惯，这一点对于 SwiftUI 的初学者来说更加困难。 因此，假如你一开始采用了这些更长版本的代码，不必担忧，多加训练。</p>
<h3 id="2-在需要用-StateObject-的地方用了-ObservedObject"><a href="#2-在需要用-StateObject-的地方用了-ObservedObject" class="headerlink" title="2 在需要用 @StateObject 的地方用了 @ObservedObject"></a>2 在需要用 <code>@StateObject</code> 的地方用了 <code>@ObservedObject</code></h3><p>SwiftUI 提供了众多属性包装器，帮助我们构建数据响应式的用户界面，其中最重要的当属 <code>@State</code>， <code>@StateObject</code> 和 <code>@ObservedObject</code>。掌握它们的使用场景非常重要，因为误用它们会给你的代码带来各种问题。</p>
<p>第一个比较直接：<code>@State</code> 用于值类型属性，并且属性由当前视图拥有。因此，整数，字符串，数组等，都是应用 <code>@State</code> 的绝佳场景。</p>
<p>后两者则有点令人困惑，你可能会经常看到下面这样的代码：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataModel</span>: <span class="title">ObservableObject</span> </span>{</span><br><span class="line">    @<span class="type">Published</span> <span class="keyword">var</span> username = <span class="string">"@twostraws"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ContentView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    @<span class="type">ObservedObject</span> <span class="keyword">var</span> model = <span class="type">DataModel</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">Text</span>(model.username)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>可以明确的说，这么做是错误的，并且极有可能在你的应用中带来问题。</p>
<blockquote>
<p>译者注：基于代码片段说这样写一定是错误的，这个表述是不严谨的。作者应该是隐含假设了 <code>ContentView</code> 是应用的顶级视图（通常来说，如果你不改工程模板的默认输出，<code>ContentView</code> 也确实是顶级视图）。对于顶级视图来说，SwiftUI 2.0 应当使用 <code>@StateObject</code> ，它是为了解决 <code>@ObservedObject</code> 或者 <code>@EnvironmentObject</code> 对象的所有权问题。但是对于附属于顶级视图的视图层级，各子视图的数据源可以是 <code>@ObservedObject</code> 或者 <code>@EnvironmentObject</code>，因为它们的生命周期受顶级视图管理，进而可以由顶级视图统一保证数据的可用性。</p>
</blockquote>
<p>正如我前面说到的，<code>@State</code> 表示某个值类型属性由当前视图拥有，这里的 “拥有” 很重要。而 <code>@StateObject</code> 则相当于引用类型版本的 <code>@State</code>。</p>
<p>因此，上面的代码应该改成这样：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="type">StateObject</span> model = <span class="type">DataModel</span>()</span><br></pre></td></tr></tbody></table></figure>
<p>当你使用 <code>@ObservedObject</code> 来创建某个对象实例时，你的视图并不拥有这个对象实例，也就是说，这个实例可以在任何时候被销毁（译者注：视图无法了解也无法干预这个时机）。狡猾的是，对象在视图还需要用它时被销毁的情况只是偶尔发生，所以你可能认为你的代码很完美。</p>
<p>需要记住的重点是 <code>@State</code> 和 <code>@StateObject</code> 表示 “视图拥有数据”，而 <code>@ObservedObject</code> 和 <code>@EnvironmentObject</code> 则没有。</p>
<h3 id="3-Modifier-顺序错误"><a href="#3-Modifier-顺序错误" class="headerlink" title="3 Modifier 顺序错误"></a>3 Modifier 顺序错误</h3><p>Modifier 的顺序在 SwiftUI 中至关重要。顺序错误不仅会导致布局在上视觉上的偏差，也会导致其行为的错误。</p>
<p>解释这个问题最经典的例子是 <code>padding</code> 和 <code>background</code> 的使用，如下：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Text</span>(<span class="string">"Hello, World!"</span>)</span><br><span class="line">    .font (.largeTitle)</span><br><span class="line">    .background (<span class="type">Color</span>.green)</span><br><span class="line">    .padding ()</span><br></pre></td></tr></tbody></table></figure>
<p>由于我们在 <code>background</code> 颜色之后应用 <code>padding</code>，颜色只会被直接应用在文本周围，而不是被添加留白之后的文本周围。如果你希望留白和文本背景都是绿色，应该将代码改成下面这样：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Text</span>(<span class="string">"Hello, World!"</span>)</span><br><span class="line">    .font (.largeTitle)</span><br><span class="line">    .padding ()</span><br><span class="line">    .background (<span class="type">Color</span>.green)</span><br></pre></td></tr></tbody></table></figure>
<p>当你尝试调整视图位置时，这个原理会让事情变得更有趣。</p>
<p>例如，<code>offset ()</code> modifier 会修改一个视图被渲染的位置，但并不实际改变视图的位置。也就是说，应用在 <code>offset</code> 之后的 modifier 表现得就像 <code>offset</code> 从未发生过。</p>
<p>尝试下面的代码：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Text</span>(<span class="string">"Hello, World!"</span>)</span><br><span class="line">    .font (.largeTitle)</span><br><span class="line">    .offset (x: <span class="number">15</span>, y: <span class="number">15</span>)</span><br><span class="line">    .background (<span class="type">Color</span>.green)</span><br></pre></td></tr></tbody></table></figure>
<p>你会发现文本偏移了，但背景颜色没有偏移。现在，尝试交换 <code>offset ()</code> 和 <code>background ()</code> 的位置：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Text</span>(<span class="string">"Hello, World!"</span>)</span><br><span class="line">    .font (.largeTitle)</span><br><span class="line">    .background (<span class="type">Color</span>.green)</span><br><span class="line">    .offset (x: <span class="number">15</span>, y: <span class="number">15</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>现在你会看到文本和背景都移动了。</p>
<p>另外，<code>position ()</code> modifier 会改变一个视图在其父节点中的渲染位置，但这一点是借助它先在视图周围应用一个可伸展尺寸的 frame 来实现的。</p>
<p>尝试下面的代码：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Text</span>(<span class="string">"Hello, World!"</span>)</span><br><span class="line">    .font (.largeTitle)</span><br><span class="line">    .background (<span class="type">Color</span>.green)</span><br><span class="line">    .position (x: <span class="number">150</span>, y: <span class="number">150</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>你会发现背景颜色紧贴在文本四周，并且整个视图被放置在左上角。现在，尝试对调 <code>background ()</code> 和 <code>position ()</code>：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Text</span>(<span class="string">"Hello, World!"</span>)</span><br><span class="line">    .font (.largeTitle)</span><br><span class="line">    .position (x: <span class="number">150</span>, y: <span class="number">150</span>)</span><br><span class="line">    .background (<span class="type">Color</span>.green)</span><br></pre></td></tr></tbody></table></figure>
<p>这一回你会发现整个屏幕都变成绿色了。还是因为 <code>position ()</code> 要求 SwiftUI 放置一个可伸缩尺寸的 frame 在文本视图周围，这导致视图自动占满了所有的可用空间。然后我们给视图上了绿色，所以整个屏幕呈现绿色。</p>
<p>你所应有的绝大多数 modifier 都创建了新视图 —— 应用一个 <code>position</code> 或者 <code>background</code> 时，你实际上是在将现有的视图包装起来。这个机制对于我们大有用处，我们可以多次应用 modifier，比如添加多层留白和背景：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Text</span>(<span class="string">"Hello, World!"</span>)</span><br><span class="line">    .font (.largeTitle)</span><br><span class="line">    .padding ()</span><br><span class="line">    .background (<span class="type">Color</span>.green)</span><br><span class="line">    .padding ()</span><br><span class="line">    .background (<span class="type">Color</span>.blue)</span><br></pre></td></tr></tbody></table></figure>
<p>或者应用多个 shadows 以创建很深的阴影效果：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Text</span>(<span class="string">"Hello, World!"</span>)</span><br><span class="line">    .font (.largeTitle)</span><br><span class="line">    .foregroundColor (.white)</span><br><span class="line">    .shadow (color: .black, radius: <span class="number">10</span>)</span><br><span class="line">    .shadow (color: .black, radius: <span class="number">10</span>)</span><br><span class="line">    .shadow (color: .black, radius: <span class="number">10</span>)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="4-给属性包装器添加属性观察者"><a href="#4-给属性包装器添加属性观察者" class="headerlink" title="4 给属性包装器添加属性观察者"></a>4 给属性包装器添加属性观察者</h3><p>某些情况下你可能会为属性包装器添加诸如 <code>didSet</code> 这样的属性观察者，但它不会如你预期的那样工作。</p>
<p>例如，如果你在使用滑块，希望在滑块值改变时执行某种动作，你可能会下面这样编写代码：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ContentView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    @<span class="type">State</span> <span class="keyword">private</span> <span class="keyword">var</span> rating = <span class="number">0.0</span> {</span><br><span class="line">        <span class="keyword">didSet</span> {</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Rating changed to \(rating)"</span>)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">Slider</span>(value: $rating)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>但是，这个 <code>didSet</code> 属性观察者永远都不会被调用，因为属性的值是由绑定直接修改的，而不是每次创建一个新值。</p>
<p>对此，SwiftUI 原生的方式是使用 <code>onChange ()</code> modifier，如下：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ContentView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    @<span class="type">State</span> <span class="keyword">private</span> <span class="keyword">var</span> rating = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">Slider</span>(value: $rating)</span><br><span class="line">            .onChange (of: rating) { value <span class="keyword">in</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"Rating changed to \(value)"</span>)</span><br><span class="line">            }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>不过，我个人更喜欢一种不同的方案：我使用基于 Binding 的扩展来返回新的绑定，其中的 <code>get</code> 和 <code>set</code> 包装的值和之前一样，但是在新值得到时也会调用处理函数：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Binding</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">onChange</span><span class="params">(<span class="keyword">_</span> handler: @escaping <span class="params">(Value)</span></span></span> -&gt; <span class="type">Void</span>) -&gt; <span class="type">Binding</span>&lt;<span class="type">Value</span>&gt; {</span><br><span class="line">        <span class="type">Binding</span>(</span><br><span class="line">            <span class="keyword">get</span>: { <span class="keyword">self</span>.wrappedValue },</span><br><span class="line">            <span class="keyword">set</span>: { newValue <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">self</span>.wrappedValue = newValue</span><br><span class="line">                handler (newValue)</span><br><span class="line">            }</span><br><span class="line">        )</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>有了这个扩展，我们就可以把绑定的动作直接附着在滑块视图上：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ContentView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    @<span class="type">State</span> <span class="keyword">private</span> <span class="keyword">var</span> rating = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">Slider</span>(value: $rating.onChange (sliderChanged))</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">sliderChanged</span><span class="params">(<span class="keyword">_</span> value: Double)</span></span> {</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Rating changed to \(value)"</span>)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>挑选最适合你的方案。</p>
<h3 id="5-在需要用描边框的地方使用了描形状"><a href="#5-在需要用描边框的地方使用了描形状" class="headerlink" title="5 在需要用描边框的地方使用了描形状"></a>5 在需要用描边框的地方使用了描形状</h3><p>不理解 <code>stroke ()</code> 和 <code>strokeBorder</code> 的区别是初学者常犯的错误。尝试下面的代码：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Circle</span>()</span><br><span class="line">    .stroke (<span class="type">Color</span>.red, lineWidth: <span class="number">20</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>注意看，你会发现圆的左边缘和右边缘怎么不见了？（译者：这里预设你是竖屏运行程序，高度大于宽高）这是因为 <code>stroke ()</code> modifier 会把描边居中对齐在形状的轮廓线上，所以一个 20 个点的红色描边会绘制 10 个点到形状的边缘线外部，10 个点在边缘线内部 —— 这就导致了你看到圆形的左右超出屏幕的现象。</p>
<p>作为对照，<code>strokeBorder ()</code> 则是把整个描边都绘制在形状内部，所以它不会放大形状的边框。</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Circle</span>()</span><br><span class="line">    .strokeBorder (<span class="type">Color</span>.red, lineWidth: <span class="number">20</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>相比于使用 <code>strokeBorder ()</code>，使用 <code>stroke ()</code> 有一个好处是它返回的是一个新形状，而不是一个新视图。这使得你可以创建出某些本来难以实现的效果，比如给一个形状描两次边：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Circle</span>()</span><br><span class="line">    .stroke (style: <span class="type">StrokeStyle</span>(lineWidth: <span class="number">20</span>, dash: [<span class="number">10</span>]))</span><br><span class="line">    .stroke (style: <span class="type">StrokeStyle</span>(lineWidth: <span class="number">20</span>, dash: [<span class="number">10</span>]))</span><br><span class="line">    .frame (width: <span class="number">280</span>, height: <span class="number">280</span>)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="6-Alert-和-Sheet-与可选状态的使用"><a href="#6-Alert-和-Sheet-与可选状态的使用" class="headerlink" title="6 Alert 和 Sheet 与可选状态的使用"></a>6 Alert 和 Sheet 与可选状态的使用</h3><p>当你在学习使用 sheet 和可选型的时候，很容易想到把 sheet 的展示绑定到像下面这样的 Boolean：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">User</span>: <span class="title">Identifiable</span> </span>{</span><br><span class="line">    <span class="keyword">let</span> id: <span class="type">String</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ContentView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    @<span class="type">State</span> <span class="keyword">private</span> <span class="keyword">var</span> selectedUser: <span class="type">User?</span></span><br><span class="line">    @<span class="type">State</span> <span class="keyword">private</span> <span class="keyword">var</span> showingAlert = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">VStack</span> {</span><br><span class="line">            <span class="type">Button</span>(<span class="string">"Show Alert"</span>) {</span><br><span class="line">                selectedUser = <span class="type">User</span>(id: <span class="string">"@twostraws"</span>)</span><br><span class="line">                showingAlert = <span class="literal">true</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        .alert (isPresented: $showingAlert) {</span><br><span class="line">            <span class="type">Alert</span>(title: <span class="type">Text</span>(<span class="string">"Hello, \(selectedUser!.id)"</span>))</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>当然，这可以正确工作 —— 而且这个方案容易理解。但是一旦你越过了初级阶段，你就应当考虑换成可选型的实现方案。这个方案去掉了 Boolean，也不必强制解包。唯一的要求是你所监听的目标需要遵循 <code>Identifiable</code>。</p>
<p>举个例子，我们可以在 <code>selectedUser</code> 发生变化的任何时候展示警告弹窗，就像下面这样：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ContentView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    @<span class="type">State</span> <span class="keyword">private</span> <span class="keyword">var</span> selectedUser: <span class="type">User?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">VStack</span> {</span><br><span class="line">            <span class="type">Button</span>(<span class="string">"Show Alert"</span>) {</span><br><span class="line">                selectedUser = <span class="type">User</span>(id: <span class="string">"@twostraws"</span>)</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        .alert (item: $selectedUser) { user <span class="keyword">in</span></span><br><span class="line">            <span class="type">Alert</span>(title: <span class="type">Text</span>(<span class="string">"Hello, \(user.id)"</span>))</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这会使得你的代码更加易于读写，并且避免因为强制解包可能带来的麻烦。</p>
<h3 id="7-尝试改变-SwiftUI-视图后面的东西"><a href="#7-尝试改变-SwiftUI-视图后面的东西" class="headerlink" title="7 尝试改变 SwiftUI 视图后面的东西"></a>7 尝试改变 SwiftUI 视图后面的东西</h3><p>SwiftUI 初学者最常犯的一个错误是他们常常试图去改变 SwiftUI 视图的背景。代码通常长下面这个样子：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ContentView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">Text</span>(<span class="string">"Hello, World!"</span>)</span><br><span class="line">            .background (<span class="type">Color</span>.red)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这会展示一个白色的屏幕，中间是红色背景色只匹配文本区域的文本视图。而大多数人的本意其实是想让整个屏幕的背景呈现出红色。这个时候他们会想，SwiftUI 背后究竟是什么样的 UIKit 视图呢？</p>
<p>当然，背后肯定是有一个 UIKit 视图，它由 <code>UIHostingController</code> 管理，角色类似于一个 UIKit 视图控制器。但是假如你通过 SwiftUI 试图去踏足 UIKit 的领地，你的改动很可能会让 SwiftUI 呈现出奇怪的结果，或者你甚至都没法直接改动 UIKit。</p>
<p>实际上，想到达成大多数人想要的效果，SwiftUI 里的实现方式应该是像下面这样的：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Text</span>(<span class="string">"Hello, World!"</span>)</span><br><span class="line">    .frame (maxWidth: .infinity, maxHeight: .infinity)</span><br><span class="line">    .background (<span class="type">Color</span>.red)</span><br><span class="line">    .ignoresSafeArea ()</span><br></pre></td></tr></tbody></table></figure>
<h3 id="8-动态视图的范围参数错误"><a href="#8-动态视图的范围参数错误" class="headerlink" title="8 动态视图的范围参数错误"></a>8 动态视图的范围参数错误</h3><p>有多个 SwiftUI 视图的构造器允许我们传入范围，这个事实让许多复杂视图的创建过程变得十分简单。</p>
<p>例如，假设我们想要展示一个拥有 4 个项目的列表，我们只需要这样写：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ContentView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    @<span class="type">State</span> <span class="keyword">private</span> <span class="keyword">var</span> rowCount = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">VStack</span> {</span><br><span class="line">            <span class="type">List</span>(<span class="number">0</span>..&lt;rowCount) { row <span class="keyword">in</span></span><br><span class="line">                <span class="type">Text</span>(<span class="string">"Row \(row)"</span>)</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这样写本身没问题，不过一旦你需要在运行时改变范围时，问题就来了。你看我已经用 <code>@State</code> 属性包装器把想要改变的行数变成可修改的，所以我们可以用一个按钮来修改它的值：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Button</span>(<span class="string">"Add Row"</span>) {</span><br><span class="line">    rowCount += <span class="number">1</span></span><br><span class="line">}</span><br><span class="line">.padding (.top)</span><br></pre></td></tr></tbody></table></figure>
<p>运行代码，点击按钮，Xcode 调试输出会输出警告，而列表视图纹丝不动 —— 这个方案不管用。</p>
<p>问题出在你既没有为列表的参数提供 <code>Identifiable</code> 协议实现，也没有提供指定的 id 参数，以此告诉 SwiftUI 这个范围会动态变化：（译者：实际上并不是 “告诉 SwiftUI 范围会动态变化”，而是明确范围的项怎样才算变化。<code>Identifiable</code> 或者 id 参数明确了两个项之间是如何区别。能够区别开的项目才能侦测变化）。</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">List</span>(<span class="number">0</span>..&lt;rowCount, id: \.<span class="keyword">self</span>) { row <span class="keyword">in</span></span><br><span class="line">    <span class="type">Text</span>(<span class="string">"Row \(row)"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>代码改成这样就没问题了。</p>
<hr>
<p>封面来自 <a target="_blank" rel="noopener" href="https://unsplash.com/@zmachacek?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Zdeněk Macháček</a> on <a target="_blank" rel="noopener" href="https://unsplash.com/s/photos/owl?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://theinfinitegame.tech/programming/use-nsuseractivity-in-swiftui/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="猫克杯">
      <meta itemprop="description" content="Stay hungry, stay foolish.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Infinite Game">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/programming/use-nsuseractivity-in-swiftui/" class="post-title-link" itemprop="url">在 SwiftUI 中使用 NSUserActivity</a>
        </h1>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-20 11:04:55" itemprop="dateCreated datePublished" datetime="2020-12-20T11:04:55+08:00">2020-12-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index">
                    <span itemprop="name">programming</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>12 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1glu3tdup4dj318y0u0he0.jpg" alt="chewy-EV9_vVMZTcg-unsplash"></p>
<p>欢迎关注微信公众号「Swift 花园」</p>
<blockquote>
<p>译自 <a target="_blank" rel="noopener" href="https://swiftui-lab.com/nsuseractivity-with-swiftui/">https://swiftui-lab.com/nsuseractivity-with-swiftui/</a></p>
<p>译者注：作者为了扩展他的 SwiftUI 应用去研究了 NSUserActivity，发现关于 NSUserActivity 的大量信息都已经过时了。比如，绝大多数关于 Handoff 的文章都是 Handoff 特性刚有的时候发布的，而那个时候还没有 scene 的概念，所有逻辑都是通过 application 的 delegate 处理的。之后 scene 出现了，许多代码被移到了 scene delegate，原来的 Handoff 示例也就失效了。如果你是刚开始学习 NSUserActivity，一定会感到困惑，而现在 SwiftUI 也支持用户活动，但现在又没有 scene 了，变化更大，所以作者认为需要写一篇新的文档来介绍 SwiftUI 中 NSUserActivity 的使用。</p>
</blockquote>
<p>NSUserActivity 令人费解的另一个原因是它是一个可以用来处理多个不相干功能的东西。它的各项属性只在某些情况下相关，多数情况下却是没有关联的。</p>
<p>下面是有关 NSUserActivity 的一些总结：</p>
<ul>
<li><strong>Universal Links</strong>: Universal links 是可以在关联应用或者 Safari 中打开的 URL。</li>
<li><strong>SiriKit</strong>: Siri 可以调起你的应用并且告知你它想要做什么。</li>
<li><strong>Spotlight</strong>: 定义你的应用可以做的动作，这些动作会被引入 Spotlight 的搜索结果中。</li>
<li><strong>Handoff</strong>: 即 “接力”，指一个应用可以继续另一个应用的工作，或者一台设备上的相同应用可以继续另一个设备上的应用的工作。</li>
</ul>
<p>这篇文档会提供一系列示例，逐步介绍 SwiftUI 中提供的用于处理 NSUserActivity 的方法，其中上面提到的每一种情况都会有示例。</p>
<h3 id="重要的笔记"><a href="#重要的笔记" class="headerlink" title="重要的笔记"></a>重要的笔记</h3><p>SwiftUI 中跟 NSUserActivity 有关的方法包括：<strong>onOpenURL ()</strong>, <strong>userActivity ()</strong>, <strong>onContinueUserActivity ()</strong> 和 <strong>handlesExternalEvents ()</strong>。注意，这些方法只有当你的应用采用的是 SwiftUI 应用生命周期时才能工作。如果你的项目还是使用 scene delegate，引入这几个方法会在控制台输出下面的消息：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Cannot use Scene methods for URL, NSUserActivity, and other External Events </span><br><span class="line">without using SwiftUI Lifecycle. Without SwiftUI Lifecycle, </span><br><span class="line">advertising and handling External Events wastes resources, and will have unpredictable results.</span><br></pre></td></tr></tbody></table></figure>
<p>个人经验，上面的消息中提到的不可预测的结果，实际上完全可以预测：所有这些方法都将被忽略。</p>
<h3 id="User-Activity-的两面"><a href="#User-Activity-的两面" class="headerlink" title="User Activity 的两面"></a>User Activity 的两面</h3><p>根据 Apple 的 <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/foundation/nsuseractivity">官方文档</a>，一个用户活动（user activity）对象代表了某个应用在某个时刻的状态：</p>
<blockquote>
<p>An <strong>NSUserActivity</strong> object provides a lightweight way to capture the state of your app and put it to use later. You create user activity objects and use them to capture information about what the user was doing, such as viewing app content, editing a document, viewing a web page, or watching a video. When the system launches your app and an activity object is available, your app can use the information in that object to restore itself to an appropriate state.</p>
<p>某个 <strong>NSUserActivity</strong> 对象提供一种捕捉你的应用状态的轻量级方式。你创建 user activity 对象，并用它们来捕获用户正在做的事情的信息，比如查看应用内容，编辑文档，阅览网页，或者观看视频。当系统启动你的应用时，如果活动对象可用，你的应用可以利用对象中的信息把应用还原成合适的状态。</p>
</blockquote>
<p>理解了概念，我们就可以区分用户活动中的两个关键时刻：其一，用户活动创建（稍后说明何时、如何创建）；其二，系统决定启动或者恢复某个应用，并且为应用提供一个 NSUserActivity，以便应用展示相关的 UI。我们接下来会学习如何在应用中对用户活动做出反应。</p>
<p>注意，尽管一个应用可以有多个 scene，但某个时刻只有一个 scene 会获得用户活动。在本文中我们还将了解到获取用户活动的 scene 是如何被确定的…</p>
<hr>
<h3 id="Universal-Links"><a href="#Universal-Links" class="headerlink" title="Universal Links"></a>Universal Links</h3><h5 id="介绍-onOpenURL"><a href="#介绍-onOpenURL" class="headerlink" title="介绍 onOpenURL ()"></a>介绍 onOpenURL ()</h5><p>Universal Links 对于把应用集成到网站十分有用。建立 Universal Links 需要几个步骤，Apple 为其提供了详细的文档：<a target="_blank" rel="noopener" href="https://developer.apple.com/ios/universal-links/">Universal Links</a>。</p>
<p>在 SwiftUI 中使用 <strong>NSUserActivity</strong> 的所有用法中，Universal Links 是最容易实现的。尽管 Universal Links 本质上是使用 NSUserActivity 来启动或者恢复你的应用，但假如你的应用是走 SwiftUI 应用生命周期，你却根本看不到 NSUserActivity 的踪影！</p>
<p>在 UIKit 里实现 Universal Links ，一般是在 scene delegate 里这么做：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">scene</span><span class="params">(<span class="keyword">_</span> scene: UIScene, <span class="keyword">continue</span> userActivity: NSUserActivity)</span></span> {</span><br><span class="line">    <span class="keyword">if</span> userActivity.activityType == <span class="type">NSUserActivityTypeBrowsingWeb</span>  {</span><br><span class="line">        doSomethingWith (url: userActivity.webpageURL)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>但现在没有了 scene delegate，我们只需要简单地使用 <code>onOpenURL</code> 方法，它会得到 <code>URL</code> 对象，而不是 NSUserActivity 对象：</p>
<h2 id=""><a href="#" class="headerlink" title=""></a><figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ContentView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">SomeView</span>()</span><br><span class="line">            .onOpenURL { url <span class="keyword">in</span></span><br><span class="line">                doSomethingWith (url: url)</span><br><span class="line">            }</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">doSomethingWith</span><span class="params">(url: URL?)</span></span> {</span><br><span class="line">        ...</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></h2><h3 id="SiriKit"><a href="#SiriKit" class="headerlink" title="SiriKit"></a>SiriKit</h3><h5 id="介绍-onContinueUserActivity"><a href="#介绍-onContinueUserActivity" class="headerlink" title="介绍 onContinueUserActivity ()"></a>介绍 onContinueUserActivity ()</h5><p>我们可以给一个应用中的特定部分定义快捷指令。在 iOS 中，这个动作可以借助 “快捷指令” 应用来实现，但我们也可以在应用内通过代码实现。UIKit 有一些专门的 UI 元素来处理这件事，但 SwiftUI 中并没有直接可用的方法，所以这一节中的例子会包含一个 UIViewControllerRepresentable，它的作用是提供一个按钮，点击这个按钮可以打开系统的模态表单，让用户创建或者编辑快捷指令。</p>
<p>一旦快捷指令创建，我们就可以调用 Siri 指令来执行它。它会启动或者恢复我们的应用，并且通过 NSUserActivity 提供用户希望我们执行的快捷指令的细节信息。SwiftUI 对此为我们提供了一个 <strong>onContinueUserActivity ()</strong></p>
<p>在下面的例子中，通过指令 “Hey Siri, show random animal” （或者某些其它的预置指令），系统会启动我们的应用并导航到某个随机的动物视图。</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> SwiftUI</span><br><span class="line"><span class="keyword">import</span> Intents</span><br><span class="line"></span><br><span class="line"><span class="comment">// 要记得把下面的声明添加到 Info.plist 文件的 NSUserActivityTypes 数组中 </span></span><br><span class="line"><span class="keyword">let</span> aType = <span class="string">"com.example.show-animal"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Animal</span>: <span class="title">Identifiable</span> </span>{</span><br><span class="line">    <span class="keyword">let</span> id: <span class="type">Int</span></span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> image: <span class="type">String</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> animals = [<span class="type">Animal</span>(id: <span class="number">1</span>, name: <span class="string">"Lion"</span>, image: <span class="string">"lion"</span>),</span><br><span class="line">               <span class="type">Animal</span>(id: <span class="number">2</span>, name: <span class="string">"Fox"</span>, image: <span class="string">"fox"</span>),</span><br><span class="line">               <span class="type">Animal</span>(id: <span class="number">3</span>, name: <span class="string">"Panda"</span>, image: <span class="string">"panda-bear"</span>),</span><br><span class="line">               <span class="type">Animal</span>(id: <span class="number">4</span>, name: <span class="string">"Elephant"</span>, image: <span class="string">"elephant"</span>)]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ContentView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    @<span class="type">State</span> <span class="keyword">private</span> <span class="keyword">var</span> selection: <span class="type">Int?</span> = <span class="literal">nil</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">NavigationView</span> {</span><br><span class="line">            <span class="type">List</span>(animals) { animal <span class="keyword">in</span></span><br><span class="line">                <span class="type">NavigationLink</span>(</span><br><span class="line">                    destination: <span class="type">AnimalDetail</span>(animal: animal),</span><br><span class="line">                    tag: animal.id,</span><br><span class="line">                    selection: $selection,</span><br><span class="line">                    label: { <span class="type">AnimalRow</span>(animal: animal) })</span><br><span class="line">            }</span><br><span class="line">            .navigationTitle (<span class="string">"Animal Gallery"</span>)</span><br><span class="line">            .onContinueUserActivity (aType, perform: { userActivity <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">self</span>.selection = <span class="type">Int</span>.random (<span class="keyword">in</span>: <span class="number">0</span>...(animals.<span class="built_in">count</span> - <span class="number">1</span>))</span><br><span class="line">            })</span><br><span class="line">            </span><br><span class="line">        }.navigationViewStyle (<span class="type">StackNavigationViewStyle</span>())</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AnimalRow</span>: <span class="title">View</span> </span>{</span><br><span class="line">    <span class="keyword">let</span> animal: <span class="type">Animal</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">HStack</span> {</span><br><span class="line">            <span class="type">Image</span>(animal.image)</span><br><span class="line">                .resizable ()</span><br><span class="line">                .frame (width: <span class="number">60</span>, height: <span class="number">60</span>)</span><br><span class="line"></span><br><span class="line">            <span class="type">Text</span>(animal.name)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AnimalDetail</span>: <span class="title">View</span> </span>{</span><br><span class="line">    @<span class="type">State</span> <span class="keyword">private</span> <span class="keyword">var</span> showAddToSiri: <span class="type">Bool</span> = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">let</span> animal: <span class="type">Animal</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> shortcut: <span class="type">INShortcut</span> = {</span><br><span class="line">        <span class="keyword">let</span> activity = <span class="type">NSUserActivity</span>(activityType: aType)</span><br><span class="line">        activity.title = <span class="string">"Display a random animal"</span></span><br><span class="line">        activity.suggestedInvocationPhrase = <span class="string">"Show Random Animal"</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="type">INShortcut</span>(userActivity: activity)</span><br><span class="line">    }()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">VStack</span>(spacing: <span class="number">20</span>) {</span><br><span class="line">            <span class="type">Text</span>(animal.name)</span><br><span class="line">                .font (.title)</span><br><span class="line"></span><br><span class="line">            <span class="type">Image</span>(animal.image)</span><br><span class="line">                .resizable ()</span><br><span class="line">                .scaledToFit ()</span><br><span class="line">            </span><br><span class="line">            <span class="type">SiriButton</span>(shortcut: shortcut).frame (height: <span class="number">34</span>)</span><br><span class="line"></span><br><span class="line">            <span class="type">Spacer</span>()</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>下面是用于创建快捷指令和编辑模态表单的 <strong>UIViewControllerRepresentable</strong>：</p>
<h2 id="-1"><a href="#-1" class="headerlink" title=""></a><figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> SwiftUI</span><br><span class="line"><span class="keyword">import</span> IntentsUI</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SiriButton</span>: <span class="title">UIViewControllerRepresentable</span> </span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> shortcut: <span class="type">INShortcut</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">makeUIViewController</span><span class="params">(context: Context)</span></span> -&gt; <span class="type">SiriUIViewController</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="type">SiriUIViewController</span>(shortcut: shortcut)</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">updateUIViewController</span><span class="params">(<span class="keyword">_</span> uiViewController: SiriUIViewController, context: Context)</span></span> {</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SiriUIViewController</span>: <span class="title">UIViewController</span> </span>{</span><br><span class="line">    <span class="keyword">let</span> shortcut: <span class="type">INShortcut</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(shortcut: <span class="type">INShortcut</span>) {</span><br><span class="line">        <span class="keyword">self</span>.shortcut = shortcut</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(nibName: <span class="literal">nil</span>, bundle: <span class="literal">nil</span>)</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>?(coder: <span class="type">NSCoder</span>) {</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"init (coder:) has not been implemented"</span>)</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad ()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> button = <span class="type">INUIAddVoiceShortcutButton</span>(style: .blackOutline)</span><br><span class="line">        button.shortcut = shortcut</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.view.addSubview (button)</span><br><span class="line">        view.centerXAnchor.constraint (equalTo: button.centerXAnchor).isActive = <span class="literal">true</span></span><br><span class="line">        view.centerYAnchor.constraint (equalTo: button.centerYAnchor).isActive = <span class="literal">true</span></span><br><span class="line">        button.translatesAutoresizingMaskIntoConstraints = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">        button.delegate = <span class="keyword">self</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">SiriUIViewController</span>: <span class="title">INUIAddVoiceShortcutButtonDelegate</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">present</span><span class="params">(<span class="keyword">_</span> addVoiceShortcutViewController: INUIAddVoiceShortcutViewController, <span class="keyword">for</span> addVoiceShortcutButton: INUIAddVoiceShortcutButton)</span></span> {</span><br><span class="line">        addVoiceShortcutViewController.delegate = <span class="keyword">self</span></span><br><span class="line">        addVoiceShortcutViewController.modalPresentationStyle = .formSheet</span><br><span class="line">        present (addVoiceShortcutViewController, animated: <span class="literal">true</span>)</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">present</span><span class="params">(<span class="keyword">_</span> editVoiceShortcutViewController: INUIEditVoiceShortcutViewController, <span class="keyword">for</span> addVoiceShortcutButton: INUIAddVoiceShortcutButton)</span></span> {</span><br><span class="line">        editVoiceShortcutViewController.delegate = <span class="keyword">self</span></span><br><span class="line">        editVoiceShortcutViewController.modalPresentationStyle = .formSheet</span><br><span class="line">        present (editVoiceShortcutViewController, animated: <span class="literal">true</span>)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">SiriUIViewController</span>: <span class="title">INUIAddVoiceShortcutViewControllerDelegate</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">addVoiceShortcutViewController</span><span class="params">(<span class="keyword">_</span> controller: INUIAddVoiceShortcutViewController, didFinishWith voiceShortcut: INVoiceShortcut?, error: Error?)</span></span> {</span><br><span class="line">        controller.dismiss (animated: <span class="literal">true</span>)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">addVoiceShortcutViewControllerDidCancel</span><span class="params">(<span class="keyword">_</span> controller: INUIAddVoiceShortcutViewController)</span></span> {</span><br><span class="line">        controller.dismiss (animated: <span class="literal">true</span>)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">SiriUIViewController</span>: <span class="title">INUIEditVoiceShortcutViewControllerDelegate</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">editVoiceShortcutViewController</span><span class="params">(<span class="keyword">_</span> controller: INUIEditVoiceShortcutViewController, didUpdate voiceShortcut: INVoiceShortcut?, error: Error?)</span></span> {</span><br><span class="line">        controller.dismiss (animated: <span class="literal">true</span>)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">editVoiceShortcutViewController</span><span class="params">(<span class="keyword">_</span> controller: INUIEditVoiceShortcutViewController, didDeleteVoiceShortcutWithIdentifier deletedVoiceShortcutIdentifier: UUID)</span></span> {</span><br><span class="line">        controller.dismiss (animated: <span class="literal">true</span>)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">editVoiceShortcutViewControllerDidCancel</span><span class="params">(<span class="keyword">_</span> controller: INUIEditVoiceShortcutViewController)</span></span> {</span><br><span class="line">        controller.dismiss (animated: <span class="literal">true</span>)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></h2><h3 id="Spotlight"><a href="#Spotlight" class="headerlink" title="Spotlight"></a>Spotlight</h3><h5 id="介绍-userActivity"><a href="#介绍-userActivity" class="headerlink" title="介绍 userActivity ()"></a>介绍 userActivity ()</h5><p>Spotlight 的搜索结果可以包含应用中的通用活动。为了让 Spotlight 学会你的活动，你需要在这些活动出现时对外发布，以便 Spotlight 发现它们。要在 SwiftUI 中发布 NSUserActivities，我们需要使用 <strong>userActivity ()</strong> modifier。</p>
<p>在下面的例子中，我们有一个售卖冰淇淋的应用。每当我们选择了某个冰淇淋尺寸，应用将对外发布冰淇淋尺寸；每当有用户搜索冰淇淋时，我们的应用将出现在搜索结果中。如果用户选择了我们的应用对于的搜索结果项，我们的应用将被调起，并且将用户带到最后公布的冰淇淋尺寸。</p>
<p>注意，系统会优化 <strong>userActivity ()</strong> 闭包的调用时机。然而不幸的是，这一点并没有文档说明。系统很聪明，知道该如何保存当前的信息，避免不停更新。在调试的时候，建议你最好在 userActivity 闭包中加入打印语句。</p>
<p>下面的例子中还包含了一个 “Forget” 按钮，这对于调试十分有帮助。它会清除掉已经发布的用户活动，以便将应用从 Spotlight 的搜索结果中移除。注意，NSUserActivity 有一个可选属性：<strong>expirationDate</strong>，如果将其置为 <code>nil</code>，则活动永远不会过期。</p>
<h2 id="-2"><a href="#-2" class="headerlink" title=""></a><figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> SwiftUI</span><br><span class="line"><span class="keyword">import</span> Intents</span><br><span class="line"><span class="keyword">import</span> CoreSpotlight</span><br><span class="line"><span class="keyword">import</span> CoreServices</span><br><span class="line"></span><br><span class="line"><span class="comment">// 要记得把下面的声明添加到 Info.plist 文件的 NSUserActivityTypes 数组中 </span></span><br><span class="line"><span class="keyword">let</span> aType = <span class="string">"com.example.icecream-selection"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">IceCreamSize</span>: <span class="title">Identifiable</span> </span>{</span><br><span class="line">    <span class="keyword">let</span> id: <span class="type">Int</span></span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> price: <span class="type">Float</span></span><br><span class="line">    <span class="keyword">let</span> image: <span class="type">String</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> sizes = [</span><br><span class="line">    <span class="type">IceCreamSize</span>(id: <span class="number">1</span>, name: <span class="string">"Small"</span>, price: <span class="number">1.0</span>, image: <span class="string">"small"</span>),</span><br><span class="line">    <span class="type">IceCreamSize</span>(id: <span class="number">2</span>, name: <span class="string">"Medium"</span>, price: <span class="number">1.45</span>, image: <span class="string">"medium"</span>),</span><br><span class="line">    <span class="type">IceCreamSize</span>(id: <span class="number">3</span>, name: <span class="string">"Large"</span>, price: <span class="number">1.9</span>, image: <span class="string">"large"</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ContentView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    @<span class="type">State</span> <span class="keyword">private</span> <span class="keyword">var</span> selection: <span class="type">Int?</span> = <span class="literal">nil</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">NavigationView</span> {</span><br><span class="line">            <span class="type">List</span>(sizes) { size <span class="keyword">in</span></span><br><span class="line">                <span class="type">NavigationLink</span>(destination: <span class="type">IceCreamDetail</span>(icecream: size),</span><br><span class="line">                               tag: size.id,</span><br><span class="line">                               selection: $selection,</span><br><span class="line">                               label: { <span class="type">IceCreamRow</span>(icecream: size) })</span><br><span class="line">            }</span><br><span class="line">            .navigationTitle (<span class="string">"Ice Creams"</span>)</span><br><span class="line">            .toolbar {</span><br><span class="line">                <span class="type">Button</span>(<span class="string">"Forget"</span>) {</span><br><span class="line">                    <span class="type">NSUserActivity</span>.deleteAllSavedUserActivities {</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">"done!"</span>)</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            </span><br><span class="line">        }</span><br><span class="line">        .onContinueUserActivity (aType, perform: { userActivity <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> icecreamId = userActivity.userInfo?[<span class="string">"sizeId"</span>] <span class="keyword">as</span>? <span class="type">NSNumber</span> {</span><br><span class="line">                selection = icecreamId.intValue</span><br><span class="line"></span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">        .navigationViewStyle (<span class="type">StackNavigationViewStyle</span>())</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">IceCreamRow</span>: <span class="title">View</span> </span>{</span><br><span class="line">    <span class="keyword">let</span> icecream: <span class="type">IceCreamSize</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">HStack</span> {</span><br><span class="line">            <span class="type">Image</span>(icecream.image)</span><br><span class="line">                .resizable ()</span><br><span class="line">                .frame (width: <span class="number">80</span>, height: <span class="number">80</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="type">VStack</span>(alignment: .leading) {</span><br><span class="line">                <span class="type">Text</span>(<span class="string">"\(icecream.name)"</span>).font (.title).fontWeight (.bold)</span><br><span class="line">                <span class="type">Text</span>(<span class="string">"$ \(String (format: "</span>%<span class="number">0</span>.2f<span class="string">", icecream.price))"</span>).font (.subheadline)</span><br><span class="line">                <span class="type">Spacer</span>()</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">IceCreamDetail</span>: <span class="title">View</span> </span>{</span><br><span class="line">    <span class="keyword">let</span> icecream: <span class="type">IceCreamSize</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">VStack</span> {</span><br><span class="line">            <span class="type">Text</span>(<span class="string">"\(icecream.name)"</span>).font (.title).fontWeight (.bold)</span><br><span class="line">            <span class="type">Text</span>(<span class="string">"$ \(String (format: "</span>%<span class="number">0</span>.2f<span class="string">", icecream.price))"</span>).font (.subheadline)</span><br><span class="line"></span><br><span class="line">            <span class="type">Image</span>(icecream.image)</span><br><span class="line">                .resizable ()</span><br><span class="line">                .scaledToFit ()</span><br><span class="line">            </span><br><span class="line">            <span class="type">Spacer</span>()</span><br><span class="line">        }</span><br><span class="line">        .userActivity (aType) { userActivity <span class="keyword">in</span></span><br><span class="line">            userActivity.isEligibleForSearch = <span class="literal">true</span></span><br><span class="line">            userActivity.title = <span class="string">"\(icecream.name) Ice Cream"</span></span><br><span class="line">            userActivity.userInfo = [<span class="string">"sizeId"</span>: icecream.id]</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">let</span> attributes = <span class="type">CSSearchableItemAttributeSet</span>(itemContentType: kUTTypeItem <span class="keyword">as</span> <span class="type">String</span>)</span><br><span class="line">            </span><br><span class="line">            attributes.contentDescription = <span class="string">"Get a delicious ice cream now!"</span></span><br><span class="line">            attributes.thumbnailData = <span class="type">UIImage</span>(named: icecream.image)?.pngData ()</span><br><span class="line">            userActivity.contentAttributeSet = attributes</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Advertising: \(icecream.name)"</span>)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></h2><h3 id="Handoff-接力"><a href="#Handoff-接力" class="headerlink" title="Handoff - 接力"></a>Handoff - 接力</h3><p>基于已经介绍的方法，我们可以创建一个接力应用了。这将是一个可以在另外的设备上接力工作的应用。两个设备上的应用可以是同一个应用或者不同的应用。这种情况通常发生在我们分发了应用的两个不同版本的时候：比如一个是 iOS 版本，另一个是 macOS 版本。</p>
<p>为了让接力能够工作，相关的应用都需要注册在同一个开发者团队的标识下面，并且在所有参与的应用的 Info.plist 中配置 <strong>NSUserActivityTypes</strong> 实体。</p>
<p>有关于接力的更多实现细节，可以参考 Apple 的 <a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/UserExperience/Conceptual/Handoff/AdoptingHandoff/AdoptingHandoff.html">网站</a>。</p>
<p>下面的示例实现了一个简单的 web 浏览器，通过调用 <strong>userActivity ()</strong> 发布用户正在浏览的页面以及他在页面上滚动的位置。</p>
<p>假如用户切换到了另一个设备，当同一个应用被调起或者恢复时，<strong>onContinueUserActivity ()</strong> 闭包将被调用，应用可以借此打开同一个页面，并且滚动到他在之前设备上浏览到的页面位置。</p>
<p>用户活动可以通过 userInfo 字典的形式提供负载数据，它是我们存放特定于接力活动信息的地方。在这个示例中，即页面滚动位置（百分比）和所打开页面的 URL。此外，还包含了发布此活动的应用的 bundle id，它只是用来调试的信息，便于我们准确地知道发生的事情。</p>
<p>注意，示例的代码在 iOS 和 macOS 上都能工作，这是为了让你能够同时创建两个应用，并且测试 iOS 设备和 Mac 设备之间的接力。</p>
<p>最后，虽然跟 NSUserActivity 无关，这个示例还封装了一个 WKWebView，这是演示 javascript 事件（这个示例中的 <code>onScroll</code>）如何更新你的 SwiftUI 视图绑定的绝佳示例。完整的 WebView 代码可以从下面的 gist 文件找到：<a target="_blank" rel="noopener" href="https://gist.github.com/swiftui-lab/a873bf413770db6fd1a525fa424ce8cd">WebView.swift</a></p>
<h2 id="-3"><a href="#-3" class="headerlink" title=""></a><figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> SwiftUI</span><br><span class="line"></span><br><span class="line"><span class="comment">// 要记得把下面的声明添加到 Info.plist 文件的 NSUserActivityTypes 数组中 </span></span><br><span class="line"><span class="keyword">let</span> activityType = <span class="string">"com.example.openpage"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ContentView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    @<span class="type">StateObject</span> <span class="keyword">var</span> data = <span class="type">WebViewData</span>()</span><br><span class="line">    </span><br><span class="line">    @<span class="type">State</span> <span class="keyword">private</span> <span class="keyword">var</span> reload: <span class="type">Bool</span> = <span class="literal">false</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">VStack</span> {</span><br><span class="line">            <span class="type">HStack</span> {</span><br><span class="line">                <span class="type">TextField</span>(<span class="string">""</span>, text: $data.urlBar, onCommit: { <span class="keyword">self</span>.loadUrl (data.urlBar) })</span><br><span class="line">                    .textFieldStyle (<span class="type">RoundedBorderTextFieldStyle</span>())</span><br><span class="line">                    .disableAutocorrection (<span class="literal">true</span>)</span><br><span class="line">                    .modifier (<span class="type">KeyboardModifier</span>())</span><br><span class="line">                    .frame (maxWidth: .infinity)</span><br><span class="line">                    .overlay (<span class="type">ProgressView</span>().opacity (<span class="keyword">self</span>.data.loading ? <span class="number">1</span> : <span class="number">0</span>).scaleEffect (<span class="number">0.5</span>), alignment: .trailing)</span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">                <span class="type">Button</span>(action: {</span><br><span class="line">                    <span class="keyword">self</span>.data.scrollOnLoad = <span class="keyword">self</span>.data.scrollPercent</span><br><span class="line">                    <span class="keyword">self</span>.reload.toggle ()</span><br><span class="line">                }, label: { <span class="type">Image</span>(systemName: <span class="string">"arrow.clockwise"</span>) })</span><br><span class="line">                </span><br><span class="line">                <span class="type">Button</span>(<span class="string">"Go"</span>) {</span><br><span class="line">                    <span class="keyword">self</span>.loadUrl (data.urlBar)</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            .padding (.horizontal, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">            <span class="type">Text</span>(<span class="string">"\(data.scrollPercent)"</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="type">WebView</span>(data: data)</span><br><span class="line">                .id (reload)</span><br><span class="line">                .onAppear { loadUrl (data.urlBar) }</span><br><span class="line">        }</span><br><span class="line">        .userActivity (activityType, element: data.url) { url, activity <span class="keyword">in</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">let</span> bundleid = <span class="type">Bundle</span>.main.bundleIdentifier ?? <span class="string">""</span></span><br><span class="line">            </span><br><span class="line">            activity.addUserInfoEntries (from: [<span class="string">"scrollPercent"</span>: data.scrollPercent,</span><br><span class="line">                                               <span class="string">"page"</span>: data.url?.absoluteString ?? <span class="string">""</span>,</span><br><span class="line">                                               <span class="string">"setby"</span>: bundleid])</span><br><span class="line">            </span><br><span class="line">            logUserActivity (activity, label: <span class="string">"activity"</span>)</span><br><span class="line">        }</span><br><span class="line">        .onContinueUserActivity (activityType, perform: { userActivity <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> page = userActivity.userInfo?[<span class="string">"page"</span>] <span class="keyword">as</span>? <span class="type">String</span> {</span><br><span class="line">                <span class="comment">// Load handoff page</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">self</span>.data.url?.absoluteString != page {</span><br><span class="line">                    <span class="keyword">self</span>.data.url = <span class="type">URL</span>(string: page)</span><br><span class="line">                }</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Restore handoff scroll position</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> scrollPercent = userActivity.userInfo?[<span class="string">"scrollPercent"</span>] <span class="keyword">as</span>? <span class="type">Float</span> {</span><br><span class="line">                    <span class="keyword">self</span>.data.scrollOnLoad = scrollPercent</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            </span><br><span class="line">            logUserActivity (userActivity, label: <span class="string">"on activity"</span>)</span><br><span class="line">        })</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">loadUrl</span><span class="params">(<span class="keyword">_</span> string: String)</span></span> {</span><br><span class="line">        <span class="keyword">if</span> string.hasPrefix (<span class="string">"http"</span>) {</span><br><span class="line">            <span class="keyword">self</span>.data.url = <span class="type">URL</span>(string: string)</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">self</span>.data.url = <span class="type">URL</span>(string: <span class="string">"https://"</span> + string)</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.data.urlBar = <span class="keyword">self</span>.data.url?.absoluteString ?? string</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">logUserActivity</span><span class="params">(<span class="keyword">_</span> activity: NSUserActivity, label: String = <span class="string">""</span>)</span></span> {</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\(label) TYPE = \(activity.activityType)"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\(label) INFO = \(activity.userInfo ?? [:])"</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">KeyboardModifier</span>: <span class="title">ViewModifier</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">body</span><span class="params">(content: Content)</span></span> -&gt; <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="keyword">#if</span> os (iOS)</span><br><span class="line">            <span class="keyword">return</span> content</span><br><span class="line">                .keyboardType (.<span class="type">URL</span>)</span><br><span class="line">                .textContentType (.<span class="type">URL</span>)</span><br><span class="line">        <span class="keyword">#else</span></span><br><span class="line">            <span class="keyword">return</span> content</span><br><span class="line">        <span class="keyword">#endif</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></h2><h3 id="Scene-选择"><a href="#Scene-选择" class="headerlink" title="Scene 选择"></a>Scene 选择</h3><h5 id="介绍-handlesExternalEvents"><a href="#介绍-handlesExternalEvents" class="headerlink" title="介绍 handlesExternalEvents ()"></a>介绍 handlesExternalEvents ()</h5><p>当系统启动或者恢复我们的应用的时候，它必须确定哪个 scene 能够接受到用户活动（某一个时刻只有一个能接收到）。为了帮助它做出这个决策，我们的应用可以用上 <strong>handlesExternalEvents ()</strong> 方法。不幸运是，写这篇文档的时候 (Xcode 12, beta 6)，这个方法貌似不起作用，而且 macOS 上虽然有支持，但缺少平台定义文件。</p>
<p>所以我这里将通过注释来说明它的工作方式，等将来真正可用时，我会更新这篇文章。</p>
<p>这个方法有两个版本。一个用于 WindowGroup 场景：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handlesExternalEvents</span><span class="params">(matching conditions: Set&lt;String&gt;)</span></span> -&gt; <span class="keyword">some</span> <span class="type">Scene</span></span><br></pre></td></tr></tbody></table></figure>
<p>另一个用于视图：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handlesExternalEvents</span><span class="params">(preferring: Set&lt;String&gt;, allowing: Set&lt;String&gt;)</span></span> -&gt; <span class="keyword">some</span> <span class="type">View</span></span><br></pre></td></tr></tbody></table></figure>
<p>两种版本中我们都会指定一个字符串 <code>Set</code>，系统用它来跟 NSUserActivity 的 <strong>targetContentIdentifier</strong> 属性做比对。假如找到匹配项，对应的 scene 会被选用。如果不指定这个 <code>Set</code>，或者没有找到匹配项，则实际行为由具体平台决定。例如，在 iPadOS 上会选择一个已经现有的 scene，而在 macOS 上，新的 scene 会被创建。</p>
<p>在只支持一个 scene 的系统上，这个方法将被忽略。</p>
<p>注意，<strong>targetContentIdentifier</strong> 在 <strong>UNNotificationContent</strong> 和 <strong>UIApplicationShortcutItem</strong> 中也有提供，因此 <strong>handlesExternalEvents ()</strong> 大概率也会支持它们。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Apple 关于 NSUserActivity 的文档资料非常多，所以我建议你去查阅这些文档。但目前 缺少 SwiftUI 的示例。这篇文章的目的就是为你提供一些在 SwiftUI 中实践 NSUserActivity 的启动代码。</p>
<hr>
<p>封面来自 <a target="_blank" rel="noopener" href="https://unsplash.com/@chewy?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Chewy</a> on <a target="_blank" rel="noopener" href="https://unsplash.com/s/photos/nature?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://theinfinitegame.tech/programming/whats-new-in-swift-5-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="猫克杯">
      <meta itemprop="description" content="Stay hungry, stay foolish.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Infinite Game">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/programming/whats-new-in-swift-5-3/" class="post-title-link" itemprop="url">Swift 5.3 新特性</a>
        </h1>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-19 16:34:44" itemprop="dateCreated datePublished" datetime="2020-07-19T16:34:44+08:00">2020-07-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index">
                    <span itemprop="name">programming</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggwdc1o5lmj315o0rswg0.jpg" alt="swift-evolution-4"></p>
<p>欢迎关注微信公众号「Swift 花园」</p>
<p>Swift 5.3 有不少变化，这其中包括多模式 catch 语句，多拖尾闭包，以及 Swift Package Manager 的一些重要改变。</p>
<p>本文会带你浏览一些主要的变化，同时提供参考代码，以便你可以自行尝试。以下是要介绍的新特性的清单：</p>
<ul>
<li>多模式 catch 语句</li>
<li>多拖尾闭包</li>
<li>为枚举自动生成的 Comparable 实现</li>
<li>self. 书写省略</li>
<li>基于类型的程序入口</li>
<li>基于上下文泛型声明的 <code>where</code> 语句</li>
<li>枚举的 cases 可以作为 protocol witnesses</li>
<li>重新提炼的 <code>didSet</code> 语义</li>
<li>新的 Float16 类型</li>
<li>Swift Package Manager 支持二进制依赖，资源等更多类型</li>
</ul>
<h3 id="多模式-catch-语句"><a href="#多模式-catch-语句" class="headerlink" title="多模式 catch 语句"></a>多模式 catch 语句</h3><p><a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/master/proposals/0276-multi-pattern-catch-clauses.md">SE-0276</a> 引入了一个可以在单个 <code>catch</code> 块中捕获多个错误 case 的特性，这能让我们免除错误处理时的重复代码。</p>
<p>例如，下面的代码用枚举定义了错误的两种情况：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">TemperatureError</span>: <span class="title">Error</span> </span>{</span><br><span class="line">    <span class="keyword">case</span> tooCold, tooHot</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>当我们读取到温度时，既可以抛出两种错误中的某一个，也可以返回 “OK”：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getReactorTemperature</span><span class="params">()</span></span> -&gt; <span class="type">Int</span> {</span><br><span class="line">    <span class="number">90</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkReactorOperational</span><span class="params">()</span></span> <span class="keyword">throws</span> -&gt; <span class="type">String</span> {</span><br><span class="line">    <span class="keyword">let</span> temp = getReactorTemperature ()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> temp &lt; <span class="number">10</span> {</span><br><span class="line">        <span class="keyword">throw</span> <span class="type">TemperatureError</span>.tooCold</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> temp &gt; <span class="number">90</span> {</span><br><span class="line">        <span class="keyword">throw</span> <span class="type">TemperatureError</span>.tooHot</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"OK"</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>在捕获错误的环节，SE-0276 允许我们用逗号分隔来表示我们要以相同方式处理  <code>tooHot</code> 和 <code>tooCold</code>。</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> {</span><br><span class="line">    <span class="keyword">let</span> result = <span class="keyword">try</span> checkReactorOperational ()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">" 结果: \(result)"</span>)</span><br><span class="line">} <span class="keyword">catch</span> <span class="type">TemperatureError</span>.tooHot, <span class="type">TemperatureError</span>.tooCold {</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">" 关闭反应堆 &amp; quot;</span>)</span><br><span class="line">} <span class="keyword">catch</span> {</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">" 未知错误 &amp; quot;</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>处理的 case 可以是任意数量的。</p>
<h3 id="多拖尾闭包"><a href="#多拖尾闭包" class="headerlink" title="多拖尾闭包"></a>多拖尾闭包</h3><p><a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/master/proposals/0279-multiple-trailing-closures.md">SE-0279</a> 引入了多拖尾闭包，这使得调用包含多个闭包的函数可以更简单地实现。</p>
<p>这个特性在 SwiftUI 中非常受欢迎。原来形如下面这样的代码：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">OldContentView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    @<span class="type">State</span> <span class="keyword">private</span> <span class="keyword">var</span> showOptions = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">Button</span>(action: {</span><br><span class="line">            <span class="keyword">self</span>.showOptions.toggle ()</span><br><span class="line">        }) {</span><br><span class="line">            <span class="type">Image</span>(systemName: <span class="string">"gear"</span>)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>可以被改写成：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NewContentView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    @<span class="type">State</span> <span class="keyword">private</span> <span class="keyword">var</span> showOptions = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">Button</span> {</span><br><span class="line">            <span class="keyword">self</span>.showOptions.toggle ()</span><br><span class="line">        } label: {</span><br><span class="line">            <span class="type">Image</span>(systemName: <span class="string">"gear"</span>)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>理论上并不要求 <code>label:</code> 要跟在前一个闭包的 <code>}</code> 后面，所以你甚至可以像下面这样书写：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BadContentView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    @<span class="type">State</span> <span class="keyword">private</span> <span class="keyword">var</span> showOptions = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">Button</span> {</span><br><span class="line">            <span class="keyword">self</span>.showOptions.toggle ()</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        label: {</span><br><span class="line">            <span class="type">Image</span>(systemName: <span class="string">"gear"</span>)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>不过，我会建议你当心代码的可读性 —— 像上面的 <code>label</code> 那样的代码块，在 Swift 里看起来更像是标签化的代码块，而不是 <code>Button</code> 构造器的第二个参数。</p>
<p><strong> 注：</strong> 有关 Swift 的多拖尾闭包特性的讨论非常热烈。我想提醒大家的是，像这种类型的语法变动一开始看起来可能会有点别扭，我们需要耐心，给它时间，在实践中体会它带来的结果。</p>
<h3 id="为枚举自动生成的-Comparable-实现"><a href="#为枚举自动生成的-Comparable-实现" class="headerlink" title="为枚举自动生成的 Comparable 实现"></a>为枚举自动生成的 Comparable 实现</h3><p><a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/master/proposals/0266-synthesized-comparable-for-enumerations.md">SE-0266</a> 使得我们可以为枚举生成 <code>Comparable</code> 实现，同时不要求我们声明关联值，或者要求关联值本身必须是 <code>Comparable</code> 的。这个特性让我们可以在同类型的枚举之间用 <code>&lt;</code>，<code>&gt;</code> 和类似的比较操作符来进行比较。</p>
<p>例如，假设我们有一个枚举，它描述了衣服的尺寸，我们可以要求 Swift 为它自动生成 <code>Comparable</code> 实现，代码如下：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Size</span>: <span class="title">Comparable</span> </span>{</span><br><span class="line">    <span class="keyword">case</span> small</span><br><span class="line">    <span class="keyword">case</span> medium</span><br><span class="line">    <span class="keyword">case</span> large</span><br><span class="line">    <span class="keyword">case</span> extraLarge</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>然后我们就可以创建两个这个枚举的实例，并且用 <code>&lt;</code> 进行比较：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> shirtSize = <span class="type">Size</span>.small</span><br><span class="line"><span class="keyword">let</span> personSize = <span class="type">Size</span>.large</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> shirtSize &lt; personSize {</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"T 恤 太小了！"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>自动生成的实现，也能很好地适应枚举的 <code>Comparable</code> 关联值。例如，假设我们有一个枚举，描述了某个队伍获取世界杯冠军的次数，代码可以这样实现：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">WorldCupResult</span>: <span class="title">Comparable</span> </span>{</span><br><span class="line">    <span class="keyword">case</span> neverWon</span><br><span class="line">    <span class="keyword">case</span> winner (stars: <span class="type">Int</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>然后我们用不同的值来创建枚举的不同实例，并且让 Swift 对它们进行排序：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> americanMen = <span class="type">WorldCupResult</span>.neverWon</span><br><span class="line"><span class="keyword">let</span> americanWomen = <span class="type">WorldCupResult</span>.winner (stars: <span class="number">4</span>)</span><br><span class="line"><span class="keyword">let</span> japaneseMen = <span class="type">WorldCupResult</span>.neverWon</span><br><span class="line"><span class="keyword">let</span> japaneseWomen = <span class="type">WorldCupResult</span>.winner (stars: <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> teams = [americanMen, americanWomen, japaneseMen, japaneseWomen]</span><br><span class="line"><span class="keyword">let</span> sortedByWins = teams.sorted ()</span><br><span class="line"><span class="built_in">print</span>(sortedByWins)</span><br></pre></td></tr></tbody></table></figure>
<p>排序过程会把未获得世界杯冠军的队伍放在前面，然后是日本女子队，再然后是美国女子队 —— 两组 <code>winner</code> 的队被认为是大于两组 <code>neverWon</code> 的队，而 <code>winner (stars: 4)</code> 被认为是大于 <code>winner (stars: 1)</code>。</p>
<h3 id="self-书写省略"><a href="#self-书写省略" class="headerlink" title="self. 书写省略"></a>self. 书写省略</h3><p><a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/master/proposals/0269-implicit-self-explicit-capture.md">SE-0269</a> 使得我们可以在一些不必要的地方省略 <code>self</code> 。在这个改变之前，我们需要在所有的闭包当中对引用 <code>self</code> 的属性或者方法冠以 <code>self.</code>，以便显式地明确语义。但有的时候由于闭包不可能产生引用循环，<code>self</code> 是多余的。</p>
<p>例如，之前我们需要把代码写成下面这样：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">OldContentView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">List</span>(<span class="number">1</span>..&lt;<span class="number">5</span>) { number <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">self</span>.cell (<span class="keyword">for</span>: number)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">cell</span><span class="params">(<span class="keyword">for</span> number: Int)</span></span> -&gt; <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">Text</span>(<span class="string">"Cell \(number)"</span>)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>对 <code>self.cell (for:)</code> 的调用不会产生引用循环，因为它是在结构体内使用。多亏了 SE-0269，上面的代码现在可以免去 <code>self.</code>：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NewContentView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">List</span>(<span class="number">1</span>..&lt;<span class="number">5</span>) { number <span class="keyword">in</span></span><br><span class="line">            cell (<span class="keyword">for</span>: number)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">cell</span><span class="params">(<span class="keyword">for</span> number: Int)</span></span> -&gt; <span class="keyword">some</span> <span class="type">View</span> {</span><br><span class="line">        <span class="type">Text</span>(<span class="string">"Cell \(number)"</span>)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这个特性对于大量使用闭包的框架非常有用，包括 SwiftUI 和 Combine。</p>
<h3 id="基于类型的程序入口"><a href="#基于类型的程序入口" class="headerlink" title="基于类型的程序入口"></a>基于类型的程序入口</h3><p><a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/master/proposals/0281-main-attribute.md">SE-0281</a> 引入了一个新的 <code>@main</code> 属性，它可以让我们声明程序的入口。这个特性使得我们可以精确地控制程序启动时要执行的代码，对于命令行程序尤其有帮助。</p>
<p>例如，当我们创建一个终端应用时，我们必须创建一个叫 main.swift 的文件，然后把启动代码放在里面：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">OldApp</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Running!"</span>)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> app = <span class="type">OldApp</span>()</span><br><span class="line">app.run ()</span><br></pre></td></tr></tbody></table></figure>
<p>Swift 会自动把 main.swift 看作最顶层的代码，创建 <code>App</code> 实例并且运行。即便在 SE-0281 之后这个做法都一直被延续，但现在你可以干掉 main.swift 了，转而使用 <code>@main</code> 属性来标记某个包含静态 <code>main</code> 方法的结构体或者类，让它充当程序入口：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@main</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NewApp</span> </span>{</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Running!"</span>)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>上面的代码所在的程序运行时，Swift 会自动调用 <code>NewApp.main ()</code> 来启动程序流程。</p>
<p>新的 <code>@main</code> 属性对于 UIKit 和 AppKit 开发者来说可能有点属性，因为我们正是用 <code>@UIApplicationMain</code> 和 <code>@NSApplicationMain</code> 来标记 app 代理的。</p>
<p>不过，使用 <code>@main</code> 的时候有一些注意事项：</p>
<ul>
<li>已经有 main.swift 文件的 app 不能使用这个属性</li>
<li>不能有一个以上的 <code>@main</code> 属性</li>
<li><code>@main</code> 属性只能用在最顶层的类型上 —— 这个类型不继承自任何其他类</li>
</ul>
<h3 id="基于上下文泛型声明的-where-语句"><a href="#基于上下文泛型声明的-where-语句" class="headerlink" title="基于上下文泛型声明的 where 语句"></a>基于上下文泛型声明的 <code>where</code> 语句</h3><p><a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/master/proposals/0267-where-on-contextually-generic.md">SE-0267</a> 引入一个新特性，你可以给泛型类型或者扩展添加带有 <code>where</code> 语句限定的函数。</p>
<p>例如，我们创建了一个简单的 <code>Stack</code>，可以压栈，出栈元素：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Stack</span>&lt;<span class="title">Element</span>&gt; </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> array = [<span class="type">Element</span>]()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">push</span><span class="params">(<span class="keyword">_</span> obj: Element)</span></span> {</span><br><span class="line">        array.append (obj)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">pop</span><span class="params">()</span></span> -&gt; <span class="type">Element?</span> {</span><br><span class="line">        array.popLast ()</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>借助 SE-0267，我们现在可以添加一个 <code>sorted ()</code> 方法给这个 <code>Stack</code>，并且要求这个方法只有在 <code>Stack</code> 的泛型参数 <code>Element</code> 遵循 <code>Comparable</code> 协议的时候才能使用：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Stack</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">sorted</span><span class="params">()</span></span> -&gt; [<span class="type">Element</span>] <span class="keyword">where</span> <span class="type">Element</span>: <span class="type">Comparable</span> {</span><br><span class="line">        array.sorted ()</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="枚举的-cases-可以作为-protocol-witnesses"><a href="#枚举的-cases-可以作为-protocol-witnesses" class="headerlink" title="枚举的 cases 可以作为 protocol witnesses"></a>枚举的 cases 可以作为 protocol witnesses</h3><p><a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/master/proposals/0280-enum-cases-as-protocol-witnesses.md">SE-0280</a> 使得枚举可以参与 protocol witness matching，这是一种表述我们可以更容易地匹配协议要求的技术方式。</p>
<p>例如，你可以编写代码处理各种类型的数据，但是假如数据不见了怎么办呢？当然，你可以借助空合运算符，每次都提供一个默认值。不过。你可以借助协议来要求默认值，然后让各种类型遵循这个协议：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Defaultable</span> </span>{</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> defaultValue: <span class="type">Self</span> { <span class="keyword">get</span> }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 让整数有默认值 0</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Int</span>: <span class="title">Defaultable</span> </span>{</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> defaultValue: <span class="type">Int</span> { <span class="number">0</span> }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 让数组有默认值空数组 </span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Array</span>: <span class="title">Defaultable</span> </span>{</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> defaultValue: <span class="type">Array</span> { [] }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 让字典有默认值空字典 </span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Dictionary</span>: <span class="title">Defaultable</span> </span>{</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> defaultValue: <span class="type">Dictionary</span> { [:] }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>SE-0280 使得我们能对枚举做出一样的控制。比如，你有一个 <code>padding</code> 枚举，它能接收像素值，厘米值，或者是系统的默认值：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Padding</span>: <span class="title">Defaultable</span> </span>{</span><br><span class="line">    <span class="keyword">case</span> pixels (<span class="type">Int</span>)</span><br><span class="line">    <span class="keyword">case</span> cm (<span class="type">Int</span>)</span><br><span class="line">    <span class="keyword">case</span> defaultValue</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这样的代码在 SE-0280 之前是无法实现的 —— Swift 会抱怨 <code>Padding</code> 不满足协议。但是，如果你仔细琢磨一下，协议其实是满足的：我们需要一个静态的 <code>defaultValue</code>，它返回 <code>Self</code>，换言之，就是某个遵循协议的具体类型，而这正是 <code>Padding.defaultValue</code> 提供的。</p>
<h3 id="重新提炼的-didSet-语义"><a href="#重新提炼的-didSet-语义" class="headerlink" title="重新提炼的 didSet 语义"></a>重新提炼的 <code>didSet</code> 语义</h3><p><a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/master/proposals/0268-didset-semantics.md">SE-0268</a> 调整了 <code>didSet</code> 属性观察者的工作方式，以便它们能更高效地工作。对于这个优化你不需要改动任何代码，自动获得一个小小的性能提升。</p>
<p>在内部，Swift 做出的改变是在设置新值时不再查询旧值。如果你不使用旧值，也没有设置 <code>willSet</code>，Swift 会即时修改数值。</p>
<p>假如你需要用到旧值，只需要引用 <code>oldValue</code> 即可，方式如下：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">didSet</span> {</span><br><span class="line">    <span class="keyword">_</span> = oldValue</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="新的-Float16-类型"><a href="#新的-Float16-类型" class="headerlink" title="新的 Float16 类型"></a>新的 Float16 类型</h3><p><a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/master/proposals/0277-float16.md">SE-0277</a> 引入了一个新的半精度浮点类型，<code>Float16</code>。这个精度在图像编程和机器学习中十分常见。</p>
<p>新类型和 Swift 原来的其他类型相似：</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> first: <span class="type">Float16</span> = <span class="number">5</span></span><br><span class="line"><span class="keyword">let</span> second: <span class="type">Float32</span> = <span class="number">11</span></span><br><span class="line"><span class="keyword">let</span> third: <span class="type">Float64</span> = <span class="number">7</span></span><br><span class="line"><span class="keyword">let</span> fourth: <span class="type">Float80</span> = <span class="number">13</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Swift-Package-Manager-支持二进制依赖，资源等更多类型"><a href="#Swift-Package-Manager-支持二进制依赖，资源等更多类型" class="headerlink" title="Swift Package Manager 支持二进制依赖，资源等更多类型"></a>Swift Package Manager 支持二进制依赖，资源等更多类型</h3><p>Swift 5.3 为 Swift Package Manager (SPM) 带来了很多提升，恕我不能在这里一一举例。不过我们可以讨论一下 SPM 有哪些变化以及为什么会有这些变化。 </p>
<p>首先，<a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/master/proposals/0271-package-manager-resources.md">SE-0271</a> (Package Manager Resources) 使得 SPM 能包含诸如图片，音频，JSON 等类型的资源。这个机制可不只是把文件拷进最终的 app bundle 这么简单 —— 举个例子，我们可以应用一个自定义处理步骤到我们的 assets，比如为 iOS 优化图片。为此，新增的 <code>Bundle.module</code> 属性就是用来在运行时访问这些 assets 的。<a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/master/proposals/0278-package-manager-localized-resources.md">SE-0278</a> (Package Manager Localized Resources) 进一步支持了资源的本地化版本，例如提供适用某个国家的图片。</p>
<p>其次，<a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/master/proposals/0272-swiftpm-binary-dependencies.md">SE-0272</a> (Package Manager Binary Dependencies) 使得 SPM 可以使用二进制包。这意味着像 Firebase 这样的闭源 SDK 现在也可以通过 SPM 集成了。</p>
<p>再次，<a target="_blank" rel="noopener" href="https://github.com/apple/swift-evolution/blob/master/proposals/0273-swiftpm-conditional-target-dependencies.md">SE-0273</a> (Package Manager Conditional Target Dependencies) 可以让我们指定为特定平台和配置使用依赖。例如，我们可能在为 Linux 平台编译时，额外需要某些特定的框架，或者我们在本地测试的时候需要一些依赖调试用的框架。</p>
<p>值得一提的是，SE-0271 的 “Future Directions” 一节中提到了对资源的安全访问 —— 这意味着像 <code>Image ("avatar")</code> 这样的代码之后会变成 <code>Image (module.avatar)</code> 。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://theinfinitegame.tech/unity-portfolio/tfaces-game-match-hero-progress-daily-20200310/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="猫克杯">
      <meta itemprop="description" content="Stay hungry, stay foolish.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Infinite Game">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/unity-portfolio/tfaces-game-match-hero-progress-daily-20200310/" class="post-title-link" itemprop="url">Unity Tech | How to implement a ‘sacrifice’ skill - take bullets for companion 🐺🐺🐺</a>
        </h1>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-21 10:22:05" itemprop="dateCreated datePublished" datetime="2020-03-21T10:22:05+08:00">2020-03-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/unity-portfolio/" itemprop="url" rel="index">
                    <span itemprop="name">unity-portfolio</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>In our latest game development, I implemented an interesting action: “jumping block”.</p>
<p>The team used this skill on the white wolf guard.  The specific skill is called “sacrifice”. 🤨</p>
<blockquote>
<p>Whenever the wolf leader around him receives deadly ballistic damage, the heroic white wolf guard will take a deep leap and block this damage for his boss.</p>
</blockquote>
<p>Here is the video demonstration on Youtube:</p>
<video src="https://www.youtube.com/watch?v=LCN8_GVhync" type="video/mp4" controls="controls" width="100%" height="100%">
</video>


<p>And here is the schematic diagram:</p>
<p><img src="/images/ward fellow by take a bullet for them.png" width="68%" height="68%" style="margin: 10 auto;"></p>
<p>The realization of the jumping block is very interesting 🤪. It is a combination of mathematics and physics.</p>
<p>Let’s skip the unimportant part and look directly at the most critical code:</p>
<figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> A callback invoked when we find a particle(i.e. our bullet) is flying toward something</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="collisionInstance"&gt;</span>a manager contains information about the particle<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="estimatedArrival"&gt;</span>estimated time of flight<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span>  <span class="title">OnParticleHeadingToTarget</span>(<span class="params">ParticleCollisionInstance collisionInstance, <span class="built_in">float</span> estimatedArrival</span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// Check if the bullet is flying toward our fellow</span></span><br><span class="line">    <span class="keyword">if</span> (collisionInstance != <span class="literal">null</span> &amp;&amp; collisionInstance.HeadingTarget == wolfFellow.gameObject)</span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// Calculate which point should I jump in order to take the bullet for my fellow</span></span><br><span class="line">        jumpSpot = collisionInstance.EvaluateNecessaryArrival(<span class="number">4f</span>, <span class="keyword">out</span> <span class="built_in">float</span> time);</span><br><span class="line">        <span class="comment">// of course, you should look at the bullet when you try to take it.</span></span><br><span class="line">        lookSpot = collisionInstance.gameObject.transform.position;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Every creature has its react time when something happens</span></span><br><span class="line">        <span class="built_in">float</span> reactTime = (_dollAction <span class="keyword">as</span> WolfDollAction).WardJumpToApexDuration;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (reactTime &lt;= time)</span><br><span class="line">        {</span><br><span class="line">            Invoke(<span class="keyword">nameof</span>(WardFellow), time - reactTime);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Ward fellow, for wolf guard, warding is implemented by jump to take bullet for fellow</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">WardFellow</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    WolfDollAction wolfAction = _dollAction <span class="keyword">as</span> WolfDollAction;</span><br><span class="line"></span><br><span class="line">    wolfAction.TriggerJumpWard(wolfFellow, jumpSpot, lookSpot);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>the mathematical part, <code>EvaluateNecessaryArrival</code>：</p>
<figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Evaluate necessary arrival which we must pass through</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="distanceToHeadingTarget"&gt;</span>distance for the arrival to the target<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="estimatedTime"&gt;</span>out parameter, a estimated time by when we arrive<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>the vector of the must-pass arrival<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Vector3 <span class="title">EvaluateNecessaryArrival</span>(<span class="params"><span class="built_in">float</span> distanceToHeadingTarget, <span class="keyword">out</span> <span class="built_in">float</span> estimatedTime</span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// Target</span></span><br><span class="line">    <span class="keyword">var</span> heading = HeadingTargetSpot - transform.position;</span><br><span class="line">    <span class="comment">// Distance</span></span><br><span class="line">    <span class="keyword">var</span> currentDistance = heading.magnitude;</span><br><span class="line">    <span class="comment">// Direction</span></span><br><span class="line">    <span class="keyword">var</span> direction = heading / currentDistance;</span><br><span class="line"></span><br><span class="line">    Vector3 arrival = HeadingTargetSpot + direction * -distanceToHeadingTarget;</span><br><span class="line">    estimatedTime = (currentDistance - distanceToHeadingTarget) / MainFlyingParticleVelocity.magnitude;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> arrival;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>It’s not that difficult, right? 🙊  Hoping you enjoy this skill. 😬</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="猫克杯"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">猫克杯</p>
  <div class="site-description" itemprop="description">Stay hungry, stay foolish.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/nichollyn" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;nichollyn" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-fw fa-rss"></i>RSS</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/kai-wen-mao-66" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;kai-wen-mao-66" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i>知乎</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        
  <div class="beian"><a href="https://beian.miit.gov.cn/#/Integrated/index" rel="noopener" target="_blank">闽ICP备20000913号-1 </a>
      <img src="/images/gongan.png" style="display: inline-block;"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=35021302000298" rel="noopener" target="_blank">闽公网安备35021302000298号 </a>
  </div>

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">猫克杯</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">238k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:37</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/three-waves.min.js"></script>


  



  <script>
  if (CONFIG.page.isPost) {
    wpac_init = window.wpac_init || [];
    wpac_init.push({
      widget: 'Rating',
      id: ,
      el: 'wpac-rating',
      color: 'f79533'
    });
    (function() {
      if ('WIDGETPACK_LOADED' in window) return;
      WIDGETPACK_LOADED = true;
      var mc = document.createElement('script');
      mc.type = 'text/javascript';
      mc.async = true;
      mc.src = '//embed.widgetpack.com/widget.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(mc, s.nextSibling);
    })();
  }
  </script>

  
<script src="/js/local-search.js"></script>













  

  

  

</body>
</html>
