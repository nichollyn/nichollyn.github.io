<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-center-radar.min.css">
  <script src="/lib/pace/pace.min.js"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://theinfinitegame.tech').hostname,
    root: '/',
    scheme: 'Muse',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false,"b2t":true,"scrollpercent":true},
    copycode: {"enable":true,"show_result":true,"style":"flat"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="Stay hungry, stay foolish.">
<meta property="og:type" content="website">
<meta property="og:title" content="The Infinite Game">
<meta property="og:url" content="https://theinfinitegame.tech/index.html">
<meta property="og:site_name" content="The Infinite Game">
<meta property="og:description" content="Stay hungry, stay foolish.">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="çŒ«å…‹æ¯">
<meta property="article:tag" content="tech">
<meta property="article:tag" content=" life">
<meta property="article:tag" content=" philosophy">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://theinfinitegame.tech/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>The Infinite Game</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="The Infinite Game" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">The Infinite Game</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>å½’æ¡£</a>

  </li>
        <li class="menu-item menu-item-top">

    <a href="/top/" rel="section"><i class="fa fa-fw fa-signal"></i>çƒ­é—¨</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404.html" rel="section"><i class="fa fa-fw fa-heartbeat"></i>å…¬ç›Š 404</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="æœç´¢..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/nichollyn" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://theinfinitegame.tech/unity-portfolio/tfaces-game-match-hero-progress-daily-20200310/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="çŒ«å…‹æ¯">
      <meta itemprop="description" content="Stay hungry, stay foolish.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Infinite Game">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/unity-portfolio/tfaces-game-match-hero-progress-daily-20200310/" class="post-title-link" itemprop="url">Unity Tech | How to implement a â€˜sacrificeâ€™ skill - take bullets for companion ğŸºğŸºğŸº</a>
        </h1>

        <div class="post-meta">

          
            <i class="fa fa-thumb-tack"></i>
            <font color="7D26CD">ç½®é¡¶</font>
            <span class="post-meta-divider">|</span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-03-21 10:22:05" itemprop="dateCreated datePublished" datetime="2020-03-21T10:22:05+08:00">2020-03-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/unity-portfolio/" itemprop="url" rel="index">
                    <span itemprop="name">unity-portfolio</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>3k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>3 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>In our latest game development, I implemented an interesting action: â€œjumping blockâ€.</p>
<p>The team used this skill on the white wolf guard.  The specific skill is called â€œsacrificeâ€. ğŸ¤¨</p>
<blockquote>
<p>Whenever the wolf leader around him receives deadly ballistic damage, the heroic white wolf guard will take a deep leap and block this damage for his boss.</p>
</blockquote>
<p>Here is the video demonstration:</p>
<video src="https://www.youtube.com/watch?v=LCN8_GVhync" type="video/mp4" controls="controls" width="100%" height="100%">
</video>


<p>And here is the schematic diagram:</p>
<img src="/images/ward fellow by take a bullet for them.png" width="68%" height="68%" style="margin: 10 auto;">


<p>The realization of the jumping block is very interesting ğŸ¤ª. It is a combination of mathematics and physics.</p>
<p>Letâ€™s skip the unimportant part and look directly at the most critical code:</p>
<figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> A callback invoked when we find a particle(i.e. our bullet) is flying toward something</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="collisionInstance"&gt;</span>a manager contains information about the particle<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="estimatedArrival"&gt;</span>estimated time of flight<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span>  <span class="title">OnParticleHeadingToTarget</span>(<span class="params">ParticleCollisionInstance collisionInstance, <span class="keyword">float</span> estimatedArrival</span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// Check if the bullet is flying toward our fellow</span></span><br><span class="line">    <span class="keyword">if</span> (collisionInstance != <span class="literal">null</span> &amp;&amp; collisionInstance.HeadingTarget == wolfFellow.gameObject)</span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// Calculate which point should I jump in order to take the bullet for my fellow</span></span><br><span class="line">        jumpSpot = collisionInstance.EvaluateNecessaryArrival(<span class="number">4f</span>, <span class="keyword">out</span> <span class="keyword">float</span> time);</span><br><span class="line">        <span class="comment">// of course, you should look at the bullet when you try to take it.</span></span><br><span class="line">        lookSpot = collisionInstance.gameObject.transform.position;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Every creature has its react time when something happens</span></span><br><span class="line">        <span class="keyword">float</span> reactTime = (_dollAction <span class="keyword">as</span> WolfDollAction).WardJumpToApexDuration;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (reactTime &lt;= time)</span><br><span class="line">        {</span><br><span class="line">            Invoke(<span class="keyword">nameof</span>(WardFellow), time - reactTime);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Ward fellow, for wolf guard, warding is implemented by jump to take bullet for fellow</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">WardFellow</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    WolfDollAction wolfAction = _dollAction <span class="keyword">as</span> WolfDollAction;</span><br><span class="line"></span><br><span class="line">    wolfAction.TriggerJumpWard(wolfFellow, jumpSpot, lookSpot);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>the mathematical part, <code>EvaluateNecessaryArrival</code>ï¼š</p>
<figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Evaluate necessary arrival which we must pass through</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="distanceToHeadingTarget"&gt;</span>distance for the arrival to the target<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="estimatedTime"&gt;</span>out parameter, a estimated time by when we arrive<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>the vector of the must-pass arrival<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Vector3 <span class="title">EvaluateNecessaryArrival</span>(<span class="params"><span class="keyword">float</span> distanceToHeadingTarget, <span class="keyword">out</span> <span class="keyword">float</span> estimatedTime</span>)</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// Target</span></span><br><span class="line">    <span class="keyword">var</span> heading = HeadingTargetSpot - transform.position;</span><br><span class="line">    <span class="comment">// Distance</span></span><br><span class="line">    <span class="keyword">var</span> currentDistance = heading.magnitude;</span><br><span class="line">    <span class="comment">// Direction</span></span><br><span class="line">    <span class="keyword">var</span> direction = heading / currentDistance;</span><br><span class="line"></span><br><span class="line">    Vector3 arrival = HeadingTargetSpot + direction * -distanceToHeadingTarget;</span><br><span class="line">    estimatedTime = (currentDistance - distanceToHeadingTarget) / MainFlyingParticleVelocity.magnitude;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> arrival;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p>Itâ€™s not that difficult, right? ğŸ™Š  Hoping you enjoy this skill. ğŸ˜¬</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://theinfinitegame.tech/unity-portfolio/tfaces-game-match-hero-progress-daily-20191221/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="çŒ«å…‹æ¯">
      <meta itemprop="description" content="Stay hungry, stay foolish.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Infinite Game">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/unity-portfolio/tfaces-game-match-hero-progress-daily-20191221/" class="post-title-link" itemprop="url">Unity Tech | Meteor rain - Randomly outside, but neatly inside ğŸ”¥ğŸ”¥ğŸ”¥</a>
        </h1>

        <div class="post-meta">

          
            <i class="fa fa-thumb-tack"></i>
            <font color="7D26CD">ç½®é¡¶</font>
            <span class="post-meta-divider">|</span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-21 14:06:47" itemprop="dateCreated datePublished" datetime="2019-12-21T14:06:47+08:00">2019-12-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/unity-portfolio/" itemprop="url" rel="index">
                    <span itemprop="name">unity-portfolio</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>4.9k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>4 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Our team recently researched the special effects of â€œFlame Rainâ€ and found many other developersâ€™ solutions from the Internet. They were not very satisfactory for us, mainly because they could not meet the requirements of randomness and precise control at the same time. Finally, we decided to develop a component by ourselves.</p>
<p>We make use of the â€œmachine gunâ€ component which we develop previously. Machine guns can aim at targets and emit particle effects. The related API and prefabs support multiple targets, bullet prefabs, and the gun body can be rotated.</p>
<p>Our idea is to use many â€œmachine gunsâ€ to build a â€œcloudâ€. This â€œcloudâ€ can cause a regional â€œball rainâ€ attack on the ground.<br>Of course, this cloud is virtual, and it is not necessary to use render in the scene, it is only used to deploy machine guns. The machine gun is also invisible.</p>
<p>Here is the demo scene we used to verify the bullet cloud function during development:</p>
<p><img src="/images/bullet_cloud.png" width="68%" height="68%" style="margin: 10 auto;"></p>
<p>Because the bullet cloud is usually invisible in the actual scene, you can deploy a bullet cloud anywhere. However, considering the time of flight of the particles, you need to decide the height of the cloud yourself. We implemented it as a well-encapsulated component. You can configure it with any number of raindrops to hit the target precisely (of course, there can be multiple targets), the amount of hit you want to happend on each target, which bullets you want to use. And, there are many other bullets which looks like randomly drop, but actually they are configured by us.</p>
<p>When deploying the bullet cloud to your own scene, you need to pay attention to check the particle effects used as bullets, so you can ensure that there is no layer which can collide with your target.</p>
<p>We applied the previously implemented particles of various projectiles as cloud bullets, which triggered explosions based on physical collisions. At the same time, we determine whether a certain rain process of the bullet cloud is completed based on the collision. This API is necessary for the design of the skill system. Because we need to know when the skills we have released are over.</p>
<p>Of course, if you want to use purely mathematical methods to determine whether the bullet hits the target, this part needs to be implemented by yourself. Our bullet cloud canâ€™t do that yet.</p>
<p>Using this bullet cloud to achieve the effect of â€œFlame Rainâ€, we are quite satisfied, because it has achieved both randomly effect and accuratly control on the damage. Because many of our gameâ€™s skill look randomly, but their damage amount is fixed.</p>
<p>The implementation logic is still quite complicated, try it:</p>
<figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EnsurePreciseHitDrop</span>(<span class="params"><span class="keyword">int</span> _preciseHitCount = <span class="number">-1</span></span>)</span></span><br><span class="line"><span class="function"></span>        {</span><br><span class="line">            PreciseHitCount = _preciseHitCount == <span class="number">-1</span> ? preciseHitCountPreset : _preciseHitCount;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (PreciseHitCount &gt; <span class="number">0</span> &amp;&amp; Targets != <span class="literal">null</span> &amp;&amp; Targets.Length &gt; <span class="number">0</span>)</span><br><span class="line">            {</span><br><span class="line">                PreciseHitDrop = <span class="keyword">new</span> Aimer[PreciseHitCount];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (PreciseHitCount == <span class="number">1</span>)</span><br><span class="line">                {</span><br><span class="line">                    <span class="keyword">if</span> (Targets.Length == <span class="number">1</span>)</span><br><span class="line">                    {</span><br><span class="line">                        PreciseHitDrop[<span class="number">0</span>] = CenterDrop;</span><br><span class="line">                        preciseDropMaxIndexInAllDrop = <span class="number">0</span>;</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    {</span><br><span class="line">                        Vector3 target = Targets[Random.Range(<span class="number">0</span>, Targets.Length)];</span><br><span class="line"></span><br><span class="line">                        PreciseHitDrop[<span class="number">0</span>] = AllDrop[<span class="number">1</span>];</span><br><span class="line">                        PreciseHitDrop[<span class="number">0</span>].transform.position = DropMoveToAimAtTarget(target);</span><br><span class="line"></span><br><span class="line">                        preciseDropMaxIndexInAllDrop = <span class="number">1</span>;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (PreciseHitCount &gt; <span class="number">1</span> &amp;&amp; PreciseHitCount &lt;= DropCount)</span><br><span class="line">                {</span><br><span class="line">                    <span class="keyword">if</span> (Targets.Length == <span class="number">1</span>)</span><br><span class="line">                    {</span><br><span class="line">                        PreciseHitDrop[<span class="number">0</span>] = CenterDrop;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; PreciseHitCount; i++)</span><br><span class="line">                        {</span><br><span class="line">                            PreciseHitDrop[i] = AllDrop[i];</span><br><span class="line">                            PreciseHitDrop[i].transform.position = CenterDrop.transform.position;</span><br><span class="line">                        }</span><br><span class="line"></span><br><span class="line">                        preciseDropMaxIndexInAllDrop = PreciseHitCount - <span class="number">1</span>;</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (Targets.Length &gt; <span class="number">1</span>)</span><br><span class="line">                    {</span><br><span class="line">                        <span class="keyword">int</span> targetCount = Targets.Length;</span><br><span class="line">                        <span class="keyword">if</span> (EquallyAssignPreciseHit)</span><br><span class="line">                        {</span><br><span class="line">                            <span class="keyword">int</span> quota = PreciseHitCount / targetCount;</span><br><span class="line">                            <span class="keyword">int</span> remain = PreciseHitCount % targetCount;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">int</span> allDropIndex = <span class="number">1</span>;</span><br><span class="line">                            <span class="keyword">int</span> preciseDropIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">int</span> targetIndex = <span class="number">0</span>; targetIndex &lt; targetCount; targetIndex++)</span><br><span class="line">                            {</span><br><span class="line">                                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; quota; i++)</span><br><span class="line">                                {</span><br><span class="line">                                    PreciseHitDrop[preciseDropIndex] = AllDrop[allDropIndex];</span><br><span class="line">                                    PreciseHitDrop[preciseDropIndex].transform.position</span><br><span class="line">                                        = DropMoveToAimAtTarget(Targets[targetIndex]);</span><br><span class="line"></span><br><span class="line">                                    allDropIndex++;</span><br><span class="line">                                    preciseDropIndex++;</span><br><span class="line">                                }</span><br><span class="line">                            }</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (remain &gt; <span class="number">0</span>)</span><br><span class="line">                            {</span><br><span class="line">                                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; remain; j++)</span><br><span class="line">                                {</span><br><span class="line">                                    Vector3 target = Targets[Random.Range(<span class="number">0</span>, Targets.Length)];</span><br><span class="line"></span><br><span class="line">                                    PreciseHitDrop[preciseDropIndex] = AllDrop[allDropIndex];</span><br><span class="line">                                    PreciseHitDrop[preciseDropIndex].transform.position</span><br><span class="line">                                        = DropMoveToAimAtTarget(target);</span><br><span class="line"></span><br><span class="line">                                    allDropIndex++;</span><br><span class="line">                                    preciseDropIndex++;</span><br><span class="line">                                }</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        {</span><br><span class="line">                            <span class="keyword">int</span> allDropIndex = <span class="number">1</span>;</span><br><span class="line">                            <span class="keyword">int</span> preciseDropIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PreciseHitCount; i++)</span><br><span class="line">                            {</span><br><span class="line">                                Vector3 target = Targets[Random.Range(<span class="number">0</span>, Targets.Length)];</span><br><span class="line"></span><br><span class="line">                                PreciseHitDrop[preciseDropIndex] = AllDrop[allDropIndex];</span><br><span class="line">                                PreciseHitDrop[preciseDropIndex].transform.position</span><br><span class="line">                                    = DropMoveToAimAtTarget(target);</span><br><span class="line"></span><br><span class="line">                                allDropIndex++;</span><br><span class="line">                                preciseDropIndex++;</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line"></span><br><span class="line">                        preciseDropMaxIndexInAllDrop = PreciseHitCount;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                {</span><br><span class="line">                    preciseDropMaxIndexInAllDrop = DropCount - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> System.InvalidOperationException(<span class="string">"Precise hit count exceed total drop count."</span>);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br></pre></td></tr></tbody></table></figure><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://theinfinitegame.tech/development/programming-use-pipeline-to-tackle-complexity/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="çŒ«å…‹æ¯">
      <meta itemprop="description" content="Stay hungry, stay foolish.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Infinite Game">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/development/programming-use-pipeline-to-tackle-complexity/" class="post-title-link" itemprop="url">ç”¨ â€œæµæ°´çº¿â€ è®¾è®¡æ‹†è§£å¤æ‚å¤„ç†æµç¨‹</a>
        </h1>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-03-17 11:32:12" itemprop="dateCreated datePublished" datetime="2020-03-17T11:32:12+08:00">2020-03-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/development/" itemprop="url" rel="index">
                    <span itemprop="name">development</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>8.1k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>7 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>å»ºè®®æ¨ªå±é˜…è¯»ä»£ç </p>
</blockquote>
<ul>
<li>æœ¬æ–‡çš„ä¸»è¦ä»·å€¼ï¼šæä¾›ä¸€ç§æŠ½è±¡å¤æ‚é€»è¾‘ï¼Œè¾¾æˆåŠŸèƒ½å¤ç”¨çš„æ€è·¯</li>
<li>å…³é”®è¯ï¼šè¯­ä¹‰æç‚¼ã€åŠ¨æ€å…·å</li>
<li>æœ¬æ–‡çº¦ 4000 å­—ï¼Œå»ºè®®é˜…è¯»æ—¶é—´ 12 åˆ†é’Ÿã€‚</li>
</ul>
<h1 id="å¼•å­"><a href="#å¼•å­" class="headerlink" title="å¼•å­"></a>å¼•å­</h1><p>åœ¨è½¯ä»¶å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šé‡åˆ°ä¸€ç§åœºæ™¯ï¼šéšç€äº§å“åŠŸèƒ½çš„æ‰©å±•ï¼Œå‡ºç°äº†å¤šä¸ªå…·å¤‡é«˜åº¦ç›¸ä¼¼æ€§çš„åŠŸèƒ½å•å…ƒã€‚ä½œä¸ºåŠŸèƒ½å•å…ƒï¼Œå®ƒä»¬å¯èƒ½æœ‰ç€ç›¸ä¼¼çš„äº¤äº’é€»è¾‘ï¼Œæä¾›åŒç±»çš„è¾“å…¥æ•°æ®å’Œè¾“å‡ºæ•°æ®ã€‚å¹¶ä¸”ï¼Œå¯¹äºç”¨æˆ·æ¥è¯´ï¼Œå®ƒä»¬éƒ½åœ¨å¤„ç†åŒä¸€ä¸ªçš„ä¸œè¥¿ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚ä¸€æ¬¾ä¿®å›¾ app ï¼Œå®ƒåŒ…å«äº†ä¸€ç»„ç¼–è¾‘åŠŸèƒ½ï¼Œæ¯ä¸ªåŠŸèƒ½éƒ½ä½œç”¨äºä¸€å¼ å›¾ç‰‡ï¼Œå¤„ç†ä¹‹åçš„å›¾ç‰‡ï¼Œè¿˜å¯ä»¥ä½œä¸ºå…¶ä»–åŠŸèƒ½çš„è¾“å…¥ã€‚ä½œä¸ºç¼–è¾‘å·¥å…·ï¼Œåœ¨æ¯ä¸ªåŠŸèƒ½å†…éƒ¨ï¼Œå¯èƒ½è¿˜éœ€è¦æ”¯æŒæ’¤é”€å’Œé‡åšè¿™æ ·çš„ç”¨æˆ·æ“ä½œã€‚æˆ‘ä»¬å®¹æ˜“æƒ³åˆ°çš„æ˜¯ï¼Œè¿™äº›åŠŸèƒ½é—´å­˜åœ¨ç€è®¸å¤šå¯ä»¥è¿›è¡Œå¤ç”¨è®¾è®¡çš„ä»£ç ã€‚</p>
<p>æœ¬æ–‡åŸºäºä¸€æ¬¡å›é¡¾å‘èµ·ï¼Œå‡ºäºè®°å½•å’Œåˆ†äº«çš„ç›®çš„ï¼šä¸€æ¬¡ä»£ç é‡æ„ï¼Œä¸€æ¬¾ä¹‹å‰æˆ‘å‚ä¸å¼€å‘çš„å›¾åƒå¤„ç†åº”ç”¨ã€‚</p>
<hr>
<h1 id="é‡æ„çš„å…·ä½“èƒŒæ™¯"><a href="#é‡æ„çš„å…·ä½“èƒŒæ™¯" class="headerlink" title="é‡æ„çš„å…·ä½“èƒŒæ™¯"></a>é‡æ„çš„å…·ä½“èƒŒæ™¯</h1><p>è¯·çœ‹ä¸‹é¢è¿™å¹…å›¾ï¼š</p>
<p><img src="/images/black_box.png" alt="æŸä¸ªå›¾åƒåŠŸèƒ½æ¨¡å—çš„ç»“æ„å›¾"></p>
<p>å…ƒç´ ä¸å¤šï¼Œè®©æˆ‘è§£é‡Šä¸€ä¸‹ã€‚å›¾ä¸­çš„ â€œ<strong>å†…å­˜å›¾åƒç®¡ç† + æ•ˆæœå¤„ç†</strong>â€ æ˜¯ä¸€ä¸ª â€œ<strong>é»‘ç›’å­</strong>â€ã€‚â€œé€»è¾‘é»‘ç›’â€ æœ‰çš„æ—¶å€™æ˜¯å¥½äº‹ï¼Œæœ‰çš„æ—¶å€™æ˜¯åäº‹ã€‚é‚£è¿™é‡Œçš„é»‘ç›’å­ç®—å¥½äº‹è¿˜æ˜¯åäº‹å‘¢ï¼Ÿ æ—¢ç„¶å¯¹è¿™ç§è®¾è®¡åšäº†é‡æ„ï¼Œå¤šåŠæ˜¯æœ‰ç—›ç‚¹äº†ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬é‡ç‚¹æ¢è®¨ä¸€ä¸‹å®ƒçš„è´Ÿé¢æ•ˆåº”ã€‚ </p>
<p>åœ¨å…·ä½“ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œè¿™ä¸ªé»‘ç›’å­æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>å›¾åƒå¤„ç†æ¥å£ç²’åº¦å¤ªå¤§ï¼Œéš¾ä»¥å¤ç”¨ä»£ç ï¼›</li>
<li>å›¾åƒ <strong>ç®¡ç†</strong> å’Œå›¾åƒ <strong>æ•ˆæœå¤„ç†</strong> è¢«ç»‘å®šåœ¨ä¸€èµ·ã€‚ä½¿å¾—å¤–éƒ¨éš¾ä»¥çµæ´»çš„æ¥è§¦å’Œä½¿ç”¨å›¾åƒã€‚å¼ºè°ƒä¸€ä¸‹ï¼Œç®¡ç†å’Œæ•ˆæœå¤„ç†æ˜¯ä¸¤ä»¶äº‹ã€‚å‰è€…æ˜¯ç«™åœ¨ç”¨æˆ·çš„è§’åº¦ï¼Œåè€…æ˜¯ç«™åœ¨æœåŠ¡æä¾›è€…çš„è§’åº¦ã€‚æ›´é«˜å±‚åº”ç”¨é€»è¾‘çš„å¼€å‘è€…ï¼Œå¯¹äºæ›´åº•å±‚æ”¯æ’‘ API çš„å¼€å‘è€…æ¥è¯´ï¼Œä¹Ÿæ˜¯ç”¨æˆ·ã€‚</li>
</ul>
<h1 id="â€œç®¡é“â€-æ¦‚å¿µçš„æç‚¼"><a href="#â€œç®¡é“â€-æ¦‚å¿µçš„æç‚¼" class="headerlink" title="â€œç®¡é“â€ æ¦‚å¿µçš„æç‚¼"></a>â€œç®¡é“â€ æ¦‚å¿µçš„æç‚¼</h1><p>é»‘ç›’å­çš„ä¸¤ä¸ªé—®é¢˜åœ¨é‡æ„æ—¶éƒ½å¾—åˆ°äº†è§£å†³ï¼Œä½†ç¬¬ä¸€ä¸ªé—®é¢˜ä¸æœ¬æ–‡è¦åˆ†äº«çš„è®¾è®¡æ€æƒ³å…³è”ä¸å¤§ï¼Œä¸åšå±•å¼€ã€‚</p>
<p>ä¸ºäº†è¯´æ˜æˆ‘ä»¬æ˜¯å¦‚ä½•è§£å†³ç¬¬äºŒä¸ªé—®é¢˜çš„ï¼Œè¿™é‡Œå…ˆå¼•å…¥ä¸¤ä¸ªæ¦‚å¿µï¼šâ€œ<strong>æµæ°´çº¿</strong>â€ å’Œ â€œ<strong>ä¾‹ç¨‹</strong>â€ã€‚ç›¸ä¿¡å¯¹äºä»äº‹ç¼–ç¨‹ç±»å·¥ä½œçš„è¯»è€…æ¥è¯´ï¼Œè¿™ä¸¤ä¸ªè¯ä¸ä¼šé™Œç”Ÿã€‚</p>
<blockquote>
<p><strong>æµæ°´çº¿</strong>  pipelineï¼Œ[è®¡] åˆç§°ç®¡é“ï¼Œç®¡çº¿ã€‚<br><strong>ä¾‹ç¨‹</strong>  routineï¼Œ[è®¡] ç¨‹åºï¼›æ—¥å¸¸å·¥ä½œï¼›ä¾‹è¡Œå…¬äº‹</p>
</blockquote>
<p>åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œ<code>Pipeline</code> ç›¸å½“äºå†…å­˜ä¸­çš„å›¾åƒçŠ¶æ€æœºï¼Œæä¾›äº†åŸºæœ¬çš„å›¾åƒç®¡ç†åŠŸèƒ½ï¼Œä¾‹å¦‚åŠ å…¥å›¾åƒï¼Œåˆ é™¤å›¾åƒï¼Œå¤åˆ¶å›¾åƒï¼Œç§»åŠ¨å›¾åƒï¼Œç­‰ç­‰ã€‚<code>Routine</code> ç›¸å½“äºå„ä¸ªå›¾åƒåŠŸèƒ½å•å…ƒä¸­çš„é€šç”¨äº‹åŠ¡ï¼Œæ¯”å¦‚è¯´ï¼Œå¯¹äºæ¯ä¸ªå›¾åƒåŠŸèƒ½å•å…ƒï¼Œéƒ½éœ€è¦åœ¨å…¶å¼€å§‹è¿ä½œæ—¶ä»æŸå¤„è·å¾—ä¸€ä»½åˆå§‹çš„å›¾åƒï¼Œå¹¶åœ¨å…¶ç»“æŸè¿ä½œæ—¶è¾“å‡ºä¸€ä»½ <strong><em>æœ€ç»ˆçš„</em></strong> å›¾åƒåˆ°å¦ä¸€å¤„ã€‚æˆ‘ä»¬è¿˜çº¦å®šï¼Œ<code>Routine</code> ä¸­çš„äº‹åŠ¡ä¼šåŸºäº <code>Pipeline</code> æ¥å®Œæˆã€‚å¯ä»¥å…·ä½“è§£é‡Šæˆè¿™æ ·ï¼šæ¯ä¸ª <code>Routine</code> éƒ½ä¼šåŒ…å«ä¸€ç»„å…¸å‹çš„å›¾åƒå¤„ç†åŠ¨ä½œï¼Œè¿™äº›å¤„ç†åŠ¨ä½œå€ŸåŠ©ä¸€ä¸ªæˆ–è€…å¤šä¸ª <code>Pipeline</code> çš„é€šç”¨æ“ä½œï¼Œä»¥åŠæ¯ä¸ª <code>Pipeline</code> çš„å·®å¼‚åŒ–æ“ä½œæ¥å®Œæˆï¼ˆåé¢ä¼šå…·ä½“è¯´æ˜è¿™ä¸ª <strong><em>å·®å¼‚åŒ–çš„å›¾åƒå¤„ç†æ­¥éª¤</em></strong>ï¼‰ã€‚</p>
<p>ä»è¿™é‡Œå¼€å§‹ï¼Œæˆ‘ä»¬ä¸å¦¨æŠŠ â€œ<strong>æµæ°´çº¿</strong>â€ çš„å«æ³•ç›´æ¥æ›¿æ¢æˆ â€œ<strong>ç®¡é“</strong>â€ï¼Œå› ä¸ºåé¢ä¼šç”¨åˆ°ä¸€äº›æ¯”å–»æ€§çš„æè¿°ï¼Œæˆ‘ä¸ªäººå®ƒä»¬è§‰å¾—åŸºäº â€œç®¡é“â€ ä¸€è¯è¡ç”Ÿå‡ºæ¥ï¼Œä¼šæ¯”ç”¨ â€œæµæ°´çº¿â€ æ¥å¾—æ›´è‡ªç„¶ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯¹ â€œç®¡é“â€ è¿™ä¸ªæ„è±¡å†åšè¿›ä¸€æ­¥çš„æŒ–æ˜ï¼Œå¯ä»¥è®¾è®¡å‡ºä¸‹é¢è¿™äº›å¯¹åº”å…³ç³»ï¼ˆè¡¨æ ¼ä¸­å·¦ä¾§çš„æ¦‚å¿µåªæ˜¯ä¸€ç§æ¯”å–»ï¼Œè¯»è€…å¯è‡ªè¡Œä½“ä¼šï¼Œè¿™é‡Œä¸ä¼šè¯¦ç»†è§£è¯»ï¼‰</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>æ¯”å–»</th>
<th>åŸå¯¹è±¡ </th>
</tr>
</thead>
<tbody>
<tr>
<td>â€œç®¡é“â€</td>
<td>å›¾åƒçŠ¶æ€æœº</td>
</tr>
<tr>
<td>â€œæµä½“â€</td>
<td>å›¾åƒ</td>
</tr>
<tr>
<td>â€œèŠ‚ç‚¹â€</td>
<td>å›¾åƒçŠ¶æ€</td>
</tr>
<tr>
<td>â€œæµåŠ¨â€</td>
<td>å›¾åƒçŠ¶æ€æµè½¬</td>
</tr>
<tr>
<td>â€œé”‹é¢â€(æµä½“çš„æœ€å‰ç«¯)</td>
<td>å½“å‰æ­£åœ¨å¤„ç†çš„å›¾åƒçŠ¶æ€</td>
</tr>
<tr>
<td>â€œè¿é€šæ€§â€</td>
<td>çŠ¶æ€æœºå†…çš„å›¾åƒä»¥åŠå›¾åƒçŠ¶æ€æœºä¹‹é—´éƒ½æ˜¯å¯ä¸²è”çš„</td>
</tr>
</tbody>
</table>
</div>
<p>â€œæµä½“â€ æ˜¯ä¸€ä¸ªåè¯ï¼Œå®ƒå¯¹åº”çš„æ˜¯å›¾åƒï¼Œæ¶‰åŠåˆ°å­˜å‚¨æ¨¡å‹ã€‚æ ¹æ® â€œæµä½“â€ çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³è±¡ï¼Œæˆ–è€…è¯´æ¨æ–­ï¼Œç®¡é“é‡Œçš„å›¾åƒå­˜å‚¨æ¨¡å‹åº”è¯¥ä¼šè¢«è®¾è®¡ä¸ºå¹³è¡Œç»“æ„ã€‚</p>
<p>è¯·è¯»è€…è”æƒ³ä¸€ä¸ªç±»æ¯”ï¼Œ &lt;__åŒ–å¦† / æ•´å®¹  VS  è½¯ä»¶ä¸Šç¾åŒ–ç…§ç‰‡ä¸Šçš„äººè„¸__&gt; ï¼Œå†æ€è€ƒä¸€ä¸‹ï¼Œä¸¤è€…åœ¨å­˜å‚¨æ¨¡å‹å’Œå·¥åºè¿™ä¸¤ä¸ªæ–¹é¢æœ‰ä»€ä¹ˆå¼‚åŒï¼Ÿ </p>
<p>å›åˆ°æ­£é¢˜ï¼Œæˆ‘é…äº†äº”å¹…å›¾æ¥æè¿°ç®¡é“åœ¨å…·ä½“å®ç°ä¸­çš„äº”ä¸ªç‰¹æ€§ï¼š</p>
<ol>
<li>â€œæµä½“â€ ç”±ä¸€ç³»åˆ— â€œèŠ‚ç‚¹â€ ç»„æˆã€‚â€œèŠ‚ç‚¹â€ï¼Œå³å›¾åƒçš„çŠ¶æ€ï¼Œå®ƒçš„å«ä¹‰æ„æˆäº†æˆ‘ä»¬å¯¹æŸä¸€ä¸ªå›¾åƒçš„æœ¬å¾æ€§è®¤çŸ¥ã€‚é€šä¿—åœ°è®²ï¼Œå›¾åƒçŠ¶æ€èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬åœ¨ç‰¹å®šçš„åœºæ™¯ä¸‹æŠŠä¸åŒçš„å›¾åƒåŒºåˆ†å¼€æ¥ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæœ‰ååŒå¼€å‘çš„ä¸¤ä½ç¨‹åºå‘˜ï¼Œå¯¹äº â€œç¾é¢œâ€ å’Œ â€œæ»¤é•œâ€ è¿™ä¸¤ä¸ªæ­¥éª¤çš„è®¤çŸ¥è¾¾æˆäº†å…±è¯†ã€‚äºæ˜¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥å»ºç«‹ä¸¤ä¸ªèŠ‚ç‚¹ï¼šâ€œç¾é¢œâ€ã€â€œæ»¤é•œâ€ï¼Œç„¶ååœ¨å¼€å‘è¿‡ç¨‹ä¸­ä½¿ç”¨è¿™ä¸¤ä¸ªèŠ‚ç‚¹æ¥ <em>åä½œ</em> ã€‚æ³¨æ„ï¼Œå›¾åƒçŠ¶æ€ä¸æ˜¯å›¾åƒæœ¬èº«ã€‚å¯¹äºå›¾åƒçŠ¶æ€çš„ä»£ç å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæè½»é‡çš„æ•°æ®ç»“æ„ â€”â€” å­—ç¬¦ä¸²ã€‚å®ƒä½“ç°çš„æ˜¯ <strong>å ä½ç¬¦æ€æƒ³</strong>ï¼Œè€Œæˆ‘æƒ³è¦å¼ºè°ƒå ä½ç¬¦çš„ä¸‰ä¸ªé‡è¦å¥½å¤„ï¼šå®ƒä»¬æ˜¯ <strong>å¯é¢„è§çš„</strong>ï¼ˆåŸºäºè®¤çŸ¥å…±è¯†ï¼‰ã€<strong>å¯é¢„ç½®çš„</strong>ï¼ˆå¾ˆè½»é‡ï¼‰ã€<strong>å¯å›ºåŒ–çš„</strong>ï¼ˆå¯å¤ç”¨ä»£ç çš„ä¸€ä¸ªå†…åœ¨è¦æ±‚ï¼‰ã€‚</li>
</ol>
<p><img src="/images/nodes.png" alt="èŠ‚ç‚¹åŠåŒä½èŠ‚ç‚¹"></p>
<ol>
<li>â€œç®¡é“â€ é€šè¿‡è¡”æ¥ â€œèŠ‚ç‚¹â€ æ„æˆ â€œè¿é€šâ€ã€‚åœ¨ â€œèŠ‚ç‚¹â€ ä¸­ï¼Œæœ‰å¿…è¦ç‰¹åˆ«ä»‹ç»çš„æ˜¯ â€œåŒä½èŠ‚ç‚¹â€ã€‚å®ƒæŒ‡çš„æ˜¯ï¼šå‡ ä¸ªæ­¥éª¤åœ¨ <strong>åŒä¸€ä¸ªå›¾åƒ</strong> ä¸Šå…ˆåå‘ç”Ÿã€‚åœ¨æ—¶é—´ä¸Šæœ‰å…ˆåï¼Œä½†åœ¨ç©ºé—´ä¸Šå§‹ç»ˆæ“ä½œåŒä¸€ä»½å­˜å‚¨ã€‚æˆ‘åé¢ä¼šå†ç”¨åˆ°è¿™ä¸ªæè¿°ã€‚</li>
</ol>
<p><img src="/images/connectivity.png" alt="è¿é€šæ€§"></p>
<ol>
<li><p>â€œæµåŠ¨â€ çš„ â€œæµä½“â€ ä¼šæœ‰ä¸€ä¸ª <strong>æœ€å‰éƒ¨</strong> ï¼Œå°±å¥½åƒæ°´æµçš„æœ€å‰ç«¯ï¼Œåˆç§°ä¸º â€œé”‹é¢â€ (Waterfront)ï¼Œå¯¹åº”ç€è¿™æ ·ä¸€ä¸ªäº‹å®ï¼šâ€œç®¡é“â€ ä¸­æ‰€æœ‰çš„å›¾åƒï¼Œåœ¨åŒä¸€æ—¶é—´é‡Œï¼Œåªä¼šæœ‰ <strong>å”¯ä¸€çš„</strong> å›¾åƒå¤„äº <strong>å¯æ“ä½œ</strong> çš„çŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä»£è¡¨ç€ <strong>å›¾åƒçš„å˜åŒ–è¶‹åŠ¿</strong> ã€‚å…·ä½“åˆ°ä»£ç å®ç°ï¼Œå¯èƒ½ä¼šæ˜¯ä¸€ç»„å¸¦æœ‰ <em> åŒæ­¥å…³é”®å­— </em> çš„æ–¹æ³•ï¼ŒåŠ ä¸Šä¸€ä¸ªå”¯ä¸€çš„æŒ‡å‘å½“å‰çŠ¶æ€çš„æŒ‡é’ˆã€‚æˆ‘ä»¬é€šè¿‡ <strong>å¼•å¯¼</strong> å’Œ <strong>æ“åˆ€</strong> è¿™ä¸ªè¶‹åŠ¿ï¼ŒæŠŠå›¾åƒ â€œå¼•å‘â€ æœ€ç»ˆè¦å‘ˆç°å‡ºæ¥çš„æ ·å­ã€‚åœ¨å›¾ç¤ºä¸­ï¼Œæˆ‘æœ‰æ„ä½¿ç”¨äº†ç»¿è‰²ä»£è¡¨åŸå§‹çš„ã€æœ€åˆçš„ï¼Œä½¿ç”¨çº¢è‰²ä»£è¡¨æˆç†Ÿçš„ã€å®Œå…¨ä½“çš„ã€‚<code>Pipeline</code> ä¸“æ³¨äºåšä¸€ä»¶äº‹ï¼šæŠŠå›¾åƒä»ä¸€ç§çŠ¶æ€è½¬åŒ–ä¸ºå¦å¤–ä¸€ç§çŠ¶æ€ã€‚è¿™æœŸé—´ï¼Œå¯èƒ½è¦ç»å†å¤šä¸ª â€œèŠ‚ç‚¹â€ï¼Œè€Œ â€œé”‹é¢â€ çš„æ„ä¹‰å°±åœ¨äºï¼Œå®ƒä¿è¯äº†ä¸€ä»¶äº‹ã€‚é‚£å°±æ˜¯ <code>Pipeline</code> çš„æ“åˆ€è€…å¯ä»¥ç¡®ä¿¡ï¼Œè¿™ä¸€åˆ»åªæœ‰ä»–è‡ªå·±åœ¨å¼•å¯¼å›¾åƒçš„ â€œæµå‘â€ï¼Œæ²¡æœ‰äººä¼šå¹²æ‰°åˆ°ä»–ã€‚</p>
<p><img src="/images/waterfront.png" alt="é”‹é¢"></p>
</li>
<li><p>â€œæµåŠ¨â€ å¯ä»¥æ˜¯åŒå‘çš„ï¼ˆç›¸æ¯”ç”Ÿäº§è½¦é—´çš„ â€œæµæ°´çº¿â€ï¼Œâ€œç®¡é“â€ ä¹‹æ‰€ä»¥æ›´è´´åˆ‡ï¼Œåœ¨äºåè€…å¯ä»¥å®ç°åŒå‘çš„æµåŠ¨ï¼Œå¯¹åº”åˆ°å›¾åƒï¼Œç›¸å½“äºå®ç°åå‘ç¼–è¾‘ï¼Œæˆ–è€…è¯´æ’¤é”€åˆ°ä¸€ä¸ªå¤„ç†æ­¥éª¤ä¹‹å‰çš„çŠ¶æ€ï¼‰</p>
</li>
<li><p>â€œæµä½“â€ å¦‚æœ â€œåˆ†æµâ€ï¼Œåˆ™å¯ä»¥å‡ºç°å¤šä¸ª â€œé”‹é¢â€ï¼Œå¯¹åº”ç€å›¾åƒçš„ <strong>å¹¶è¡Œå¤„ç†</strong> ã€‚</p>
<p><img src="/images/shunt.png" alt="åˆ†æµ"></p>
</li>
</ol>
<h1 id="â€œç®¡é“â€-çš„å…·ä½“å®ç°"><a href="#â€œç®¡é“â€-çš„å…·ä½“å®ç°" class="headerlink" title="â€œç®¡é“â€ çš„å…·ä½“å®ç°"></a>â€œç®¡é“â€ çš„å…·ä½“å®ç°</h1><p>å¦‚å‰æ‰€è¿°ï¼Œâ€œæµä½“â€ å…¶å®å°±æ˜¯å›¾åƒï¼Œç®€å•å°è£…å³å¯ã€‚æˆ‘ä»¬ä¸»è¦å®ç°çš„æ˜¯ â€œ<strong>èŠ‚ç‚¹</strong>â€ã€â€œ<strong>é”‹é¢</strong>â€ã€ â€œ<strong>æµåŠ¨</strong>â€ å’Œ â€œ<strong>è¿é€š</strong>â€ã€‚</p>
<h2 id="èŠ‚ç‚¹çš„å®ç°æ–¹æ¡ˆå’Œæ„ä¹‰"><a href="#èŠ‚ç‚¹çš„å®ç°æ–¹æ¡ˆå’Œæ„ä¹‰" class="headerlink" title="èŠ‚ç‚¹çš„å®ç°æ–¹æ¡ˆå’Œæ„ä¹‰"></a>èŠ‚ç‚¹çš„å®ç°æ–¹æ¡ˆå’Œæ„ä¹‰</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ç§å…¸å‹çš„å›¾åƒå¤„ç†è¿‡ç¨‹ä¸­å¯èƒ½ä¼šé‡‡ç”¨çš„å†™æ³•ï¼Œä»£ç ä¸º swift å®ç°ï¼š</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å›¾åƒ xyz</span></span><br><span class="line"><span class="keyword">var</span> xyz: <span class="type">MyImage</span></span><br><span class="line"><span class="comment">// å›¾åƒ ijk</span></span><br><span class="line"><span class="keyword">var</span> ijk: <span class="type">MyImage</span></span><br><span class="line"><span class="comment">// å›¾åƒ abc </span></span><br><span class="line"><span class="keyword">var</span> abc: <span class="type">MyImage</span></span><br></pre></td></tr></tbody></table></figure>
<p>å½“ç„¶ï¼Œç°ä»£ç¼–ç¨‹è¯­è¨€çš„è¯­æ³•ç‰¹æ€§ï¼Œå¯ä»¥è®©ä½ çœå»å†™å„ç§ getter/setter çš„æ ·æ¿ä»£ç ï¼Œä»è€ŒèŠ‚çœä»£ç é‡ã€‚ä½†è¿™ä¸æ˜¯é‡ç‚¹ï¼Œé‡ç‚¹åœ¨äº â€”â€” ä¸Šè¿°è¿™ç§ä»£ç æ— æ³•å¤ç”¨ã€‚å› ä¸ºæ¯ä¸€ä¸ªå›¾åƒçš„å¼•ç”¨éƒ½è¢«èµ‹äºˆäº† <strong>å…·ä½“</strong> çš„å«ä¹‰ï¼šåŒæ ·çš„å†™æ³•ä¸å¤ªå¯èƒ½å®Œå…¨åœ°é€‚ç”¨äºå¦å¤–ä¸€ä¸ªå›¾åƒå¤„ç†åœºæ™¯ã€‚æ¯”å¦‚è¯´ï¼Œå¦å¤–é‚£ä¸ªå›¾åƒå¤„ç†åœºæ™¯å¾ˆå¯èƒ½ä¸ä¼šç”¨åˆ°æè¿°ä¸º ijk çš„å›¾åƒï¼Œå¯èƒ½ä¼šç”¨åˆ°æè¿°æ˜¯ uvw çš„å›¾åƒã€‚å› æ­¤ï¼Œé‡‡å–è¿™ç§å†™æ³•ä¼šé‡åˆ°çš„ä¸€ä¸ªå…¸å‹é—®é¢˜æ˜¯ï¼šæ¯æ–°å¢ä¸€ä¸ªå›¾åƒå¤„ç†åœºæ™¯ï¼Œæˆ‘ä»¬éƒ½éœ€è¦æ–°å¢è‹¥å¹²ä¸ªç‰¹å®šæè¿°çš„å›¾åƒå£°æ˜ã€‚åœ¨ç¼–ç å±‚é¢ï¼Œè¿™æ— ç–‘æ˜¯ä¸€é¡¹ç¹å†—çš„å·¥ä½œã€‚</p>
<p>ä¸Šé¢è¯´çš„å›¾åƒå¼•ç”¨ï¼Œå…¶å®æ­£æ˜¯æˆ‘ä»¬çš„å›¾åƒ â€œç®¡é“â€ é‡Œçš„æŸä¸ª â€œèŠ‚ç‚¹â€ã€‚æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœè¦å¯¹ â€œèŠ‚ç‚¹â€ å®ç°ä»£ç å¤ç”¨ï¼Œä½ ä¼šæ€ä¹ˆåšï¼Ÿç¨å¾®æç¤ºä¸€ä¸‹ï¼Œå…³é”®åœ¨äº â€œ<strong>å…·ä½“</strong>â€ è¿™ä¸¤ä¸ªå­—ã€‚</p>
<p>æ˜¯çš„ï¼Œå¦‚æœæˆ‘ä»¬èƒ½æƒ³åˆ°ï¼Œä¸Šé¢çš„å†™æ³•ä¸­ä»£ç ä¹‹æ‰€ä»¥ä¸èƒ½å¤ç”¨ï¼Œæ ¹æºåœ¨äºå›¾åƒå¼•ç”¨çš„ç”¨é€”å·²ç»è¢« <strong>å…·ä½“å®šä¹‰</strong>ï¼ˆåŒæ—¶ä¹Ÿæ˜¯è¢«å…·ä½“ <strong>çº¦æŸ</strong>ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ›´æœ‰å¯èƒ½å¾€è¿™æ ·ä¸€ä¸ªæ–¹å‘æ€è€ƒé—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼šèƒ½ä¸èƒ½æŠŠå›¾åƒå¼•ç”¨ â€œå»å…·ä½“åŒ–â€ ï¼Œè®©å®ƒçš„å«ä¹‰åœ¨å…·ä½“åœºæ™¯åˆ°æ¥æ—¶æ‰è¢«èµ‹äºˆå‘¢ï¼Ÿ</p>
<p>è®²åˆ°è¿™ä¸€å±‚ï¼Œæœ‰äº›è¯»è€…å¯èƒ½å·²ç»æƒ³åˆ°ä¸€ç§æ•°æ®ç»“æ„ â€”â€” å­—å…¸ã€‚æ˜¯çš„ï¼Œæ²¡æœ‰ä»€ä¹ˆå¥‡æ·«å·§æŠ€ï¼Œåªç”¨å­—å…¸ï¼Œå°±èƒ½å®ç° â€œå»å…·ä½“åŒ–â€ï¼Œè§£å†³è¿™ä¸ªä»£ç å¤ç”¨é—®é¢˜ä¸­çš„æœ€å¤§éšœç¢ â€”â€” æ—¢ç„¶æ— æ³•é¢„çŸ¥æˆ‘ä»¬å¯èƒ½éœ€è¦å¤„ç†ä»€ä¹ˆæ ·çš„å›¾åƒï¼Œå¯èƒ½éœ€è¦å¤„ç†å¤šå°‘ä»½å›¾åƒï¼Œå¹¶ä¸”è¿™äº›æœªçŸ¥æ•°æ€»æ˜¯æ˜“å˜çš„ï¼Œé‚£ä¸ºä»€ä¹ˆä¸è®©å…·ä½“åœºæ™¯çš„ä½¿ç”¨è€…æ¥ <strong>åŠ¨æ€æ·»åŠ </strong> è¿™äº›å›¾åƒå¼•ç”¨ï¼Œå¹¶ä¸”ä¸ºå®ƒä»¬å…·åå‘¢ï¼Ÿå›¾åƒéƒ¨åˆ†è¢«å¤ç”¨çš„ä»£ç ï¼Œè¿™é‡Œåªå£°æ˜äº†ä¸€æ ·ä¸œè¥¿ï¼Œå°±æ˜¯ä»å›¾åƒçŠ¶æ€è¡¨è¿°åˆ°å›¾åƒå¼•ç”¨çš„æ˜ å°„è¡¨ã€‚å®ƒæä¾›äº†ä¸€ä¸ªä¹‹å‰çš„å†™æ³•ä¸å…·å¤‡çš„ç‰¹ç‚¹ï¼Œè€Œè¿™ä¸ªç‰¹ç‚¹æ˜¯è¾¾æˆå¤ç”¨çš„å¿…è¦å‰æï¼šå›¾åƒå­˜å–çš„æ–¹å¼æ˜¯ <strong>ç»Ÿä¸€çš„</strong>ï¼Œ<strong>æœ‰é™çš„</strong>ï¼Œä»è€Œæ˜¯ <strong>å¯å›ºåŒ–çš„</strong>ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> stateTagToImageMap = [<span class="type">String</span>:<span class="type">MyImage</span>]()</span><br></pre></td></tr></tbody></table></figure>
<p>æˆ‘ä»¬ç”¨ä¸€ä¸ª <strong>å­—ç¬¦ä¸²æ ‡ç­¾</strong> æ¥è¡¨ç¤ºå›¾åƒçš„çŠ¶æ€ã€‚å¯¹äºå›¾åƒ â€œç®¡é“â€ çš„ä½¿ç”¨è€…æ¥è¯´ï¼Œä»–åªéœ€è¦ç†è§£æ¯ä¸ªæ ‡ç­¾çš„å«ä¹‰ï¼Œé€šè¿‡æ ‡ç­¾æ¥å­˜å–å›¾åƒå¹¶è¿›è¡Œå¤„ç†ã€‚åœ¨è¿™äº›æ ‡ç­¾ä¸­ï¼Œæˆ‘ä»¬å†æç‚¼å‡ºå‡ ä¸ªå…·æœ‰é€šç”¨å«ä¹‰çš„ä»£è¡¨æ€§æ ‡ç­¾ï¼šæ¯”å¦‚ï¼Œ<code>original</code> ä»£è¡¨ â€œ<strong>æœ€åˆçš„</strong>â€ï¼Œ<code>processed</code> ä»£è¡¨ â€œ<strong>åŠ å·¥å®Œæˆçš„</strong>â€ï¼Œè¿™æ­£æ˜¯å‰æ–‡æåˆ°çš„ <strong>å ä½ç¬¦</strong> ã€‚å®¹æ˜“ç†è§£ï¼Œåœ¨ä¸€ä»½å¯å¤ç”¨çš„ä»£ç åº“ä¸­ï¼Œä½ å¯ä»¥å£°æ˜å¹¶ä¸”é¢„ç½®è®¸å¤š <strong>å ä½ç¬¦</strong> ã€‚ä½†ä½ ä¸ä¼šåœ¨è¿™ä¸ªä»£ç åº“é‡Œå£°æ˜åŒæ ·æ•°é‡çš„å›¾åƒå¼•ç”¨ â€”â€” è¿™æ ·å¾ˆå¥‡æ€ªå¯¹å§ï¼Ÿå“ªæ€•ä»ç¨‹åºå®ç°çš„è§’åº¦æ¥è¯´ï¼Œæ²¡æœ‰åˆ†é…å®é™…ç©ºé—´çš„å¼•ç”¨å¹¶ä¸ä¸€å®šä¼šå æ®æ›´å¤šçš„å†…å­˜ã€‚åœ¨åé¢åˆ—ä¸¾çš„ä»£ç èŒƒä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä¼šç»å¸¸åœ°ç”¨åˆ° <code>original</code> å’Œ <code>processed</code> è¿™æ ·çš„æ ‡ç­¾ã€‚</p>
<p>ä¸å¦¨é˜…è¯»ä¸‹é¢è¿™æ®µä»£ç ï¼Œè¿™å°±æ˜¯ä¸€ç§ä½¿ç”¨æ ‡ç­¾æ¥æ“ä½œå¯¹åº”å›¾åƒçš„å†™æ³•ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ˜¾ç¤ºä¸¤ä¸ªå¤„ç†æ­¥éª¤ä¹‹åçš„å›¾åƒ </span></span><br><span class="line">pipeline.from (.original) <span class="comment">// ä»åŸå§‹çš„å›¾åƒå¼€å§‹ </span></span><br><span class="line">        .copyTo (.processed) <span class="comment">// æ‹·è´å‡ºä¸€ä»½å›¾åƒç”¨äºå¤„ç†ï¼Œå¯¹åº”æ ‡ç­¾ processed</span></span><br><span class="line">        .doProcess (tag: .processed, specificProcess1)  <span class="comment">// åœ¨ processed ä¸Šæ‰§è¡Œå¤„ç† 1</span></span><br><span class="line">        .doProcess (tag: .processed, specificProcess2) <span class="comment">// åœ¨ processed ä¸Šæ‰§è¡Œå¤„ç† 2</span></span><br><span class="line"></span><br><span class="line">showImage (pipeline.fetch (.processed)) <span class="comment">// å–å¾— processed æ ‡ç­¾ä»£è¡¨çš„å›¾åƒå¹¶ä¸”å±•ç¤º </span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="é”‹é¢çš„å®ç°æ–¹æ¡ˆå’Œæ„ä¹‰"><a href="#é”‹é¢çš„å®ç°æ–¹æ¡ˆå’Œæ„ä¹‰" class="headerlink" title="é”‹é¢çš„å®ç°æ–¹æ¡ˆå’Œæ„ä¹‰"></a>é”‹é¢çš„å®ç°æ–¹æ¡ˆå’Œæ„ä¹‰</h2><p>è§£å†³äº† â€œèŠ‚ç‚¹â€ çš„è®¾è®¡ï¼Œæˆ‘ä»¬å†æ¥çœ‹åŸºäº â€œèŠ‚ç‚¹â€ æç‚¼å‡ºæ¥çš„ â€œé”‹é¢â€ è¦æ€ä¹ˆè®¾è®¡ã€‚å®¹æ˜“ç†è§£ï¼Œâ€œ<strong>é”‹é¢</strong>â€ æ˜¯æœ€å‰é¢çš„é‚£ä¸ª â€œèŠ‚ç‚¹â€ ï¼Œå…·æœ‰ <strong>å”¯ä¸€æ€§</strong>ï¼Œå¯¹åº”å…·ä½“çš„å›¾åƒå¤„ç†ä»£ç ä¸­å°±æ˜¯ â€œå½“å‰æ­£åœ¨è¢«å¤„ç†çš„é‚£ä¸ªå›¾åƒâ€ã€‚åœ¨è®¾è®¡å›¾åƒç®¡é“å¯¹å¤–æä¾›çš„å¤„ç† API æ—¶ï¼Œæˆ‘ä»¬çº¦å®šå¤„ç†åŠ¨ä½œä¸€å®šåªèƒ½å‘ç”Ÿåœ¨è¿™ä¸ª â€œ<strong>å½“å‰çš„</strong>â€ å›¾åƒä¸Šï¼Œè¿™æ ·å°±èƒ½å¤Ÿä¿è¯æˆ‘ä»¬çš„ â€œå›¾åƒæµâ€ æ€»æ˜¯æŒ‰ç…§æˆ‘ä»¬æƒ³è¦çš„æ–¹å‘æµåŠ¨ï¼Œå¹¶ä¸”åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œâ€œå›¾åƒæµâ€ æ˜¯ä¸ä¼šè¢«ç¯¡æ”¹çš„ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¬çš„å›¾åƒç¼–è¾‘åŠŸèƒ½è¦å®ç°æ’¤é”€å’Œé‡åšåŠŸèƒ½çš„åŸºæœ¬å‰æã€‚</p>
<p>è¿˜æ˜¯ä¸Šé¢é‚£æ®µä»£ç ï¼Œç°åœ¨å¯ä»¥å»æ‰å®é™…å¤„ç†æ­¥éª¤çš„æ ‡ç­¾å‚æ•°ã€‚å› ä¸ºæˆ‘ä»¬çº¦æŸäº†å¤„ç†åªèƒ½å‘ç”Ÿåœ¨ <strong>å”¯ä¸€çš„</strong>ã€<strong>å½“å‰çš„</strong> å›¾åƒä¸Šã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ˜¾ç¤ºä¸€ä¸ªå¤„ç†æ­¥éª¤ä¹‹åçš„å›¾åƒ </span></span><br><span class="line">pipeline.from (.original) <span class="comment">// ä»åŸå§‹çš„å›¾åƒå¼€å§‹ </span></span><br><span class="line">        .copyTo (.processed) <span class="comment">// æ‹·è´å‡ºä¸€ä»½å›¾åƒç”¨äºå¤„ç†ï¼Œå¯¹åº”æ ‡ç­¾ processed</span></span><br><span class="line">        .doProcess (specificProcess1) <span class="comment">// éšå«äº†åœ¨ processed ä¸Šæ‰§è¡Œå¤„ç† 1</span></span><br><span class="line">        .doProcess (specificProcess2) <span class="comment">// éšå«äº†åœ¨ processed ä¸Šæ‰§è¡Œå¤„ç† 2</span></span><br><span class="line"></span><br><span class="line">showImage (pipeline.fetch (.processed)) <span class="comment">// å–å¾— processed æ ‡ç­¾ä»£è¡¨çš„å›¾åƒå¹¶ä¸”å±•ç¤º </span></span><br></pre></td></tr></tbody></table></figure>
<p>å¦‚æœè¦æ±‚èƒ½å¤Ÿå›æ’¤åˆ°ç¬¬ä¸€ä¸ªå¤„ç†æ­¥éª¤ä¹‹åçš„çŠ¶æ€ï¼Œå†åšç¬¬äºŒä¸ªå¤„ç†æ­¥éª¤ï¼Œå¹¶ä¸”ç¬¬äºŒä¸ªå¤„ç†æ­¥éª¤çš„å‚æ•°æ˜¯å¯ä»¥æ”¹å˜çš„ã€‚å¯ä»¥è¿™ä¹ˆåšï¼š</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ˜¾ç¤ºä¸€ä¸ªå¤„ç†æ­¥éª¤ä¹‹åçš„å›¾åƒï¼Œä½†æˆ‘ä»¬åœ¨è¿‡ç¨‹ä¸­ä¿ç•™äº†ç¬¬ä¸€ä¸ªæ­¥éª¤çš„çŠ¶æ€ </span></span><br><span class="line">pipeline.from (.original)</span><br><span class="line">        .copyTo (<span class="string">"specificProcess1"</span>) <span class="comment">// ç›¸æ¯”ä¸€æ­¥åˆ°ä½ï¼Œè¿™é‡Œå¤šå­˜å‚¨äº†ç¬¬ä¸€ä¸ªæ­¥éª¤çš„çŠ¶æ€ </span></span><br><span class="line">        .doProcess (specificProcess1)</span><br><span class="line">        .copyTo (.processed)</span><br><span class="line">        .doProcess (specificProcess2.setParams (params1))</span><br><span class="line"></span><br><span class="line">showImage (pipeline.fetch (.processed))</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒæ•´ç¬¬äºŒä¸ªæ­¥éª¤çš„æŸäº›å‚æ•°ï¼Œé‡æ–°æ˜¾ç¤ºå›¾åƒ </span></span><br><span class="line">pipeline.from (<span class="string">"specificProcess1"</span>) <span class="comment">// ä¹‹å‰å­˜å‚¨äº†ç¬¬ä¸€ä¸ªæ­¥éª¤çš„çŠ¶æ€ï¼Œç›´æ¥ä»è¿™ä¸ªæ­¥éª¤å¼€å§‹ </span></span><br><span class="line">        .copyTo (.processed)</span><br><span class="line">        .doProcess (specificProcess2.setParams (params2))</span><br><span class="line"></span><br><span class="line">showImage (pipeline.fetch (.processed))</span><br></pre></td></tr></tbody></table></figure>
<h2 id="æµåŠ¨å’Œè¿é€šæ€§çš„å®ç°æ–¹æ¡ˆ"><a href="#æµåŠ¨å’Œè¿é€šæ€§çš„å®ç°æ–¹æ¡ˆ" class="headerlink" title="æµåŠ¨å’Œè¿é€šæ€§çš„å®ç°æ–¹æ¡ˆ"></a>æµåŠ¨å’Œè¿é€šæ€§çš„å®ç°æ–¹æ¡ˆ</h2><p>æœ‰äº† â€œèŠ‚ç‚¹â€ å’Œ â€œé”‹é¢â€ï¼Œâ€œæµåŠ¨â€ å’Œ â€œè¿é€šâ€ å°±æœ‰äº†ä½œç”¨çš„ä¸»ä½“ã€‚å¯¹åº”åˆ°å›¾åƒç¼–è¾‘åŠŸèƒ½ï¼Œâ€œ<strong>æµåŠ¨</strong>â€ å…¶å®å°±æ˜¯å›¾åƒä»ä¸€ä¸ªçŠ¶æ€å˜æˆå¦å¤–ä¸€ä¸ªçŠ¶æ€çš„è¿‡ç¨‹ã€‚â€œ<strong>è¿é€š</strong>â€ åˆ™æ›´å¥½ç†è§£ï¼Œä¸€ä¸ªç®¡é“å‡ºæ¥çš„å›¾åƒå¯ä»¥è¢«å¦å¤–ä¸€ä¸ªç®¡é“æ¥çº³ï¼Œç”±æ­¤æ„æˆç®¡é“ä¹‹é—´çš„è¿æ¥ã€‚è¿æ¥åœ¨ä¸€èµ·çš„æ¯ä¸€èŠ‚ â€œ<strong>å°ç®¡é“</strong>â€ å„å¸å…¶èŒï¼Œçµæ´»ç»„åˆï¼Œå†æ„æˆæ›´é•¿è·¨åº¦çš„ â€œ<strong>å¤§ç®¡é“</strong>â€ æˆ–è€… â€œ<strong>ç®¡é“ç½‘ç»œ</strong>â€ï¼Œä»è€ŒååŒå®Œæˆå¤æ‚çš„ä¸šåŠ¡æµç¨‹ã€‚</p>
<p>å›å½’åˆ°ä»£ç ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ç»„æ­¥éª¤ç¨å¤šçš„å›¾ç‰‡å¤„ç†å·¥åºï¼Œçœ‹å®ƒæ˜¯å¦‚ä½•ä½“ç°å‡ºç®¡é“çš„ â€œæµåŠ¨æ€§â€ å’Œ â€œè¿é€šæ€§â€ã€‚åˆ¨å»å†…éƒ¨çš„å®ç°ç»†èŠ‚ï¼Œæ•´åˆæˆ–è€…å¿½ç•¥ä¸€äº›ä¸ç®¡é“è®¾è®¡æ€æƒ³å…³è”ä¸å¤§çš„é€»è¾‘ï¼Œä»¥ä¸‹ä»£ç åœ¨æµç¨‹ä¸Šç®—æ˜¯æ¯”è¾ƒæ¥è¿‘å®é™…ç”Ÿäº§ç¯å¢ƒäº†ã€‚è™½ç„¶é‡‡ç”¨çš„æ˜¯ä¼ªä»£ç ï¼Œç›¸ä¿¡è¯»è€…å¯ä»¥çœ‹æ‡‚ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** ä¸»åŠŸèƒ½åŒºï¼Œä¸å¦¨å°†å®ƒçš„ä¾‹ç¨‹ç§°ä¸º Main</span></span><br><span class="line"><span class="comment"> * åŸºæœ¬åŠŸèƒ½ï¼š</span></span><br><span class="line"><span class="comment"> * 1. å±•ç¤ºå›¾åƒ </span></span><br><span class="line"><span class="comment"> * 2. å¯ä»¥ä»è¿™é‡Œè¿›å…¥å„å­åŠŸèƒ½å¤„ç†å›¾ç‰‡å†å›åˆ°è¿™é‡Œå±•ç¤ºæ–°çš„å›¾ç‰‡ </span></span><br><span class="line"><span class="comment"> * 3. æ’¤é”€åˆ°ç»è¿‡æŸä¸ªæ­¥éª¤å¤„ç†ä¹‹å‰çš„å›¾åƒæˆ–è€…é‡åšå‡ºä¹‹å‰åšè¿‡ä½†æ˜¯è¢«æ’¤é”€æ‰çš„æŸä¸ªæ­¥éª¤çš„å›¾åƒ   </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">RoutineMain</span>.startFrom (imageFile) {</span><br><span class="line">    <span class="type">RoutineMain</span>.pipeline.loadFrom (imageFile, .original) <span class="comment">// ä»å›¾ç‰‡ä¸­åŠ è½½åˆå§‹çš„å›¾åƒ </span></span><br><span class="line">}</span><br><span class="line"><span class="type">RoutineMain</span>.showCurrent () {</span><br><span class="line">    showImage (<span class="type">RoutineMain</span>.pipeline.front () <span class="comment">// æ˜¾ç¤º â€œé”‹é¢â€</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/** è¿›å…¥åˆ°ä¸€ä¸ªå« â€œç¾å‹â€ çš„åŠŸèƒ½åŒºï¼Œå¯¹åº”çš„ä¾‹ç¨‹ç§°ä¸º FaceLift</span></span><br><span class="line"><span class="comment"> * åŸºæœ¬åŠŸèƒ½ï¼š</span></span><br><span class="line"><span class="comment"> * 1. å±•ç¤ºå›¾åƒ </span></span><br><span class="line"><span class="comment"> * 2. é’ˆå¯¹å›¾åƒä¸­çš„äººè„¸è½®å»“ï¼Œäº”å®˜è¿›è¡Œå½¢çŠ¶è°ƒæ•´ </span></span><br><span class="line"><span class="comment"> * 3. è¾“å‡ºå¤„ç†åçš„å›¾åƒåˆ°ä¸»åŠŸèƒ½åŒº </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">RoutineFaceLift</span>.startFrom (<span class="type">RoutineMain</span>.pipeline.front ().copy ())</span><br><span class="line"><span class="type">RoutineFaceLift</span>.process () {</span><br><span class="line">    <span class="type">RoutineFaceLift</span>.pipeline</span><br><span class="line">         <span class="comment">// è¿™ä¸ªè¿‡ç¨‹ç”¨æˆ·æ— æ³•å¹²é¢„ï¼Œä¸ä¼šæœ‰ â€œé‡åšâ€ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨åŸç¨¿ä¸Šæ“ä½œ </span></span><br><span class="line">        .from (.original)</span><br><span class="line">        .doProcess (faceLift_step_1_process)</span><br><span class="line">        .doProcess (faceLift_step_2_process)</span><br><span class="line">        .doProcess (faceLift_step_3_process)</span><br><span class="line">        ...</span><br><span class="line">}</span><br><span class="line"><span class="comment">// æŠŠå­åŠŸèƒ½ â€œç¾å‹â€ å¤„ç†å¥½çš„å›¾åƒæäº¤ç»™ä¸»åŠŸèƒ½ </span></span><br><span class="line"><span class="type">RoutineMain</span>.accept (<span class="type">RoutineFaceLift</span>.commit ())</span><br><span class="line"></span><br><span class="line"><span class="comment">/** è¿›å…¥åˆ°ä¸€ä¸ªå« â€œæ»¤é•œâ€ çš„åŠŸèƒ½åŒºï¼Œå¯¹åº”çš„ä¾‹ç¨‹ç§°ä¸º Filter</span></span><br><span class="line"><span class="comment"> * åŸºæœ¬åŠŸèƒ½ï¼š</span></span><br><span class="line"><span class="comment"> * 1. å±•ç¤ºå›¾åƒ </span></span><br><span class="line"><span class="comment"> * 2. æ»¤é•œåŒ–å¤„ç†å›¾åƒ </span></span><br><span class="line"><span class="comment"> * 3. è¾“å‡ºå¤„ç†åçš„å›¾åƒåˆ°ä¸»åŠŸèƒ½åŒº </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">RoutineFilter</span>.startFrom (<span class="type">RoutineMain</span>.pipeline.front ().copy ());</span><br><span class="line"><span class="type">RoutineFilter</span>.process () {</span><br><span class="line">    <span class="type">RoutineFilter</span>.pipeline</span><br><span class="line">        <span class="comment">// è¿™ä¸ªè¿‡ç¨‹ä¸­ç”¨æˆ·å†³å®šè¦é€‰ç”¨å“ªä¸ªå…·ä½“çš„æ»¤é•œï¼Œå› æ­¤æ¯æ¬¡éƒ½éœ€è¦åŸºäºåŸç¨¿å¤åˆ¶ä¸€ä»½å†æ»¤é•œåŒ– </span></span><br><span class="line">        .from (.original).copyTo (.processed)</span><br><span class="line">        .doProcess (filterProcess (pickFilter (<span class="string">"awful"</span>)))</span><br><span class="line">        ... <span class="comment">// çš±çœ‰ï¼Œè¿™ä¸ªä¸å¥½ï¼Œæ¢ä¸€ä¸ªï¼</span></span><br><span class="line">        .from (.original).copyTo (.processed)</span><br><span class="line">        .doProcess (filterProcess (pickFilter (<span class="string">"notbad"</span>)))</span><br><span class="line">        ... <span class="comment">// æ‰˜è…®ï¼Œè¿™ä¸ªè¿˜è¡Œï¼Œå†æ¢ä¸ªè¯•è¯•ï½</span></span><br><span class="line">        .from (.original).copyTo (.processed)</span><br><span class="line">        .doProcess (filterProcess (pickFilter (<span class="string">"perfect"</span>)))</span><br><span class="line">        ... <span class="comment">// å®Œç¾ï½</span></span><br><span class="line">        ...</span><br><span class="line">}</span><br><span class="line"><span class="comment">// æŠŠå­åŠŸèƒ½ â€œæ»¤é•œâ€ å¤„ç†å¥½çš„å›¾åƒæäº¤ç»™ä¸»åŠŸèƒ½ </span></span><br><span class="line"><span class="type">RoutineMain</span>.accept (<span class="type">RoutineFilter</span>.commit ())</span><br><span class="line"></span><br><span class="line"><span class="comment">/** è¿›å…¥åˆ°ä¸€ä¸ªå« â€œç¾é¢œ â€ çš„åŠŸèƒ½åŒºï¼Œå¯¹åº”çš„ä¾‹ç¨‹ç§°ä¸º SkinBeauty</span></span><br><span class="line"><span class="comment"> * åŸºæœ¬åŠŸèƒ½ï¼š</span></span><br><span class="line"><span class="comment"> * 1. å±•ç¤ºå›¾åƒ </span></span><br><span class="line"><span class="comment"> * 2. é’ˆå¯¹å›¾åƒä¸­çš„äººè„¸çš®è‚¤è¿›è¡Œè‰²ç›¸è°ƒæ•´ </span></span><br><span class="line"><span class="comment"> * 3. è¾“å‡ºå¤„ç†åçš„å›¾åƒç»™ Main åŠŸèƒ½ </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">RoutineSkinBeauty</span>.startFrom (<span class="type">RoutineMain</span>.pipeline.front ().copy ());</span><br><span class="line"><span class="type">RoutineSkinBeauty</span>.process () {</span><br><span class="line">    <span class="type">RoutineSkinBeauty</span>.pipeline</span><br><span class="line">        <span class="comment">// è¿™ä¸ªè¿‡ç¨‹ç”¨æˆ·å¯ä»¥è°ƒèŠ‚ä¸€ä¸ªæ»‘ç«¿æ¥æ§åˆ¶è‰²ç›¸å‚æ•°ï¼Œæ¯æ¬¡éƒ½åŸºäºåŸç¨¿å¤åˆ¶ä¸€ä»½å†è°ƒè‰²ç›¸ </span></span><br><span class="line">        .from (.original).copyTo (.processed)</span><br><span class="line">        .doProcess (skinBeautyProcess (level_too_weak))</span><br><span class="line">        ... <span class="comment">// æ‰˜è…®ï¼Œæ•ˆæœå¥½åƒä¸æ˜æ˜¾ï¼ŒåŠ å¼ºä¸€ç‚¹ </span></span><br><span class="line">        .from (.original).copyTo (.processed)</span><br><span class="line">        .doProcess (skinBeautyProcess (level_too_much)))</span><br><span class="line">        ... <span class="comment">// çš±çœ‰ï¼Œå¥½åƒæœ‰ç‚¹è¿‡å¤´äº†ï¼Œå¾€å›è°ƒä¸€ç‚¹ </span></span><br><span class="line">        .from (.original).copyTo (.processed)</span><br><span class="line">        .doProcess (skinBeautyProcess (level_just_right)</span><br><span class="line">        ... <span class="comment">// å®Œç¾ï½</span></span><br><span class="line">        ...</span><br><span class="line">}</span><br><span class="line"><span class="comment">// æŠŠå­åŠŸèƒ½ â€œç¾é¢œâ€ å¤„ç†å¥½çš„å›¾åƒæäº¤ç»™ä¸»åŠŸèƒ½ </span></span><br><span class="line"><span class="type">RoutineMain</span>.accept (<span class="type">RoutineSkinBeauty</span>.commit ())</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº ç»“ä¸€ä¸‹ã€‚ã€‚</span></span><br><span class="line"><span class="comment">// çŠ¹è±«ï¼Œè¦ä¸è¿˜æ˜¯ä¸ç¾é¢œäº†å§ï¼Ÿ</span></span><br><span class="line"><span class="type">RoutineMain</span>.undo ();</span><br><span class="line"><span class="comment">// è¿Ÿç–‘ï¼Œæ»¤é•œä¹Ÿä¸è¦äº†ï¼Ÿ</span></span><br><span class="line"><span class="type">RoutineMain</span>.undo ();</span><br><span class="line"><span class="comment">// æ€è€ƒä¸­ã€‚ã€‚ã€‚</span></span><br><span class="line"><span class="comment">//... ä¸è¡Œï¼Œè¿˜æ˜¯éƒ½åŠ å›æ¥å§ </span></span><br><span class="line"><span class="type">RoutineMain</span>.redo ().redo ();</span><br><span class="line"><span class="comment">// ç«¯è¯¦ 5 åˆ†é’Ÿã€‚ã€‚ã€‚å®Œç¾ï½</span></span><br><span class="line">save (); <span class="comment">// æ”¶å·¥ï¼Œå‡†å¤‡å‘æœ‹å‹åœˆ </span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å…³äº â€œç®¡é“â€ çš„è®¾è®¡æ€è·¯å’Œå®ç°æ–¹æ¡ˆä»‹ç»åˆ°æ­¤ã€‚æˆ‘ä»¬å¯ä»¥å›é¡¾ä¸€ä¸‹ï¼Œæœ¬æ–‡å¼€å§‹æ‰€æåˆ° â€œé»‘ç›’å­â€ è®¾è®¡çš„ç¬¬äºŒä¸ªé—®é¢˜ï¼šâ€œå›¾åƒ <strong><em>ç®¡ç†</em></strong>  å’Œå›¾åƒ <strong><em>æ•ˆæœå¤„ç†</em></strong>  è¢«ç»‘å®šåœ¨ä¸€èµ·ã€‚â€ï¼Œåœ¨ç®¡é“æ–¹æ¡ˆä¸­æ˜¯ä¸æ˜¯å·²ç»è§£å†³äº†å‘¢ï¼Ÿ</p>
<blockquote>
<p>â€œç®¡é“â€ è®¾è®¡çš„åŸºçŸ³æ˜¯ <strong>æ— å·®åˆ«åœ°ç®¡ç†å›¾åƒ</strong> ï¼Œè¢«ç®¡ç†çš„æ¯ä¸€ä¸ªå›¾åƒï¼Œç”±æœ€åˆå°†å…¶æŠ•å…¥ç®¡é“çš„åˆ›å»ºè€…ä¸ºå…¶å®šä¹‰æ ‡ç­¾ã€‚æœ€åˆçš„åˆ›å»ºè€…å’Œåæ¥çš„ååŒè€…ï¼Œåªéœ€è¦å¯¹è¿™ä¸ªæ ‡ç­¾çš„å«ä¹‰è¾¾æˆ <strong>å…±è¯†</strong> ä¾¿å¯ä»¥è¿›è¡Œåä½œã€‚â€œç®¡é“â€ çš„æ€æƒ³æ˜¯æ¨¡æ‹Ÿ â€œ<strong>æµä½“</strong>â€ çš„è¿è¡Œæ–¹å¼æ¥å®ç°å›¾åƒå¤„ç†è¿‡ç¨‹ï¼Œé€šè¿‡ â€œ<strong>èŠ‚ç‚¹</strong>â€ çš„è®¾å®šæ¥ <strong>åˆ†è§£</strong> å¤„ç†æ­¥éª¤ï¼Œé€šè¿‡ â€œ<strong>é”‹é¢</strong>â€ çš„æ“æ§æ¥ <strong>èšç„¦</strong> æ¯ä¸ªå•æ­¥çš„æ“ä½œï¼Œé€šè¿‡ <strong>è¿é€šæ€§</strong> æ¥å°† <strong>åˆ†æ²»</strong> çš„é€»è¾‘é‡æ–° <strong>ä¸²è”</strong> èµ·æ¥å®Œæˆå¤æ‚çš„åŠŸèƒ½ã€‚</p>
</blockquote>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://theinfinitegame.tech/development/note-swiftui-mvvm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="çŒ«å…‹æ¯">
      <meta itemprop="description" content="Stay hungry, stay foolish.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Infinite Game">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/development/note-swiftui-mvvm/" class="post-title-link" itemprop="url">SwiftUI ç¬”è®° | MVVM In SwiftUI</a>
        </h1>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-03-02 10:51:18" itemprop="dateCreated datePublished" datetime="2020-03-02T10:51:18+08:00">2020-03-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/development/" itemprop="url" rel="index">
                    <span itemprop="name">development</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>6.2k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>6 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>è¯‘è‡ª <a href="https://augmentedcode.io/2020/01/05/mvvm-in-swiftui/" target="_blank" rel="noopener">MVVM in SwiftUI</a></p>
</blockquote>
<p>è®©æˆ‘ä»¬ç”¨ MVVM (model-view-view model) æ¥æ„å»ºä¸€ä¸ªåº”ç”¨ï¼Œå…¶ä¸­çš„æ¯ä¸ª SwiftUI è§†å›¾éƒ½æœ‰è‡ªå·±çš„ model ã€‚è¿™ä¼šæ˜¯ä¸€ä¸ªæ‹¥æœ‰ä¸¤ä¸ªè§†å›¾çš„ app : ä¸€ä¸ªç”µå½±åˆ—è¡¨ä»¥åŠä¸€ä¸ªç”¨äºæ·»åŠ ç”µå½±çš„è¡¨å•ã€‚æ–°å¢çš„ç”µå½±å­˜åœ¨åœ¨ <code>MovieStore</code> ï¼Œå®ƒç”±ä¸¤ä¸ª view models å…±äº«ã€‚æˆ‘ä»¬å°†é€šè¿‡ environment æ¥å…±äº« MovieStore ï¼Œä¹Ÿå°±è¯´ï¼Œå½“æˆ‘ä»¬éœ€è¦æ—¶ï¼Œä¼šä» environment ä¸­è¯»å–ã€‚</p>
<h2 id="ç”¨-Movie-å’Œ-MovieStore-æ¥è¡¨ç¤ºæ•°æ®"><a href="#ç”¨-Movie-å’Œ-MovieStore-æ¥è¡¨ç¤ºæ•°æ®" class="headerlink" title="ç”¨ Movie å’Œ MovieStore æ¥è¡¨ç¤ºæ•°æ®"></a>ç”¨ Movie å’Œ MovieStore æ¥è¡¨ç¤ºæ•°æ®</h2><p>Movie æ˜¯ä¸€ä¸ªå¾ˆå°çš„ç»“æ„ä½“ï¼Œåªå­˜å‚¨äº†æ ‡é¢˜å’Œè¯„åˆ†ã€‚æ ‡é¢˜å’Œè¯„åˆ†éƒ½æ˜¯å¯å˜çš„ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦åœ¨ AddMovieView é‡Œæ›´æ–°å®ƒä»¬ã€‚è¿™ä¸ªç»“æ„ä½“ä¹Ÿéµå¾ª <code>Identifiable</code> åè®®ï¼Œå› ä¸ºæˆ‘ä»¬å°†ç”¨ List è§†å›¾æ¥å±•ç¤ºæ‰€æœ‰çš„ç”µå½±ã€‚List éœ€è¦èƒ½å¤Ÿæ ‡è¯†å†…å®¹ä¸­çš„æ¯ä¸€é¡¹ï¼Œè€Œéµå¾ªè¿™ä¸ªåè®®æ˜¯æœ€ç®€å•çš„æ–¹å¼ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Movie</span>: <span class="title">Equatable</span>, <span class="title">Identifiable</span> </span>{</span><br><span class="line">    <span class="keyword">let</span> id = <span class="type">UUID</span>()</span><br><span class="line">    <span class="keyword">var</span> fullTitle: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> givenRating: <span class="type">Rating</span> = .notSeen</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Movie</span> </span>{</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">Rating</span>: <span class="title">Int</span>, <span class="title">CaseIterable</span> </span>{</span><br><span class="line">        <span class="keyword">case</span> notSeen, terrible, poor, decent, good, excellent</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>MovieStore ä¹Ÿå¾ˆç®€å•ï¼Œä¸è¿‡å®é™…çš„ app ä¼šåŒ…å«æ›´å¤šçš„é€»è¾‘ï¼šæŒä¹…åŒ–ï¼Œåˆ é™¤ç­‰ç­‰ã€‚æˆ‘ä»¬ç”¨ <code>Published</code> å±æ€§åŒ…è£…å™¨æ¥ä¸ºè®¢é˜…è€…è‡ªåŠ¨æä¾›å‘å¸ƒã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MovieStore</span> </span>{</span><br><span class="line">    @<span class="type">Published</span> <span class="keyword">private</span>(<span class="keyword">set</span>) <span class="keyword">var</span> allMovies = [<span class="type">Movie</span>]()</span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(<span class="number">_</span> movie: Movie)</span></span> {</span><br><span class="line">        allMovies.append (movie)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸ºäº†å°†å…±äº«çš„ <code>MovieStore</code> æ’å…¥ç¯å¢ƒï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨è‡ªå®šä¹‰çš„ EnvironmentKey ã€‚è‡ªå®šä¹‰ key ä»…ä»…åªæ˜¯ä¸€ä¸ªéµå¾ª  <code>EnvironmentKey</code> åè®®çš„è‡ªå®šä¹‰ key ã€‚æˆ‘ä»¬éœ€è¦æä¾›ç±»å‹å’Œé»˜è®¤å€¼ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MovieStoreKey</span>: <span class="title">EnvironmentKey</span> </span>{</span><br><span class="line">    <span class="keyword">typealias</span> <span class="type">Value</span> = <span class="type">MovieStore</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> defaultValue = <span class="type">MovieStore</span>()</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">EnvironmentValues</span> </span>{</span><br><span class="line">    <span class="keyword">var</span> movieStore: <span class="type">MovieStore</span> {</span><br><span class="line">        <span class="keyword">get</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>[<span class="type">MovieStoreKey</span>]</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">set</span> {</span><br><span class="line">            <span class="keyword">self</span>[<span class="type">MovieStoreKey</span>] = newValue</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>å¦‚æœæˆ‘ä»¬ä¸æ’å…¥è‡ªå·±çš„ <code>MovieStore</code> å®ä¾‹åˆ° environment ï¼Œé‚£å°±ä¼šä½¿ç”¨ defaultValue é»˜è®¤å€¼ã€‚å…¸å‹æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šåœ¨è§†å›¾ä½“ç³»ä¹‹å¤–åˆå§‹åŒ–è¿™ä¸ªç‰¹å®šå®ä¾‹ã€‚</p>
<h2 id="SceneDelegate-å’Œ-MovieScene-å‘ˆç°"><a href="#SceneDelegate-å’Œ-MovieScene-å‘ˆç°" class="headerlink" title="SceneDelegate å’Œ MovieScene å‘ˆç°"></a>SceneDelegate å’Œ MovieScene å‘ˆç°</h2><p>MovieStore ä½œä¸ºä¾èµ–é¡¹ï¼Œåœ¨æ„é€ å‡½æ•°è¢«ä¼ ç»™ view model ã€‚æˆ‘ä»¬å°†ä½¿ç”¨å­˜å‚¨åœ¨ SceneDelegate çš„å®ä¾‹ã€‚å†æ¬¡ç”³æ˜ï¼Œåœ¨å®é™…çš„ app ä¸­ï¼Œè¿™ç§ä¾èµ–é¡¹å¾ˆå¯èƒ½æ˜¯å¤„äºä¸€ä¸ªç‹¬ç«‹çš„å®¹å™¨æˆ–è€…åˆ«çš„ç±»ä¼¼çš„ä¸œè¥¿ã€‚ MovieListView æ˜¯æˆ‘ä»¬è¦å‘ˆç°çš„ç¬¬ä¸€ä¸ªè§†å›¾ï¼Œå› æ­¤æˆ‘ä»¬ä¼šåˆå§‹åŒ– view model ï¼Œ view ï¼Œå¹¶ä¸”æ’å…¥ MovieStore å®ä¾‹åˆ° environment ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨ã€‚ (movieStore keypath æ˜¯é€šè¿‡ EnvironmentValues çš„ extension æ¥å®šä¹‰çš„)ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SceneDelegate</span>: <span class="title">UIResponder</span>, <span class="title">UIWindowSceneDelegate</span> </span>{</span><br><span class="line">    <span class="keyword">var</span> window: <span class="type">UIWindow?</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> movieStore = <span class="type">MovieStore</span>()</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">scene</span><span class="params">(<span class="number">_</span> scene: UIScene, willConnectTo session: UISceneSession, options connectionOptions: UIScene.ConnectionOptions)</span></span> {</span><br><span class="line">        <span class="keyword">let</span> viewModel = <span class="type">MovieListView</span>.<span class="type">ViewModel</span>(movieStore: movieStore)</span><br><span class="line">        <span class="keyword">let</span> contentView = <span class="type">MovieListView</span>(viewModel: viewModel).environment (\.movieStore, movieStore)</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> windowScene = scene <span class="keyword">as</span>? <span class="type">UIWindowScene</span> <span class="keyword">else</span> { <span class="keyword">return</span> }</span><br><span class="line">        <span class="keyword">let</span> window = <span class="type">UIWindow</span>(windowScene: windowScene)</span><br><span class="line">        window.rootViewController = <span class="type">UIHostingController</span>(rootView: contentView)</span><br><span class="line">        <span class="keyword">self</span>.window = window</span><br><span class="line">        window.makeKeyAndVisible ()</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="MovieListView-å’Œå¯¹åº”çš„-ViewModel"><a href="#MovieListView-å’Œå¯¹åº”çš„-ViewModel" class="headerlink" title="MovieListView å’Œå¯¹åº”çš„ ViewModel"></a>MovieListView å’Œå¯¹åº”çš„ ViewModel</h2><p>åœ¨ SwiftUI ä¸­ï¼Œview model éµå¾ª <code>ObservableObject</code> åè®®ï¼Œä½¿ç”¨ @Published å±æ€§åŒ…è£…å™¨ã€‚ ObservableObject çš„é»˜è®¤å®ç°æä¾›äº† <code>objectWillChange</code> publisher ã€‚ @Published å±æ€§åŒ…è£…å™¨èƒ½åœ¨å±æ€§å°†è¦æ”¹å˜æ—¶è‡ªåŠ¨å‘å°„è¿™ä¸ª publisher ã€‚åœ¨ MovieListView ä¸­ï¼Œæˆ‘ä»¬ç”¨ @ObservedObject å±æ€§åŒ…è£…å™¨å£°æ˜ view model å±æ€§ã€‚è¿™ä¼šä½¿å¾—è¯¥è§†å›¾è®¢é˜… objectWillChange publisher ï¼Œå¹¶ä¸”åœ¨ objectWillChange å‘åŠ¨æ—¶è‡ªåŠ¨åˆ·æ–°è§†å›¾ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MovieListView</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewModel</span>: <span class="title">ObservableObject</span> </span>{</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">let</span> movieStore: <span class="type">MovieStore</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">var</span> cancellables = [<span class="type">AnyCancellable</span>]()</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">init</span>(movieStore: <span class="type">MovieStore</span>) {</span><br><span class="line">            <span class="keyword">self</span>.movieStore = movieStore</span><br><span class="line">            cancellables.append (movieStore.$allMovies.assign (to: \.movies, on: <span class="keyword">self</span>))</span><br><span class="line">        }</span><br><span class="line">         </span><br><span class="line">        @<span class="type">Published</span> <span class="keyword">private</span>(<span class="keyword">set</span>) <span class="keyword">var</span> movies = [<span class="type">Movie</span>]()</span><br><span class="line">        @<span class="type">Published</span> <span class="keyword">var</span> isPresentingAddMovie = <span class="literal">false</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MovieListView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    @<span class="type">Environment</span>(\.<span class="keyword">self</span>) <span class="keyword">var</span> environment</span><br><span class="line">    @<span class="type">ObservedObject</span> <span class="keyword">var</span> viewModel: <span class="type">ViewModel</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">var</span> body: some <span class="type">View</span> {</span><br><span class="line">        <span class="type">NavigationView</span> {</span><br><span class="line">            <span class="type">List</span>(<span class="keyword">self</span>.viewModel.movies) { movie <span class="keyword">in</span></span><br><span class="line">                <span class="type">Text</span>(movie.fullTitle)</span><br><span class="line">            }.navigationBarTitle (<span class="string">"Movies"</span>)</span><br><span class="line">                .navigationBarItems (trailing: navigationBarTrailingItem)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> navigationBarTrailingItem: some <span class="type">View</span> {</span><br><span class="line">        <span class="type">Button</span>(action: {</span><br><span class="line">            <span class="keyword">self</span>.viewModel.isPresentingAddMovie = <span class="literal">true</span></span><br><span class="line">        }, label: {</span><br><span class="line">            <span class="type">Image</span>(systemName: <span class="string">"plus"</span>).frame (minWidth: <span class="number">32</span>, minHeight: <span class="number">32</span>)</span><br><span class="line">        }).sheet (isPresented: <span class="keyword">self</span>.$viewModel.isPresentingAddMovie) {</span><br><span class="line">            <span class="keyword">self</span>.makeAddMovieView ()</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">makeAddMovieView</span><span class="params">()</span></span> -&gt; <span class="type">AddMovieView</span> {</span><br><span class="line">        <span class="keyword">let</span> movieStore = environment [<span class="type">MovieStoreKey</span>]</span><br><span class="line">        <span class="keyword">let</span> viewModel = <span class="type">AddMovieView</span>.<span class="type">ViewModel</span>(movieStore: movieStore)</span><br><span class="line">        <span class="keyword">return</span> <span class="type">AddMovieView</span>(viewModel: viewModel)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ä½ ä¼šæ³¨æ„åˆ°ï¼ŒMovieStore æ—¶ç”¨äº†ä¸¤ä»½ï¼Œä¸€ä»½åœ¨ view model ä¸­ï¼Œä¸€ä»½æ”¾åœ¨ç¯å¢ƒä¸­ã€‚</p>
<p><code>AddMovieView</code> å’Œå®ƒçš„ view model æ˜¯åœ¨ç”¨æˆ·ç‚¹å‡»å¯¼èˆªæ ä¸Šçš„åŠ å·æŒ‰é’®æ—¶è¢«åˆ›å»ºçš„ã€‚ç¯å¢ƒå±æ€§åŒ…è£…å™¨å¯ä»¥è¢«ç”¨äºè·å–æ•´ä¸ªç¯å¢ƒæˆ–è€…å€ŸåŠ©ç‰¹å®šé”®è·å–æŸä¸ªå€¼ã€‚åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­æˆ‘ä»¬è®¿é—®äº†æ•´ä¸ªç¯å¢ƒå¯¹è±¡ï¼Œç„¶ååœ¨éœ€è¦çš„æ—¶å€™å€ŸåŠ© MovieStoreKey è®¿é—® MovieStore ã€‚æˆ–è€…ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ @Environment (.movieStore) var movieStore æ¥ä»£æ›¿ã€‚</p>
<h2 id="AddMovieView-å’Œå¯¹åº”çš„-ViewModel"><a href="#AddMovieView-å’Œå¯¹åº”çš„-ViewModel" class="headerlink" title="AddMovieView å’Œå¯¹åº”çš„ ViewModel"></a>AddMovieView å’Œå¯¹åº”çš„ ViewModel</h2><p><code>AddMovieView</code> çš„ view model æ˜¯éšç€ MovieStore ä¸€åŒè¢«åˆå§‹åŒ–çš„ï¼Œå®ƒå†…éƒ¨å‘ˆç°äº†ä¸€ä¸ª Movie å®ä¾‹ã€‚ Published å±æ€§åŒ…è£…å™¨å’Œ MovieListView çš„ view model é‡Œçš„ç”¨æ³•ç›¸ä¼¼ã€‚ å†…éƒ¨çš„ movie å¯¹è±¡æ˜¯ä¸€ä¸ªç§æœ‰çš„å±æ€§ï¼Œ TextField å’Œ Picker éƒ½é‡‡ç”¨åŒå‘ Binding ã€‚ Binding æ˜¯ä¸€ç§ view å’Œ model é—´çš„åŒå‘è¿æ¥æ–¹å¼ã€‚å¦å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª <code>canSave</code> å±æ€§ï¼Œå®ƒæ˜¯ç”¨æ¥æ§åˆ¶å¯¼èˆªæ ä¸Šçš„ä¿å­˜æŒ‰é’®æ˜¯å¦å¯ç”¨ã€‚ä¿æŒæŒ‰é’®åªæœ‰åœ¨æ ‡é¢˜æœ‰å¡«å……çš„æ—¶æ‰å¯ç”¨ã€‚</p>
<p>ç®€å•å¤ä¹ ä¸€ä¸‹è§†å›¾æ›´æ–°çš„æµç¨‹ï¼šTextField æˆ–è€… Picker ä¼šåˆ©ç”¨ Binding æ¥æ›´æ–°ç§æœ‰å±æ€§ <code>newMovie</code> ã€‚ å› ä¸º newMovie å±æ€§ä½¿ç”¨äº† @Published å±æ€§åŒ…è£…å™¨ï¼Œå®ƒä¼šå‘å°„ ObservableObject çš„ objectWillChange publisher ã€‚ SwiftUI è‡ªåŠ¨è®¢é˜… objectWillChange ï¼Œå› ä¸º view model çš„å±æ€§ç”¨äº† @ObservedObject ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">AddMovieView</span> </span>{</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ViewModel</span>: <span class="title">ObservableObject</span> </span>{</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">let</span> movieStore: <span class="type">MovieStore</span></span><br><span class="line">         </span><br><span class="line">        <span class="keyword">init</span>(movieStore: <span class="type">MovieStore</span>) {</span><br><span class="line">            <span class="keyword">self</span>.movieStore = movieStore</span><br><span class="line">        }</span><br><span class="line">         </span><br><span class="line">        @<span class="type">Published</span> <span class="keyword">private</span> <span class="keyword">var</span> newMovie = <span class="type">Movie</span>(fullTitle: <span class="string">""</span>)</span><br><span class="line">         </span><br><span class="line">        <span class="built_in">lazy</span> <span class="keyword">var</span> title = <span class="type">Binding</span>&lt;<span class="type">String</span>&gt;(<span class="keyword">get</span>: {</span><br><span class="line">            <span class="keyword">self</span>.newMovie.fullTitle</span><br><span class="line">        }, <span class="keyword">set</span>: {</span><br><span class="line">            <span class="keyword">self</span>.newMovie.fullTitle = $<span class="number">0</span></span><br><span class="line">        })</span><br><span class="line">         </span><br><span class="line">        <span class="built_in">lazy</span> <span class="keyword">var</span> rating = <span class="type">Binding</span>&lt;<span class="type">Movie</span>.<span class="type">Rating</span>&gt;(<span class="keyword">get</span>: {</span><br><span class="line">            <span class="keyword">self</span>.newMovie.givenRating</span><br><span class="line">        }, <span class="keyword">set</span>: {</span><br><span class="line">            <span class="keyword">self</span>.newMovie.givenRating = $<span class="number">0</span></span><br><span class="line">        })</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">var</span> canSave: <span class="type">Bool</span> {</span><br><span class="line">            <span class="keyword">return</span> !newMovie.fullTitle.isEmpty</span><br><span class="line">        }</span><br><span class="line">         </span><br><span class="line">        <span class="function"><span class="keyword">func</span> <span class="title">save</span><span class="params">()</span></span> {</span><br><span class="line">            movieStore.add (newMovie)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AddMovieView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    @<span class="type">Environment</span>(\.presentationMode) <span class="keyword">private</span> <span class="keyword">var</span> presentationMode</span><br><span class="line">    @<span class="type">ObservedObject</span> <span class="keyword">var</span> viewModel: <span class="type">ViewModel</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">var</span> body: some <span class="type">View</span> {</span><br><span class="line">        <span class="type">NavigationView</span> {</span><br><span class="line">            <span class="type">Form</span> {</span><br><span class="line">                titleSection</span><br><span class="line">                ratingSection</span><br><span class="line">            }.navigationBarTitle (<span class="string">"Add Movie"</span>, displayMode: .inline)</span><br><span class="line">                .navigationBarItems (leading: leadingBarItem, trailing: trailingBarItem)</span><br><span class="line">                .navigationViewStyle (<span class="type">StackNavigationViewStyle</span>())</span><br><span class="line">             </span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> titleSection: some <span class="type">View</span> {</span><br><span class="line">        <span class="type">Section</span>() {</span><br><span class="line">            <span class="type">TextField</span>(<span class="string">"Title"</span>, text: viewModel.title)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> ratingSection: some <span class="type">View</span> {</span><br><span class="line">        <span class="type">Section</span>() {</span><br><span class="line">            <span class="type">Picker</span>(<span class="type">LocalizedStringKey</span>(<span class="string">"Rating"</span>), selection: viewModel.rating) {</span><br><span class="line">                <span class="type">ForEach</span>(<span class="type">Movie</span>.<span class="type">Rating</span>.allCases, id: \.rawValue) {</span><br><span class="line">                    <span class="type">Text</span>($<span class="number">0</span>.localizedName).tag ($<span class="number">0</span>)</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> leadingBarItem: some <span class="type">View</span> {</span><br><span class="line">        <span class="type">Button</span>(action: { <span class="keyword">self</span>.presentationMode.wrappedValue.dismiss () }, label: {</span><br><span class="line">            <span class="type">Text</span>(<span class="string">"Cancel"</span>)</span><br><span class="line">        })</span><br><span class="line">    }</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> trailingBarItem: some <span class="type">View</span> {</span><br><span class="line">        <span class="type">Button</span>(action: {</span><br><span class="line">            <span class="keyword">self</span>.viewModel.save ()</span><br><span class="line">            <span class="keyword">self</span>.presentationMode.wrappedValue.dismiss ()</span><br><span class="line">        }, label: {</span><br><span class="line">            <span class="type">Text</span>(<span class="string">"Save"</span>).disabled (!<span class="keyword">self</span>.viewModel.canSave)</span><br><span class="line">        })</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåªæœ‰ä¸¤ä¸ªè§†å›¾çš„ç®€å• app ã€‚ä¸¤ä¸ªè§†å›¾éƒ½æœ‰å„è‡ªçš„ view model ï¼Œå¹¶ä¸”éƒ½ä¾èµ– MovieStore ã€‚ä¸€ä¸ª view model ä¸­è§¦å‘äº† MovieStore çš„æ”¹å˜ï¼Œè¿™äº›æ”¹å˜ä¼šè¢«å¦ä¸€ä¸ª view model è§‚å¯Ÿåˆ°ã€‚å¦å¤–ï¼Œæˆ‘ä»¬è¿˜äº†è§£äº† SwiftUI çš„ environment ä»¥åŠå¦‚ä½•ä» view model ä¸­è§¦å‘ view æ›´æ–°ã€‚</p>
<hr>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://theinfinitegame.tech/uncategorized/note-swiftui-dynamic-user-notification-on-apple-watch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="çŒ«å…‹æ¯">
      <meta itemprop="description" content="Stay hungry, stay foolish.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Infinite Game">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/uncategorized/note-swiftui-dynamic-user-notification-on-apple-watch/" class="post-title-link" itemprop="url">note-swiftui-dynamic-user-notification-on-apple-watch</a>
        </h1>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-03-01 17:08:42" itemprop="dateCreated datePublished" datetime="2020-03-01T17:08:42+08:00">2020-03-01</time>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>13 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>title: SwiftUI åº”ç”¨ | æµ‡æ°´æé†’ app<br>top: false<br>date: 2020-03-01 17:08:42<br>tags:</p>
<ul>
<li>watchOS</li>
<li>development</li>
<li>swiftui<br>categories: development<br>description:</li>
</ul>
<hr>
<h1 id="ç”¨-SwiftUI-åœ¨-Apple-Watch-ä¸Šæ„å»ºåŠ¨æ€é€šçŸ¥"><a href="#ç”¨-SwiftUI-åœ¨-Apple-Watch-ä¸Šæ„å»ºåŠ¨æ€é€šçŸ¥" class="headerlink" title="ç”¨ SwiftUI åœ¨ Apple Watch ä¸Šæ„å»ºåŠ¨æ€é€šçŸ¥"></a>ç”¨ SwiftUI åœ¨ Apple Watch ä¸Šæ„å»ºåŠ¨æ€é€šçŸ¥</h1><blockquote>
<p>è¯‘è‡ª <a href="https://augmentedcode.io/2020/02/02/dynamic-user-notification-on-apple-watch-with-swiftui/" target="_blank" rel="noopener">Dynamic user notification on Apple Watch with SwiftUI</a><br>æºç åœ°å€ï¼š<a href="https://github.com/laevandus/WaterMyPlants" target="_blank" rel="noopener">WaterMyPlants</a></p>
</blockquote>
<p>é›†æˆäº†æ¨é€æˆ–è€…æœ¬åœ°é€šçŸ¥çš„ app å¯ä»¥å®šåˆ¶ apple watch ä¸Šçš„é€šçŸ¥ã€‚æœ¬æ–‡æ˜¯å…³äºå¦‚ä½•åœ¨ apple watch ä¸Šå®ç°åŠ¨æ€é€šçŸ¥çš„ç¬”è®°ã€‚æ ·ä¾‹å·¥ç¨‹å®ç°ä¸€ä¸ªæé†’ç»™æ¤ç‰©æµ‡æ°´çš„åŠŸèƒ½ã€‚æˆ‘ä»¬ä¼šèšç„¦åœ¨æ·»åŠ é€šçŸ¥è§†å›¾ï¼Œçœç•¥ä» iOS app å‘é€é€šçŸ¥çš„æ­¥éª¤ã€‚</p>
<h2 id="ä¸º-Apple-Watch-æ·»åŠ å¯Œæ–‡æœ¬é€šçŸ¥æ·»åŠ æ„å»ºç›®æ ‡"><a href="#ä¸º-Apple-Watch-æ·»åŠ å¯Œæ–‡æœ¬é€šçŸ¥æ·»åŠ æ„å»ºç›®æ ‡" class="headerlink" title="ä¸º Apple Watch æ·»åŠ å¯Œæ–‡æœ¬é€šçŸ¥æ·»åŠ æ„å»ºç›®æ ‡"></a>ä¸º Apple Watch æ·»åŠ å¯Œæ–‡æœ¬é€šçŸ¥æ·»åŠ æ„å»ºç›®æ ‡</h2><p>å¦‚æœå·¥ç¨‹é‡Œæ²¡æœ‰ App Watch app ï¼Œä½ éœ€è¦æ·»åŠ å®ƒã€‚åœ¨ Xcode ä¸­ï¼Œæˆ‘ä»¬æ–°å¢ä¸€ä¸ªæ„å»ºç›®æ ‡ï¼Œå¹¶é…ç½®æˆåŒ…å«é€šçŸ¥åœºæ™¯ã€‚æ‰“å¼€ New -&gt; Target:</p>
<p><img src="/images/watch_app_target.png" width="80%" height="80%" style="margin: 10 auto;"></p>
<p>ç¡®ä¿ User Interface é€‰æ‹©ï¼Œå¹¶ä¸” â€œInclude Notification Sceneâ€ é€‰ä¸­ã€‚æˆ‘ä»¬å°†ä¼šæŠŠå®ƒåµŒå…¥å½“å‰çš„ iOS app ï¼Œæ‰€ä»¥ â€œEmbed in Companion Appâ€ è¦é€‰æ‹©å½“å‰ app ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä» iOS 13 å’Œ WatchOS 6 å¼€å§‹ï¼ŒApple Watch app å·²ç»å¯ä»¥ç‹¬ç«‹å­˜åœ¨äº†ã€‚</p>
<p><img src="/images/watch_app_target_2.png" width="80%" height="80%" style="margin: 10 auto;"></p>
<p>ç‚¹å‡»å®Œæˆï¼ŒXcode ä¼šè¯¢é—®æ¿€æ´»æ–°çš„ scheme ï¼Œç‚¹å‡»æ¿€æ´»ï¼Œå®ƒä¼šè‡ªåŠ¨é€‰æ‹©æ–°å»ºçš„ç›®æ ‡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥å¼€å§‹å†™ä»£ç äº†ã€‚å…ˆæ£€æŸ¥å·¥ç¨‹ï¼Œä¼šå‘ç° Xcode åŠ äº†ä¸¤ä¸ªç›®æ ‡ï¼šwatch app å’Œ extensionã€‚App åŒ…å«äº† storyboard ï¼Œè€Œ extension åŒ…å«äº†æ‰€æœ‰çš„ä»£ç ã€‚ storyboard æ˜¯æä¾›åŸºäº <code>WKHostingController</code> çš„å­ç±»çš„ HostingController æ¼”ç¤ºç”¨çš„åœºæ™¯ã€‚è¿™ä¸ªç±»è´Ÿè´£æ‰¿è½½ä½ çš„ Apple Watch app çš„ SwiftUI è§†å›¾ã€‚å¦å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªåœºæ™¯ï¼Œåˆ†åˆ«æ˜¯é™æ€å’ŒåŠ¨æ€é€šçŸ¥ã€‚æˆ‘ä»¬å¯¹åŠ¨æ€é€šçŸ¥æ„Ÿå…´è¶£ï¼Œåœ¨ storyboard é‡Œå¯ä»¥çœ‹è§åŠ¨æ€è§†å›¾æ˜¯ç”± <code>NotificationController</code> æä¾›çš„ï¼Œå®ƒæ˜¯ <code>WKUserNotificationHostingController</code> çš„å­ç±»ï¼Œæ‰¿è½½é€šçŸ¥çš„ SwiftUI è§†å›¾ã€‚è¿™é‡Œå°±æ˜¯æˆ‘ä»¬ç»™é€šçŸ¥æä¾›è‡ªå®šä¹‰ç•Œé¢çš„åœ°æ–¹ã€‚å¦‚æœé€šçŸ¥çš„åˆ†ç±»å’Œ storyboard é‡Œé¢„å…ˆå®šä¹‰çš„åŒ¹é…ï¼Œå°±ä¼šé€‰æ‹©åŠ¨æ€é€šçŸ¥è§†å›¾ã€‚</p>
<h2 id="è§£æé€šçŸ¥çš„-payload-å¹¶è®¾ç½®åŠ¨æ€é€šçŸ¥è§†å›¾"><a href="#è§£æé€šçŸ¥çš„-payload-å¹¶è®¾ç½®åŠ¨æ€é€šçŸ¥è§†å›¾" class="headerlink" title="è§£æé€šçŸ¥çš„ payload å¹¶è®¾ç½®åŠ¨æ€é€šçŸ¥è§†å›¾"></a>è§£æé€šçŸ¥çš„ payload å¹¶è®¾ç½®åŠ¨æ€é€šçŸ¥è§†å›¾</h2><p>NotificationController çš„èŒè´£æ˜¯æ¶ˆè´¹ç”¨æˆ·é€šçŸ¥çš„ payload ï¼Œå¹¶ç”Ÿæˆ SwiftUI è§†å›¾æ¥å±•ç¤ºå®ƒä»¬ã€‚ç”¨æˆ·é€šçŸ¥æ˜¯ä» <code>didReceive</code> å‡½æ•°æ¥æ”¶çš„ï¼Œæˆ‘ä»¬éœ€è¦é‡Šæ”¾ä¿¡æ¯ï¼Œç”¨äºè§†å›¾ã€‚åœ¨æœ¬åœ°æµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæµ‹è¯•æ•°æ®å†™åœ¨ <code>PushNotificationPayload.apns</code> æ–‡ä»¶é‡Œã€‚å› ä¸ºæˆ‘ä»¬è¦å±•ç¤ºçš„æ˜¯å…³äºæ¤ç‰©çš„ä¿¡æ¯ï¼Œæ‰€æœ‰æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªæ¤ç‰©å¯¹è±¡åˆ°æ–‡ä»¶ä¸­ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠé€šçŸ¥åˆ†ç±»ä¿®æ”¹æˆæŸä¸ªæœ‰å«ä¹‰çš„å­—ç¬¦ä¸²ã€‚ç¡®ä¿ä½ è®¾ç½®æ–°çš„åˆ†ç±»æ—¶æ­£ç¡®æ›´æ–° storyboard ã€‚</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="attr">"aps"</span>: {</span><br><span class="line">        <span class="attr">"alert"</span>: {</span><br><span class="line">            <span class="attr">"body"</span>: <span class="string">"Test message"</span>,</span><br><span class="line">            <span class="attr">"title"</span>: <span class="string">"Optional title"</span>,</span><br><span class="line">            <span class="attr">"subtitle"</span>: <span class="string">"Optional subtitle"</span></span><br><span class="line">        },</span><br><span class="line">        <span class="attr">"category"</span>: <span class="string">"WATERING_REMINDER"</span>,</span><br><span class="line">        <span class="attr">"thread-id"</span>: <span class="string">"plantid123"</span></span><br><span class="line">    },</span><br><span class="line">     </span><br><span class="line">    <span class="attr">"plant"</span>: {</span><br><span class="line">        <span class="attr">"id"</span>: <span class="string">"plantid123"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"Aloe"</span>,</span><br><span class="line">        <span class="attr">"lastDate"</span>: <span class="number">1579937802</span>,</span><br><span class="line">        <span class="attr">"nextDate"</span>: <span class="number">1580515200</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><img src="/images/watch_app_target_3.png" width="50%" height="50%" style="margin: 10 auto;"></p>
<p>å½“æˆ‘ä»¬è®¿é—® <code>UNNotification.request.content.userInfo</code> æ‹¿åˆ°æ¤ç‰©çš„ä¿¡æ¯æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <code>Decodable</code> å’Œ <code>JSONDecoder</code> å°†ä»£è¡¨æ¤ç‰©çš„å­—å…¸è½¬æ¢æˆå€¼ç±»å‹ã€‚ <code>JSONDecoder</code> æ¥æ”¶ <code>JSON</code> æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆç”¨ <code>JSONSerialization</code> åŒ…è£…æ•°æ®ï¼Œç„¶åæŠŠåŒ…è£…çš„ç»“æœä¼ ç»™ <code>JSONDecoder</code> ã€‚ æˆ–è€…æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨ä» <code>userInfo</code> å­—å…¸é‡Œè¯»å–æ‰€æœ‰çš„å€¼ï¼Œç„¶ååˆ›å»ºå‡ºæ¤ç‰©ç±»å‹ã€‚ç•™æ„ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ view model æ¥æä¾›æ•°æ®ç»™ SwiftUI ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ <code>Plant</code> ç±»å‹ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Plant</span>: <span class="title">Decodable</span> </span>{</span><br><span class="line">    <span class="keyword">let</span> id: <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> lastDate: <span class="type">Date</span></span><br><span class="line">    <span class="keyword">let</span> nextDate: <span class="type">Date</span></span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">do</span> {</span><br><span class="line">        <span class="keyword">let</span> plantInfo = notification.request.content.userInfo [<span class="string">"plant"</span>] <span class="keyword">as</span>! [<span class="type">String</span>: <span class="type">Any</span>]</span><br><span class="line">        <span class="keyword">let</span> data = <span class="keyword">try</span> <span class="type">JSONSerialization</span>.data (withJSONObject: plantInfo, options: [])</span><br><span class="line">        <span class="keyword">let</span> decoder = <span class="type">JSONDecoder</span>()</span><br><span class="line">        decoder.dateDecodingStrategy = .secondsSince1970</span><br><span class="line">        <span class="keyword">let</span> plant = <span class="keyword">try</span> decoder.decode (<span class="type">Plant</span>.<span class="keyword">self</span>, from: data)</span><br><span class="line">        viewModel = <span class="type">NotificationViewModel</span>(plant: plant)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">catch</span> <span class="keyword">let</span> nsError <span class="keyword">as</span> <span class="type">NSError</span> {</span><br><span class="line">        <span class="built_in">print</span>(nsError.localizedDescription)</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>
<p>å¦å¤–ï¼Œæˆ‘ä»¬æƒ³è¦æ·»åŠ ä¸‰ä¸ªç”¨æˆ·å¯ä»¥æ‰§è¡Œçš„åŠ¨ä½œï¼šæ ‡è®°æ¤ç‰©å·²ç»æµ‡æ°´ï¼Œæ¨åæé†’ï¼Œæˆ–è€…å®‰æ’æ˜å¤©å†æé†’ã€‚è¿™äº›åŠ¨ä½œæ˜¯ç”¨ <code>UNNotificationAction</code> å®ä¾‹è¡¨ç¤ºã€‚å½“ç”¨æˆ·ç‚¹å‡»ä»»æ„å…¶ä¸­ä¸€ä¸ªæ—¶ï¼Œ<code>UNUserNotificationCenter</code> çš„å§”æ‰˜æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œå¹¶ä¸”å¸¦æœ‰è¯¥åŠ¨ä½œçš„ <code>identifier</code> ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> doneTitle = <span class="type">NSLocalizedString</span>(<span class="string">"NotificationAction_Done"</span>, comment: <span class="string">"Done button title in notification."</span>)</span><br><span class="line"><span class="keyword">let</span> laterTitle = <span class="type">NSLocalizedString</span>(<span class="string">"NotificationAction_Later"</span>, comment: <span class="string">"Later button title in notification."</span>)</span><br><span class="line"><span class="keyword">let</span> tomorrowTitle = <span class="type">NSLocalizedString</span>(<span class="string">"NotificationAction_Tomorrow"</span>, comment: <span class="string">"Tomorrow button title in notification."</span>)</span><br><span class="line">notificationActions = [</span><br><span class="line">    <span class="type">UNNotificationAction</span>(identifier: <span class="string">"water_done"</span>, title: doneTitle, options: []),</span><br><span class="line">    <span class="type">UNNotificationAction</span>(identifier: <span class="string">"water_later"</span>, title: laterTitle, options: []),</span><br><span class="line">    <span class="type">UNNotificationAction</span>(identifier: <span class="string">"water_tomorrow"</span>, title: tomorrowTitle, options: [])</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>
<p><code>NotificationController</code> çš„å®Œæ•´å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NotificationController</span>: <span class="title">WKUserNotificationHostingController</span>&lt;<span class="title">NotificationView</span>&gt; </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> viewModel: <span class="type">NotificationViewModel?</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> body: <span class="type">NotificationView</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="type">NotificationView</span>(viewModel: viewModel!)</span><br><span class="line">    }</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">didReceive</span><span class="params">(<span class="number">_</span> notification: UNNotification)</span></span> {</span><br><span class="line">        <span class="keyword">do</span> {</span><br><span class="line">            <span class="keyword">let</span> plantInfo = notification.request.content.userInfo [<span class="string">"plant"</span>] <span class="keyword">as</span>! [<span class="type">String</span>: <span class="type">Any</span>]</span><br><span class="line">            <span class="keyword">let</span> data = <span class="keyword">try</span> <span class="type">JSONSerialization</span>.data (withJSONObject: plantInfo, options: [])</span><br><span class="line">            <span class="keyword">let</span> decoder = <span class="type">JSONDecoder</span>()</span><br><span class="line">            decoder.dateDecodingStrategy = .secondsSince1970</span><br><span class="line">            <span class="keyword">let</span> plant = <span class="keyword">try</span> decoder.decode (<span class="type">Plant</span>.<span class="keyword">self</span>, from: data)</span><br><span class="line">            viewModel = <span class="type">NotificationViewModel</span>(plant: plant)</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> <span class="keyword">let</span> nsError <span class="keyword">as</span> <span class="type">NSError</span> {</span><br><span class="line">            <span class="built_in">print</span>(nsError.localizedDescription)</span><br><span class="line">        }</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">let</span> doneTitle = <span class="type">NSLocalizedString</span>(<span class="string">"NotificationAction_Done"</span>, comment: <span class="string">"Done button title in notification."</span>)</span><br><span class="line">        <span class="keyword">let</span> laterTitle = <span class="type">NSLocalizedString</span>(<span class="string">"NotificationAction_Later"</span>, comment: <span class="string">"Later button title in notification."</span>)</span><br><span class="line">        <span class="keyword">let</span> tomorrowTitle = <span class="type">NSLocalizedString</span>(<span class="string">"NotificationAction_Tomorrow"</span>, comment: <span class="string">"Tomorrow button title in notification."</span>)</span><br><span class="line">        notificationActions = [</span><br><span class="line">            <span class="type">UNNotificationAction</span>(identifier: <span class="string">"water_done"</span>, title: doneTitle, options: []),</span><br><span class="line">            <span class="type">UNNotificationAction</span>(identifier: <span class="string">"water_later"</span>, title: laterTitle, options: []),</span><br><span class="line">            <span class="type">UNNotificationAction</span>(identifier: <span class="string">"water_tomorrow"</span>, title: tomorrowTitle, options: [])</span><br><span class="line">        ]</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å‘ˆç°é€šçŸ¥çš„-NotificationView"><a href="#å‘ˆç°é€šçŸ¥çš„-NotificationView" class="headerlink" title="å‘ˆç°é€šçŸ¥çš„ NotificationView"></a>å‘ˆç°é€šçŸ¥çš„ NotificationView</h2><p>ä¸Šé¢æåˆ° view model <code>NotificationViewModel</code> ä¸º NotificationView æä¾›æ–‡æœ¬ï¼Œå®ƒä¸»è¦å¤„ç†æ—¥æœŸçš„æ ¼å¼åŒ–å­—ç¬¦ã€‚ </p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NotificationViewModel</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> plant: <span class="type">Plant</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">init</span>(plant: <span class="type">Plant</span>) {</span><br><span class="line">        <span class="keyword">self</span>.plant = plant</span><br><span class="line">    }</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">var</span> title: <span class="type">String</span> {</span><br><span class="line">        <span class="keyword">return</span> plant.name</span><br><span class="line">    }</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">var</span> subtitle: <span class="type">String</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="type">NSLocalizedString</span>(<span class="string">"NotificationView_Subtitle"</span>, comment: <span class="string">"Notification suggestion text"</span>)</span><br><span class="line">    }</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> dateFormatter: <span class="type">DateFormatter</span> = {</span><br><span class="line">        <span class="keyword">let</span> formatter = <span class="type">DateFormatter</span>()</span><br><span class="line">        formatter.dateFormat = <span class="type">DateFormatter</span>.dateFormat (fromTemplate: <span class="string">"dMMMM"</span>, options: <span class="number">0</span>, locale: .current)</span><br><span class="line">        <span class="keyword">return</span> formatter</span><br><span class="line">    }()</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">var</span> lastWatering: <span class="type">String</span> {</span><br><span class="line">        <span class="keyword">let</span> format = <span class="type">NSLocalizedString</span>(<span class="string">"NotificationView_LastWatering"</span>, comment: <span class="string">"Last watering date."</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="type">String</span>(format: format, dateFormatter.string (from: plant.lastDate))</span><br><span class="line">    }</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">var</span> nextWatering: <span class="type">String</span> {</span><br><span class="line">        <span class="keyword">let</span> format = <span class="type">NSLocalizedString</span>(<span class="string">"NotificationView_NextWatering"</span>, comment: <span class="string">"Next watering date."</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="type">String</span>(format: format, dateFormatter.string (from: plant.nextDate))</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>SwiftUI è§†å›¾å¾ˆç®€å•ï¼Œ4 ä¸ªæ–‡æœ¬ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NotificationView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    <span class="keyword">let</span> viewModel: <span class="type">NotificationViewModel</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">var</span> body: some <span class="type">View</span> {</span><br><span class="line">        <span class="type">VStack</span> {</span><br><span class="line">            <span class="type">Text</span>(viewModel.title).font (.title)</span><br><span class="line">            <span class="type">Text</span>(viewModel.subtitle).font (.subheadline)</span><br><span class="line">            <span class="type">Divider</span>()</span><br><span class="line">            <span class="type">Text</span>(viewModel.lastWatering).font (.body).multilineTextAlignment (.center)</span><br><span class="line">            <span class="type">Text</span>(viewModel.nextWatering).font (.body).multilineTextAlignment (.center)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><img src="/images/watch_notification_1.png" width="30%" height="30%" style="margin: 10 auto;"></p>
<p><img src="/images/watch_notification_2.png" width="30%" height="30%" style="margin: 10 auto;"></p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æˆ‘ä»¬å¾€ä¸€ä¸ª iOS app ä¸­æ·»åŠ äº† watch app ï¼Œå®ç°ä¸€ä¸ªé€šçŸ¥åˆ†ç±»çš„åŠ¨æ€é€šçŸ¥è§†å›¾ã€‚æˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•è§£æé€šçŸ¥æ•°æ®ï¼Œæ·»åŠ åŠ¨ä½œæŒ‰é’®ã€‚ä¸‹ä¸€æ­¥æ˜¯åœ¨ companion iOS app é‡ŒåŸºäºæŒ‰é’®çš„ identifier å¤„ç†å¯¹åº”é€šçŸ¥åŠ¨ä½œã€‚</p>
<hr>
<h1 id="æ‹‰å–å’Œæ˜¾ç¤ºæ•°æ®"><a href="#æ‹‰å–å’Œæ˜¾ç¤ºæ•°æ®" class="headerlink" title="æ‹‰å–å’Œæ˜¾ç¤ºæ•°æ®"></a>æ‹‰å–å’Œæ˜¾ç¤ºæ•°æ®</h1><p> è¿™ä¸€èŠ‚çš„ä¸»é¢˜æ˜¯ä» compasion iOS app çš„ CoreData å­˜å‚¨ä¸­è·å–æ•°æ®ï¼Œéœ€è¦å€ŸåŠ© WatchConnectivity framework ã€‚</p>
<h2 id="iOS-å’Œ-WatchOS-app-ä¹‹é—´çš„-session"><a href="#iOS-å’Œ-WatchOS-app-ä¹‹é—´çš„-session" class="headerlink" title="iOS å’Œ WatchOS app ä¹‹é—´çš„ session"></a>iOS å’Œ WatchOS app ä¹‹é—´çš„ session</h2><p> iOS app ç”¨ CoreData æ¥å­˜å‚¨æ¤ç‰©åˆ—è¡¨ï¼Œè®°å½•äº†æ¯æ ªæ¤ç‰©ä¸Šä¸€æ¬¡å’Œä¸‹ä¸€æ¬¡æµ‡æ°´çš„æ—¥æœŸã€‚åœ¨è¿™é‡Œï¼Œæ²¡æœ‰ web æœåŠ¡ï¼Œæ‰€æœ‰çš„ä¸œè¥¿éƒ½å­˜åœ¨è®¾å¤‡ä¸Šã€‚é‚£ä¹ˆå¦‚ä½•æŠŠæŒä¹…åŒ–å­˜å‚¨ä¸­çš„æ•°æ®æ‹¿ç»™ WatchOS app ä½¿ç”¨å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬ä¼šç”¨åˆ° WatchConnectivity framework æ¥åš iOS å’Œ WatchOS app ä¹‹é—´çš„äº¤äº’ã€‚è¿æ¥æ˜¯åœ¨ iOS å’Œ WatchOS app ä¸Šéƒ½æ¿€æ´» <code>WCSession</code> æ¥å®ç°çš„ã€‚å› æ­¤ï¼Œç¬¬ä¸€æ­¥æ˜¯æ·»åŠ ä¸€ä¸ªç®¡ç† <code>WCSession</code> çš„ç±»åˆ° iOS å·¥ç¨‹ï¼Œæˆ‘ä»¬ä¸å¦¨ç§°å®ƒä¸º WatchConnectivityProvider (ç¨åä¹Ÿä¼šæ·»åŠ ä¸€ä¸ªç›¸ä¼¼çš„ç±»åˆ° WatchOS app)ã€‚å®ƒçš„ä¸»è¦èŒèƒ½æ˜¯å»ºç«‹ <code>WCSession</code> ï¼Œå¤„ç† <code>WCSessionDelegate</code> ï¼Œå…¶ä¸­åŒ…å«ä» CoreData å­˜å‚¨æ‹‰å–æ•°æ®ã€‚å› æ­¤ï¼Œæœ‰ä¸€ä¸ªå« <code>NSPersistentContainer</code> çš„å‚æ•°ä¼šæä¾›å¯¹ <code>CoreData</code> æ ˆçš„è®¿é—® (å€Ÿç”±è®¿é—® performBackgroundTask å‡½æ•°)ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WatchConnectivityProvider</span>: <span class="title">NSObject</span>, <span class="title">WCSessionDelegate</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> persistentContainer: <span class="type">NSPersistentContainer</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> session: <span class="type">WCSession</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">init</span>(session: <span class="type">WCSession</span> = .<span class="keyword">default</span>, persistentContainer: <span class="type">NSPersistentContainer</span>) {</span><br><span class="line">        <span class="keyword">self</span>.persistentContainer = persistentContainer</span><br><span class="line">        <span class="keyword">self</span>.session = session</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>()</span><br><span class="line">        session.delegate = <span class="keyword">self</span></span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>
<p><code>WCSession</code> æ˜¯é€šè¿‡è°ƒç”¨ activate () æ¥æ¿€æ´»ï¼Œæ¿€æ´»è¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ã€‚æ¿€æ´»çš„å“åº”é€šè¿‡ <code>session (_:activationDidCompleteWith:error:)</code> å§”æ‰˜è®¿é—®è¿”å›ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">connect</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">guard</span> <span class="type">WCSession</span>.isSupported () <span class="keyword">else</span> {</span><br><span class="line">        os_log (.debug, log: .watch, <span class="string">"watch session is not supported"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    }</span><br><span class="line">    os_log (.debug, log: .watch, <span class="string">"activating watch session"</span>)</span><br><span class="line">    session.activate ()</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">session</span><span class="params">(<span class="number">_</span> session: WCSession, </span></span></span><br><span class="line"><span class="function"><span class="params">             activationDidCompleteWith activationState: WCSessionActivationState, </span></span></span><br><span class="line"><span class="function"><span class="params">             error: Error?)</span></span> {</span><br><span class="line">    os_log (.debug, </span><br><span class="line">               log: .watch, </span><br><span class="line">               <span class="string">"did finish activating session % lu (error: % s)"</span>, </span><br><span class="line">               activationState == .activated, </span><br><span class="line">               error?.localizedDescription ?? <span class="string">"none"</span>) </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>åœ¨ watchOS extension target é‚£è¾¹ï¼Œæˆ‘ä»¬ä¼šæ·»åŠ ç›¸ä¼¼çš„ä»£ç ï¼Œä¸è¿‡åå­—ä¸ä¸€æ ·ï¼Œå« â€œPhoneConnectivityProviderâ€ ã€‚å½“ä¸¤ä¸ªç±»éƒ½åˆ›å»ºå®Œæˆåï¼Œæˆ‘ä»¬éœ€è¦åˆå§‹åŒ–å¹¶è°ƒç”¨ connect ï¼Œåˆ†åˆ«åœ¨ <code>SceneDelegate</code> (iOS) å’Œ <code>ExtensionDelegate</code> (watchOS) ä¸­å®Œæˆã€‚æ³¨æ„ï¼Œåœ¨ iOS app è¿™è¾¹ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸¤ä¸ªå§”æ‰˜æ–¹é¢ï¼Œä¸è¿‡ç›®å‰æˆ‘ä»¬ç®€å•æ‰“å°å°±å¯ä»¥äº†ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sessionDidBecomeInactive</span><span class="params">(<span class="number">_</span> session: WCSession)</span></span> {</span><br><span class="line">    os_log (.debug, log: .watch, <span class="string">"session became inactive"</span>)</span><br><span class="line">}</span><br><span class="line">     </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sessionDidDeactivate</span><span class="params">(<span class="number">_</span> session: WCSession)</span></span> {</span><br><span class="line">    os_log (.debug, log: .watch, <span class="string">"session deactivated"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸ºäº†æµ‹è¯• session ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç¼–è¯‘å¹¶è¿è¡Œï¼Œç„¶ååœ¨ç¼–è¯‘è¿è¡Œ watchOS app ã€‚å¦‚æœä¸€åˆ‡å·¥ä½œæ­£å¸¸ï¼Œ Xcode è°ƒè¯•çª—å£ä¼šæ‰“å°å‡ºæ¶ˆæ¯ï¼š â€œdid finish activating session 1 (error: none)â€. è¿™è¡¨æ˜ session å·²ç»å»ºç«‹å¹¶ä¸”æ­£åœ¨è¿è¡Œï¼Œæˆ‘ä»¬å¯ä»¥ä¸¤ä¸ª app é—´å‘é€æ¶ˆæ¯äº†ã€‚</p>
<h2 id="Fetching-plants-from-iOS-app"><a href="#Fetching-plants-from-iOS-app" class="headerlink" title="Fetching plants from iOS app"></a>Fetching plants from iOS app</h2><p>å› ä¸º iOS å’Œ watchOS app ä¹‹é—´çš„é€šä¿¡ä¾èµ–å­—å…¸ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥æ˜¯å®šä¹‰ä¸€ç»„ä¸¤ä¸ª app å…±äº«ä½¿ç”¨çš„ key ã€‚è¿™æ ·å¯ä»¥å‡å°‘è¯¯æ‹¼å†™çš„é£é™©ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ·»åŠ æ–°æ–‡ä»¶ï¼Œå¹¶ä¸”åŒæ—¶åŒ…å«åˆ° iOS app target å’Œ watchOS extension target ä¸­å»ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">WatchCommunication</span> </span>{</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> requestKey = <span class="string">"request"</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> responseKey = <span class="string">"response"</span></span><br><span class="line">     </span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">Content</span>: <span class="title">String</span> </span>{</span><br><span class="line">        <span class="keyword">case</span> allPlants</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ç¬¬äºŒæ­¥æ˜¯åœ¨ <code>PhoneConnectivityProvider</code> (watchOS app extension target) ä¸­å®ç°ä¸€ä¸ª <code>refreshAllPlants (completionHandler)</code> å‡½æ•°ï¼Œç”¨æ¥å‘é€æ¶ˆæ¯ç»™ iOS app ï¼Œå¹¶ä¸”ç­‰å¾…æ¤ç‰©æ•°æ®çš„æ•°ç»„è¿”å›ã€‚ <code>WCSession</code> æœ‰ä¸€ä¸ªå«  <code>sendMessage (_:replyHandler:errorHandler:)</code> çš„å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥å‘é€ä¸€ä¸ªå­—å…¸ç»™ iOS app ï¼Œç„¶åç­‰å¾… reply handler ã€‚æˆ‘ä»¬ä¼šç”¨ WatchCommunication.requestKey å’Œ WatchCommunication.Content.allPlants æšä¸¾çš„ rawValue æ¥æ„å»ºæ¶ˆæ¯ã€‚è¿™ç§æ¨¡å¼ä¾¿äºåç»­æ‰©å±•ï¼Œä½ åªè¦æ·»åŠ æ›´åˆ° case åˆ°æšä¸¾å°±å¯ä»¥äº†ã€‚åœ¨ reply handler ä¸­ï¼Œæˆ‘ä»¬æœŸæœ›å¾—åˆ°ä¸€ä¸ªå­—å…¸çš„æ•°ç»„ï¼Œæè¿°æ‰€æœ‰çš„æ¤ç‰©ã€‚è®©æˆ‘ä»¬å…ˆçœ‹ä¸€çœ¼å®Œæ•´çš„å®ç°ï¼Œç„¶åå†è®¨è®ºå­—å…¸æ˜¯å¦‚ä½•è¢«è½¬æ¢æˆ <code>Plant</code> å€¼ç±»å‹çš„ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">refreshAllPlants</span><span class="params">(withCompletionHandler completionHandler: @escaping <span class="params">([Plant]?)</span></span></span> -&gt; <span class="type">Void</span>) {</span><br><span class="line">    <span class="keyword">guard</span> session.activationState == .activated <span class="keyword">else</span> {</span><br><span class="line">        os_log (.debug, log: .phone, <span class="string">"session is not active"</span>)</span><br><span class="line">        completionHandler (<span class="literal">nil</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">let</span> message = [<span class="type">WatchCommunication</span>.requestKey: <span class="type">WatchCommunication</span>.<span class="type">Content</span>.allPlants.rawValue]</span><br><span class="line">    session.sendMessage (message, replyHandler: { (payload) <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">let</span> plantDictionaries = payload [<span class="type">WatchCommunication</span>.requestKey] <span class="keyword">as</span>? [[<span class="type">String</span>: <span class="type">Any</span>]]</span><br><span class="line">        os_log (.debug, log: .phone, <span class="string">"received % lu plants"</span>, plantDictionaries?.<span class="built_in">count</span> ?? <span class="number">0</span>)</span><br><span class="line">             </span><br><span class="line">        <span class="keyword">let</span> decoder = <span class="type">JSONDecoder</span>()</span><br><span class="line">        decoder.dateDecodingStrategy = .secondsSince1970</span><br><span class="line">        <span class="keyword">let</span> plants = plantDictionaries?.compactMap ({ <span class="type">Plant</span>(dictionary: $<span class="number">0</span>, decoder: decoder) })</span><br><span class="line">        <span class="type">DispatchQueue</span>.main.async {</span><br><span class="line">            completionHandler (plants)</span><br><span class="line">        }</span><br><span class="line">    }, errorHandler: { error <span class="keyword">in</span></span><br><span class="line">        os_log (.debug, log: .phone, <span class="string">"sending message failed: % s"</span>, error.localizedDescription)</span><br><span class="line">    })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>iOS app ä¸Šå¤„ç† CoreData å’Œ Plant ç±»å‹çš„æ˜¯ä¸€ä¸ª NSManagedObject å­ç±»çš„å¯¹è±¡ã€‚watchOS app extension å®šä¹‰äº†å®ƒè‡ªå·±çš„ <code>Plant</code> å€¼ç±»å‹ï¼Œå› ä¸ºå®ƒå¹¶æ²¡æœ‰ CoreData æ ˆã€‚ä¸ºäº†å°†å­—å…¸è½¬æ¢æˆå€¼ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ â€œStoring struct in UserDefaultâ€ ä¸­æè¿°çš„æ–¹æ³•ï¼Œåªéœ€è¦é¢å¤–é…ç½® <code>JSONDecoder</code> ä½¿ç”¨çš„ <code>dateDecodingStrategy</code>  ä¸º <code>secondsSince1970</code> ã€‚ç†ç”±æ˜¯æˆ‘ä»¬å¸Œæœ›ä»¥è‡ª 1970 å¹´ä¹‹åçš„ç§’æ•°æ¥å­˜å‚¨æ—¥æœŸã€‚è½¬æ¢å­—å…¸åˆ°å€¼ç±»å‹çš„è¿‡ç¨‹ç”¨åˆ°äº† <code>JSONSerialization</code> ï¼Œå®ƒåªæ”¯æŒ <code>NSString</code> ï¼Œ <code>NSNumber</code> ï¼Œ <code>NSArray</code> ï¼Œ <code>NSDictionary</code> ï¼Œ æˆ–è€… <code>NSNull</code> ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Plant value type in WatchOS app extension</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Plant</span>: <span class="title">Identifiable</span>, <span class="title">Decodable</span>, <span class="title">DictionaryDecodable</span> </span>{</span><br><span class="line">    <span class="keyword">let</span> id: <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> lastWateringDate: <span class="type">Date</span></span><br><span class="line">    <span class="keyword">let</span> nextWateringDate: <span class="type">Date</span></span><br><span class="line">}</span><br><span class="line"><span class="comment">// Plant class in iOS app</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Plant</span>: <span class="title">NSManagedObject</span>, <span class="title">Identifiable</span> </span>{</span><br><span class="line">    <span class="meta">@NSManaged</span> <span class="keyword">var</span> id: <span class="type">String</span></span><br><span class="line">    <span class="meta">@NSManaged</span> <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line">     </span><br><span class="line">    <span class="meta">@NSManaged</span> <span class="keyword">var</span> lastWateringDate: <span class="type">Date</span></span><br><span class="line">    <span class="meta">@NSManaged</span> <span class="keyword">var</span> nextWateringDate: <span class="type">Date</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ç¬¬ä¸‰æ­¥æ˜¯åœ¨ iOS app ç«¯å¤„ç†æ¶ˆæ¯ï¼Œå¹¶ä¸”æä¾›æ•°æ®ç»™ watchOS app ã€‚æˆ‘ä»¬éœ€è¦åšçš„æ˜¯å®ç° session çš„å§”æ‰˜ï¼Œä» CoreData æ ˆä¸­è·å–å­—å…¸æ•°æ®ã€‚ å…ˆçœ‹ä¸‹å®Œæ•´å®ç°ï¼Œç„¶åé€ä¸€æ‹†è§£ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">session</span><span class="params">(<span class="number">_</span> session: WCSession, didReceiveMessage message: [String: <span class="keyword">Any</span>], replyHandler: @escaping <span class="params">([String: <span class="keyword">Any</span>])</span></span></span> -&gt; <span class="type">Void</span>) {</span><br><span class="line">    os_log (.debug, log: .watch, <span class="string">"did receive message: % s"</span>, message [<span class="type">WatchCommunication</span>.requestKey] <span class="keyword">as</span>? <span class="type">String</span> ?? <span class="string">"unknown"</span>)</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> contentString = message [<span class="type">WatchCommunication</span>.requestKey] <span class="keyword">as</span>? <span class="type">String</span> , <span class="keyword">let</span> content = <span class="type">WatchCommunication</span>.<span class="type">Content</span>(rawValue: contentString) <span class="keyword">else</span> {</span><br><span class="line">        replyHandler ([:])</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">switch</span> content {</span><br><span class="line">    <span class="keyword">case</span> .allPlants:</span><br><span class="line">        persistentContainer.performBackgroundTask { (managedObjectContext) <span class="keyword">in</span>            </span><br><span class="line">            <span class="keyword">let</span> all = <span class="type">Plant</span>.allPlantsDictionaryRepresentation () <span class="keyword">as</span>! [[<span class="type">String</span>: <span class="type">Any</span>]]</span><br><span class="line">            <span class="comment">// Replace Date with Double</span></span><br><span class="line">            <span class="keyword">let</span> converted = all.<span class="built_in">map</span> { (plantDictionary) -&gt; [<span class="type">String</span>: <span class="type">Any</span>] <span class="keyword">in</span></span><br><span class="line">                plantDictionary.mapValues { (value) -&gt; <span class="type">Any</span> <span class="keyword">in</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">let</span> date = value <span class="keyword">as</span>? <span class="type">Date</span> {</span><br><span class="line">                        <span class="keyword">return</span> date.timeIntervalSince1970</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">else</span> {</span><br><span class="line">                        <span class="keyword">return</span> value</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }                </span><br><span class="line">            <span class="keyword">let</span> response = [<span class="type">WatchCommunication</span>.responseKey: converted]</span><br><span class="line">            replyHandler (response)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ç¬¬ä¸€æ­¥æ˜¯æŸ¥çœ‹æ¥æ”¶åˆ°çš„å­—å…¸ï¼Œçœ‹çœ‹ watchOS app è¯·æ±‚çš„æ˜¯å“ªäº›å†…å®¹ã€‚ç„¶åæˆ‘ä»¬è®¿é—®æŒä¹…åŒ–å­˜å‚¨ï¼Œè·å–è¡¨ç¤º Plant çš„å­—å…¸ï¼ŒæŠŠå…¶ä»–çš„æ—¥æœŸè½¬æ¢æˆ 1970 å¹´åç§’æ•°çš„å½¢å¼ (ä»¥ä¾¿ watchOS app èƒ½å¤Ÿåœ¨å­—å…¸ä¸Šä½¿ç”¨ <code>JSONSerialization</code>)ï¼Œç„¶åæŠŠæ•°æ®å‘é€å› watchOS app ã€‚æ³¨æ„ï¼Œä» CoreData ä¸­è·å–å­—å…¸å½¢å¼çš„ Plant å¾ˆå®¹æ˜“ï¼šæˆ‘ä»¬é¦–å…ˆæ˜¯è¯·æ±‚ <code>NSDictionary</code> ç±»å‹çš„æ•°æ®ï¼Œå¹¶ä¸”å°†ç»“æœç±»å‹å±æ€§è®¾ç½®ä¸º <code>.dictionaryResultType</code> ã€‚å¯¹äºå„åºå¤§çš„æ¨¡å‹ï¼Œæˆ‘ä»¬å¯èƒ½è¿˜ä¼šç”¨åˆ°å±æ€§é›†åˆ (propertiesToFetch) ã€‚ä¸è¿‡ç›®å‰ï¼Œæ‰€æœ‰çš„å±æ€§éƒ½è¢«æ·»åŠ åˆ°å­—å…¸ä¸­äº†ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Plant</span> </span>{</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> entityName = <span class="string">"Plant"</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">makeDictionaryRequest</span><span class="params">()</span></span> -&gt; <span class="type">NSFetchRequest</span>&lt;<span class="type">NSDictionary</span>&gt; {</span><br><span class="line">        <span class="keyword">return</span> <span class="type">NSFetchRequest</span>&lt;<span class="type">NSDictionary</span>&gt;(entityName: entityName)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">allPlantsDictionaryRepresentation</span><span class="params">()</span></span> -&gt; [<span class="type">NSDictionary</span>] {</span><br><span class="line">        <span class="keyword">let</span> request = makeDictionaryRequest ()</span><br><span class="line">        request.resultType = .dictionaryResultType</span><br><span class="line">        <span class="keyword">do</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">try</span> request.execute ()</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> <span class="keyword">let</span> nsError <span class="keyword">as</span> <span class="type">NSError</span> {</span><br><span class="line">            os_log (.debug, log: .plants, <span class="string">"failed fetching all plants with error % s % s"</span>, nsError, nsError.userInfo)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="ç”¨-SwiftUI-åœ¨-watchOS-app-ä¸­æ„å»º-UI"><a href="#ç”¨-SwiftUI-åœ¨-watchOS-app-ä¸­æ„å»º-UI" class="headerlink" title="ç”¨ SwiftUI åœ¨ watchOS app ä¸­æ„å»º UI"></a>ç”¨ SwiftUI åœ¨ watchOS app ä¸­æ„å»º UI</h2><p>Xcode ä¸­ watchOS app çš„æ¨¡æ¿æ˜¯å€ŸåŠ© storyboard åˆå§‹åŒ– <code>HostingController</code>ï¼Œ è¿™ä¸ªæ§åˆ¶å™¨è´Ÿè´£æä¾›åˆå§‹çš„ SwiftUI è§†å›¾ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HostingController</span>: <span class="title">WKHostingController</span>&lt;<span class="title">PlantListView</span>&gt; </span>{</span><br><span class="line">    <span class="built_in">lazy</span> <span class="keyword">private</span>(<span class="keyword">set</span>) <span class="keyword">var</span> connectivityProvider: <span class="type">PhoneConnectivityProvider</span> = {</span><br><span class="line">        <span class="keyword">let</span> provider = <span class="type">PhoneConnectivityProvider</span>()</span><br><span class="line">        provider.connect ()</span><br><span class="line">        <span class="keyword">return</span> provider</span><br><span class="line">    }()</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> listViewModel = <span class="type">PlantListViewModel</span>(connectivityProvider: connectivityProvider)</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> body: <span class="type">PlantListView</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="type">PlantListView</span>(viewModel: listViewModel)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>PlantListView</code> æ˜¯ä¸€ä¸ªæ˜¾ç¤ºæ¤ç‰©åˆ—è¡¨çš„ç®€å•è§†å›¾ï¼Œå®ƒç”¨ <code>PhoneConnectivityProvider</code> çš„ <code>refreshAllPlants (withCompletionHandler:)</code> æ¥å¤„ç†åˆ·æ–°æ¤ç‰©çš„é€»è¾‘ã€‚ SwiftUI è§†å›¾ä¼šåœ¨ view model æ”¹å˜æ—¶è‡ªåŠ¨æ›´æ–°ã€‚è¿™æ˜¯å› ä¸º view model çš„ <code>plants</code> å±æ€§ä½¿ç”¨äº† <code>@Published</code> å±æ€§åŒ…è£…å™¨ï¼Œè€Œ view model æœ¬èº«æ˜¯ <code>ObservableObject</code> ï¼Œè¿™æ˜¯ SwiftUI è§†å›¾ä¸­ä¸º view model é‡‡ç”¨çš„å±æ€§åŒ…è£…å™¨ (æ›´å¤šä¿¡æ¯å¯ä»¥é˜…è¯» refreshing SwiftUI view in MVVM in SwiftUI) ã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„ view model æ˜¯ SwiftUI è§†å›¾æ˜¾ç°æ—¶åˆ·æ–°å†…å®¹çš„ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PlantListViewModel</span>: <span class="title">ObservableObject</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> connectivityProvider: <span class="type">PhoneConnectivityProvider</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">init</span>(plants: [<span class="type">Plant</span>] = [], connectivityProvider: <span class="type">PhoneConnectivityProvider</span>) {</span><br><span class="line">        <span class="keyword">self</span>.plants = plants</span><br><span class="line">        <span class="keyword">self</span>.connectivityProvider = connectivityProvider</span><br><span class="line">        refresh ()</span><br><span class="line">    }</span><br><span class="line">    @<span class="type">Published</span> <span class="keyword">private</span>(<span class="keyword">set</span>) <span class="keyword">var</span> plants: [<span class="type">Plant</span>]</span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">refresh</span><span class="params">()</span></span> {</span><br><span class="line">        connectivityProvider.refreshAllPlants { [<span class="keyword">weak</span> <span class="keyword">self</span>] (plants) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> plants = plants <span class="keyword">else</span> { <span class="keyword">return</span> }</span><br><span class="line">            <span class="keyword">self</span>?.plants = plants</span><br><span class="line">        }</span><br><span class="line">    }    </span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PlantListView</span>: <span class="title">View</span> </span>{</span><br><span class="line">    @<span class="type">ObservedObject</span> <span class="keyword">var</span> viewModel: <span class="type">PlantListViewModel</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">var</span> body: some <span class="type">View</span> {</span><br><span class="line">        <span class="type">VStack</span> {</span><br><span class="line">            <span class="type">List</span>(<span class="keyword">self</span>.viewModel.plants) { plant <span class="keyword">in</span></span><br><span class="line">                <span class="type">PlantCell</span>(viewModel: <span class="type">PlantCellViewModel</span>(plant: plant))</span><br><span class="line">            }</span><br><span class="line">        }.onAppear {</span><br><span class="line">            <span class="keyword">self</span>.viewModel.refresh ()</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>PlantListView</code> ç”¨ <code>PlantCell</code> æ¥æ˜¾ç¤ºç‹¬ç«‹çš„è§†å›¾ã€‚</p>
<figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PlantCell</span>: <span class="title">View</span> </span>{</span><br><span class="line">    <span class="keyword">let</span> viewModel: <span class="type">PlantCellViewModel</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">var</span> body: some <span class="type">View</span> {</span><br><span class="line">        <span class="type">VStack</span>(spacing: <span class="number">4</span>) {</span><br><span class="line">            <span class="type">Text</span>(viewModel.title).font (.headline).multilineTextAlignment (.center)</span><br><span class="line">            <span class="type">Text</span>(viewModel.subtitle).font (.footnote).multilineTextAlignment (.center)</span><br><span class="line">        }.padding (<span class="number">8</span>)</span><br><span class="line">            .frame (minWidth: <span class="number">0</span>, maxWidth: .greatestFiniteMagnitude)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PlantCellViewModel</span> </span>{</span><br><span class="line">    <span class="keyword">let</span> plant: <span class="type">Plant</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">var</span> title: <span class="type">String</span> {</span><br><span class="line">        <span class="keyword">return</span> plant.name</span><br><span class="line">    }</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">let</span> dateFormatter: <span class="type">DateFormatter</span> = {</span><br><span class="line">        <span class="keyword">let</span> formatter = <span class="type">DateFormatter</span>()</span><br><span class="line">        formatter.dateFormat = <span class="type">DateFormatter</span>.dateFormat (fromTemplate: <span class="string">"dMMMM"</span>, options: <span class="number">0</span>, locale: .current)</span><br><span class="line">        <span class="keyword">return</span> formatter</span><br><span class="line">    }()</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">var</span> subtitle: <span class="type">String</span> {</span><br><span class="line">        <span class="keyword">let</span> format = <span class="type">NSLocalizedString</span>(<span class="string">"PlantCellView_NextWatering"</span>, comment: <span class="string">"Next watering date."</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="type">String</span>(format: format, <span class="type">Self</span>.dateFormatter.string (from: plant.nextWateringDate))</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æˆ‘ä»¬åœ¨ iOS å’Œ watchOS app ä¸Šéƒ½æ·»åŠ  <code>WCSessions</code> ï¼Œå®ç°ç›¸å…³çš„å§”æ‰˜æ–¹æ³•ä»¥å¤„ç† session å’Œæ¥æ”¶åˆ°çš„æ¶ˆæ¯ã€‚ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç®€å•çš„é€šä¿¡æ¨¡å¼ï¼Œå¹¶åœ¨ watchOS app ç«¯å®ç°åˆ·æ–°æ¤ç‰©çš„æ–¹æ³•ï¼Œåœ¨ iOS ç«¯å®ç° CoreData é›†æˆã€‚å½“æ•°æ®è®¿é—®åˆ›å»ºå®Œæˆåï¼Œæˆ‘ä»¬åœ¨ watchOS app ä¸Šç”¨ SwiftUI è§†å›¾æ˜¾ç¤ºæ¤ç‰©çš„åˆ—è¡¨ã€‚</p>
<hr>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="çŒ«å…‹æ¯"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">çŒ«å…‹æ¯</p>
  <div class="site-description" itemprop="description">Stay hungry, stay foolish.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">50</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/nichollyn" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;nichollyn" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS â†’ &#x2F;atom.xml"><i class="fa fa-fw fa-rss"></i>RSS</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/kai-wen-mao-66" title="çŸ¥ä¹ â†’ https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;kai-wen-mao-66" rel="noopener" target="_blank"><i class="fa fa-fw fa-quora"></i>çŸ¥ä¹</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        
  <div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">é—½ICPå¤‡ - 20000913 </a>
      <img src="/images/gongan.png" style="display: inline-block;"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=35021302000298" rel="noopener" target="_blank">é—½å…¬ç½‘å®‰å¤‡35021302000298å· </a>
  </div>

<div class="copyright">
  
  &copy; 2019 â€“ 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">çŒ«å…‹æ¯</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">223k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">3:23</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/three-waves.min.js"></script>


  



  <script>
  if (CONFIG.page.isPost) {
    wpac_init = window.wpac_init || [];
    wpac_init.push({
      widget: 'Rating',
      id: ,
      el: 'wpac-rating',
      color: 'f79533'
    });
    (function() {
      if ('WIDGETPACK_LOADED' in window) return;
      WIDGETPACK_LOADED = true;
      var mc = document.createElement('script');
      mc.type = 'text/javascript';
      mc.async = true;
      mc.src = '//embed.widgetpack.com/widget.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(mc, s.nextSibling);
    })();
  }
  </script>

  
<script src="/js/local-search.js"></script>













  

  
      
<script type="text/x-mathjax-config">

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });

  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') {
          next = next.nextSibling;
        }
        if (next && next.nodeName.toLowerCase() === 'br') {
          next.parentNode.removeChild(next);
        }
      }
    });
  });

  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      element = document.getElementById(all[i].inputID + '-Frame').parentNode;
      if (element.nodeName.toLowerCase() == 'li') {
        element = element.parentNode;
      }
      element.classList.add('has-jax');
    }
  });
</script>
<script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML', () => {
    MathJax.Hub.Typeset();
  }, window.MathJax);
</script>

    

  

</body>
</html>
